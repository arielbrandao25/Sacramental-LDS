<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sacramental LDS</title>
    
    <!-- √çcones e PWA -->
    <meta name="theme-color" content="#1e3a8a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEwMCIgZmlsbD0iIzFlM2E4YSIvPjxwYXRoIGQ9Ik0yNTYgMTEyTDY0IDI1NnYxOTJoMTQ0VjMzNmg5NnYxMTJoMTQ0VjI1NkwyNTYgMTEyeiIgZmlsbD0id2hpdGUiLz48cmVjdCB4PSIyMzIiIHk9IjY0IiB3aWR0aD0iNDgiIGhlaWdodD0iNjQiIGZpbGw9IndoaXRlIi8+PGNpcmNsZSBjeD0iMjU2IiBjeT0iMjAwIiByPSIyNCIgZmlsbD0iIzkzYzVmZCIvPjwvc3ZnPg==">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- jsPDF para gera√ß√£o de PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Tratamento de Erro Global (Para evitar tela branca silenciosa) -->
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        #error-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 9999; padding: 20px; color: #b91c1c; font-family: monospace; overflow: auto; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 1000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { border: 4px solid rgba(255,255,255,0.3); width: 40px; height: 40px; border-radius: 50%; border-top-color: #ffffff; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Anima√ß√µes suaves */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-up { animation: slideUp 0.4s ease-out; }
        
        /* Efeito glassmorphism */
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        
        /* Transi√ß√µes suaves */
        * { transition: all 0.2s ease; }
    </style>
    <script>
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('loading-overlay').style.display = 'none';
            var overlay = document.getElementById('error-overlay');
            overlay.style.display = 'block';
            overlay.innerHTML = '<h3 style="font-size:18px; font-weight:bold; margin-bottom:10px">Erro ao carregar o aplicativo:</h3><p style="margin-bottom:10px">' + msg + '</p><p>Linha: ' + line + '</p><pre style="background:#fef2f2; padding:10px; border-radius:8px; overflow:auto; margin-top:10px">' + (error ? error.stack : '') + '</pre>';
            return false;
        };
    </script>

    <!-- Google Identity Services - Carregar antes do app -->
    <script src="https://accounts.google.com/gsi/client" onload="window.gsiLoaded = true"></script>

    <!-- Import Map para M√≥dulos -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
        "lucide-react": "https://esm.sh/lucide-react@0.294.0?bundle"
      }
    }
    </script>

    <!-- Babel para JSX - Carregar de forma ass√≠ncrona para evitar processamento autom√°tico -->
    <script>
        // Carregar Babel de forma ass√≠ncrona e desabilitar processamento autom√°tico ANTES de carregar
        (function() {
            // Criar script element para carregar Babel
            const babelScript = document.createElement('script');
            babelScript.src = 'https://unpkg.com/@babel/standalone@7.8.0/babel.min.js';
            
            // Interceptar quando Babel for carregado
            babelScript.onload = function() {
                // Desabilitar transformScriptTags IMEDIATAMENTE
                if (window.Babel && window.Babel.transformScriptTags) {
                    window.Babel.transformScriptTags = function() {
                        console.log('‚ö†Ô∏è Processamento autom√°tico do Babel bloqueado');
                        return; // N√£o fazer nada
                    };
                    console.log('‚úÖ Babel carregado e transformScriptTags desabilitado');
                }
                
                // Processar script principal manualmente
                processMainScript();
            };
            
            // Adicionar script ao head
            document.head.appendChild(babelScript);
            
            // Fun√ß√£o para processar script principal
            function processMainScript() {
                const script = document.getElementById('main-app-script');
                if (!script) {
                    setTimeout(processMainScript, 50);
                    return;
                }
                
                if (!window.Babel || !window.Babel.transform) {
                    setTimeout(processMainScript, 50);
                    return;
                }
                
                try {
                    const code = script.textContent || script.innerHTML;
                    
                    // Transformar APENAS JSX com preset react
                    const transformed = window.Babel.transform(code, {
                        presets: ['react'],
                        sourceType: 'module'
                    });
                    
                    // Criar novo script com c√≥digo transformado
                    const newScript = document.createElement('script');
                    newScript.type = 'module';
                    newScript.textContent = transformed.code;
                    
                    // Adicionar ao body e remover script original
                    document.body.appendChild(newScript);
                    script.remove();
                    
                    console.log('‚úÖ Script processado manualmente pelo Babel');
                } catch (e) {
                    console.error('‚ùå Erro ao processar script:', e);
                    const errorOverlay = document.getElementById('error-overlay');
                    if (errorOverlay) {
                        errorOverlay.style.display = 'block';
                        errorOverlay.innerHTML = `
                            <div style="padding: 40px; text-align: center; font-family: sans-serif; max-width: 800px; margin: 50px auto;">
                                <h2 style="color: #b91c1c; margin-bottom: 20px; font-size: 24px;">Erro ao processar aplicativo</h2>
                                <p style="color: #7f1d1d; margin-bottom: 15px; font-size: 16px;">${e.message || 'Erro desconhecido'}</p>
                                <pre style="background: #fef2f2; padding: 15px; border-radius: 8px; overflow: auto; text-align: left; font-size: 12px; color: #991b1b; margin: 20px 0;">${e.stack || ''}</pre>
                                <button onclick="window.location.reload()" style="margin-top: 20px; padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                                    Recarregar P√°gina
                                </button>
                            </div>
                        `;
                    }
                }
            }
        })();
    </script>
    <script>
        // Processar script manualmente ap√≥s Babel carregar
        (function() {
            function processMainScript() {
                const script = document.getElementById('main-app-script');
                if (!script) {
                    setTimeout(processMainScript, 50);
                    return;
                }
                
                if (!window.Babel || !window.Babel.transform) {
                    setTimeout(processMainScript, 50);
                    return;
                }
                
                try {
                    const code = script.textContent || script.innerHTML;
                    
                    // Transformar APENAS JSX com preset react
                    // N√£o usar preset 'env' que causa erro com esmodules
                    // O c√≥digo ES6 moderno (imports, arrow functions, etc.) funciona nativamente com type="module"
                    const transformed = window.Babel.transform(code, {
                        presets: ['react'],
                        sourceType: 'module'
                    });
                    
                    // Criar novo script com c√≥digo transformado
                    const newScript = document.createElement('script');
                    newScript.type = 'module';
                    newScript.textContent = transformed.code;
                    
                    // Adicionar ao body e remover script original
                    document.body.appendChild(newScript);
                    script.remove();
                    
                    console.log('‚úÖ Script processado manualmente pelo Babel');
                } catch (e) {
                    console.error('‚ùå Erro ao processar script:', e);
                    const errorOverlay = document.getElementById('error-overlay');
                    if (errorOverlay) {
                        errorOverlay.style.display = 'block';
                        errorOverlay.innerHTML = `
                            <div style="padding: 40px; text-align: center; font-family: sans-serif; max-width: 800px; margin: 50px auto;">
                                <h2 style="color: #b91c1c; margin-bottom: 20px; font-size: 24px;">Erro ao processar aplicativo</h2>
                                <p style="color: #7f1d1d; margin-bottom: 15px; font-size: 16px;">${e.message || 'Erro desconhecido'}</p>
                                <pre style="background: #fef2f2; padding: 15px; border-radius: 8px; overflow: auto; text-align: left; font-size: 12px; color: #991b1b; margin: 20px 0;">${e.stack || ''}</pre>
                                <button onclick="window.location.reload()" style="margin-top: 20px; padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                                    Recarregar P√°gina
                                </button>
                            </div>
                        `;
                    }
                }
            }
            
            // Aguardar Babel carregar completamente
            function waitForBabel() {
                if (window.Babel && window.Babel.transform) {
                    // Garantir que transformScriptTags est√° desabilitado
                    if (window.Babel.transformScriptTags) {
                        window.Babel.transformScriptTags = function() {};
                    }
                    processMainScript();
                } else {
                    setTimeout(waitForBabel, 50);
                }
            }
            
            // Iniciar processamento
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', waitForBabel);
            } else {
                waitForBabel();
            }
        })();
    </script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 font-sans text-slate-800">
    
    <!-- Tela de Carregamento Inicial -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p class="mt-6 text-white font-semibold text-base">Iniciando Sacramental...</p>
    </div>

    <!-- Tela de Erro -->
    <div id="error-overlay"></div>

    <div id="root"></div>

    <script type="text/plain" id="main-app-script">
        console.log('üöÄ Script iniciado...');
        
        // Fun√ß√£o para mostrar erro na tela
        function mostrarErro(mensagem, stack) {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
            const rootElement = document.getElementById('root');
            if (rootElement) {
                rootElement.innerHTML = `
                    <div style="padding: 40px; text-align: center; font-family: sans-serif; max-width: 800px; margin: 50px auto;">
                        <h2 style="color: #b91c1c; margin-bottom: 20px; font-size: 24px;">Erro ao carregar o aplicativo</h2>
                        <p style="color: #7f1d1d; margin-bottom: 15px; font-size: 16px;">${mensagem || 'Erro desconhecido'}</p>
                        ${stack ? `<pre style="background: #fef2f2; padding: 15px; border-radius: 8px; overflow: auto; text-align: left; font-size: 12px; color: #991b1b; margin: 20px 0;">${stack}</pre>` : ''}
                        <button onclick="window.location.reload()" style="margin-top: 20px; padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                            Recarregar P√°gina
                        </button>
                    </div>
                `;
            }
        }
        
        // Tratamento de erros global
        window.addEventListener('error', (e) => {
            // Ignorar erros de offline do Firestore, banco n√£o existente, √≠ndices faltantes, Cross-Origin-Opener-Policy e tokens OAuth expirados
            const isOfflineError = e.error?.code === 'unavailable' || 
                                  e.error?.code === 'failed-precondition' ||
                                  e.error?.code === 'not-found' ||
                                  e.error?.message?.includes('offline') ||
                                  e.error?.message?.includes('client is offline') ||
                                  e.error?.message?.includes('database') && e.error?.message?.includes('does not exist') ||
                                  e.error?.message?.includes('index') && e.error?.message?.includes('requires') ||
                                  e.error?.message?.includes('Cross-Origin-Opener-Policy') ||
                                  e.message?.includes('offline') ||
                                  e.message?.includes('client is offline') ||
                                  e.message?.includes('database') && e.message?.includes('does not exist') ||
                                  e.message?.includes('index') && e.message?.includes('requires') ||
                                  e.message?.includes('Cross-Origin-Opener-Policy') ||
                                  e.filename?.includes('tokeninfo') || // Ignorar erros do tokeninfo do Google OAuth
                                  e.message?.includes('tokeninfo'); // Ignorar erros do tokeninfo do Google OAuth
            
            if (isOfflineError) {
                // N√£o logar Cross-Origin-Opener-Policy ou tokeninfo como warning (s√£o avisos esperados)
                const isTokenInfoError = e.filename?.includes('tokeninfo') || e.message?.includes('tokeninfo');
                const isCoopError = e.error?.message?.includes('Cross-Origin-Opener-Policy') || e.message?.includes('Cross-Origin-Opener-Policy');
                
                if (!isCoopError && !isTokenInfoError) {
                    console.warn('‚ö†Ô∏è Erro de conectividade/Firestore - ignorando:', e.error?.message || e.message);
                }
                return; // N√£o mostrar erro na tela para problemas de conectividade, banco n√£o configurado ou tokens expirados
            }
            
            console.error('‚ùå Erro global capturado:', e.error);
            mostrarErro(e.error?.message || e.message || 'Erro desconhecido', e.error?.stack || e.stack);
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            // Ignorar erros de offline do Firestore, banco n√£o existente, √≠ndices faltantes, Cross-Origin-Opener-Policy e tokens OAuth expirados
            const isOfflineError = e.reason?.code === 'unavailable' || 
                                  e.reason?.code === 'failed-precondition' ||
                                  e.reason?.code === 'not-found' ||
                                  e.reason?.message?.includes('offline') ||
                                  e.reason?.message?.includes('client is offline') ||
                                  e.reason?.message?.includes('database') && e.reason?.message?.includes('does not exist') ||
                                  e.reason?.message?.includes('index') && e.reason?.message?.includes('requires') ||
                                  e.reason?.message?.includes('Cross-Origin-Opener-Policy') ||
                                  e.reason?.message?.includes('tokeninfo') || // Ignorar erros do tokeninfo do Google OAuth
                                  String(e.reason)?.includes('offline') ||
                                  String(e.reason)?.includes('client is offline') ||
                                  String(e.reason)?.includes('database') && String(e.reason)?.includes('does not exist') ||
                                  String(e.reason)?.includes('index') && String(e.reason)?.includes('requires') ||
                                  String(e.reason)?.includes('Cross-Origin-Opener-Policy') ||
                                  String(e.reason)?.includes('tokeninfo'); // Ignorar erros do tokeninfo do Google OAuth
            
            if (isOfflineError) {
                // N√£o logar Cross-Origin-Opener-Policy ou tokeninfo como warning (s√£o avisos esperados)
                const isTokenInfoError = e.reason?.message?.includes('tokeninfo') || String(e.reason)?.includes('tokeninfo');
                const isCoopError = e.reason?.message?.includes('Cross-Origin-Opener-Policy') || String(e.reason)?.includes('Cross-Origin-Opener-Policy');
                
                if (!isCoopError && !isTokenInfoError) {
                    console.warn('‚ö†Ô∏è Promise rejeitada por conectividade/Firestore - ignorando:', e.reason?.message || String(e.reason));
                }
                return; // N√£o mostrar erro na tela para problemas de conectividade, banco n√£o configurado ou tokens expirados
            }
            
            console.error('‚ùå Promise rejeitada n√£o tratada:', e.reason);
            mostrarErro('Erro ao carregar m√≥dulos: ' + (e.reason?.message || String(e.reason)), e.reason?.stack);
        });
        
        // Importar m√≥dulos (Babel processa isso)
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, deleteUser } from 'firebase/auth';
        import { getFirestore, collection, doc, getDoc, setDoc, getDocs, updateDoc, deleteDoc, query, where, orderBy, onSnapshot } from 'firebase/firestore';
        import { 
            Calendar, Users, UserPlus, Save, Trash2, AlertCircle, Check, 
            ChevronLeft, ChevronRight, ChevronDown, Search, BookOpen, 
            History, Globe, Wifi, ClipboardList, UserCheck, UserMinus, 
            Radio, Briefcase, Pencil, X, Settings, Plus, Music, Mic, 
            FileText, BarChart3, TrendingUp, PieChart, MoreVertical, 
            Printer, Smile, LogOut, Share2, Download, CheckCircle
        } from 'lucide-react';

        // Verificar se GoogleAuthProvider est√° dispon√≠vel
        if (typeof GoogleAuthProvider === 'undefined') {
            console.error('‚ùå GoogleAuthProvider n√£o foi importado corretamente');
            throw new Error('GoogleAuthProvider n√£o est√° dispon√≠vel. Verifique se o Import Map est√° configurado corretamente.');
        }

        // --- CONFIGURA√á√ÉO DO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDQ-4xLlMhPxC7Dgbd8MufXOiKb792IHaE",
            authDomain: "sacramental-novo.firebaseapp.com",
            projectId: "sacramental-novo",
            storageBucket: "sacramental-novo.firebasestorage.app",
            messagingSenderId: "911518938542",
            appId: "1:911518938542:web:7684cc7a26f28ab146843f"
        };
        
        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        console.log('‚úÖ Firebase inicializado');
        console.log('üìä Projeto:', firebaseConfig.projectId);
        console.log('üí° Se o banco foi criado recentemente, pode levar alguns minutos para estar totalmente dispon√≠vel na API.');

        // --- FUN√á√ïES FIRESTORE (Para Unidades e Usu√°rios) ---
        
        // Salvar unidade no Firestore
        const salvarUnidadeFirestore = async (unidadeData) => {
            try {
                const unidadeRef = unidadeData.id 
                    ? doc(db, 'unidades', unidadeData.id)
                    : doc(collection(db, 'unidades'));
                
                const dataToSave = {
                    ...unidadeData,
                    id: unidadeRef.id,
                    atualizadoEm: new Date().toISOString()
                };
                
                if (!unidadeData.criadoEm) {
                    dataToSave.criadoEm = new Date().toISOString();
                }
                
                await setDoc(unidadeRef, dataToSave, { merge: true });
                console.log('‚úÖ Unidade salva no Firestore:', unidadeRef.id);
                localStorage.setItem(`unidade_${unidadeRef.id}`, JSON.stringify(dataToSave));
                return unidadeRef.id;
            } catch (e) {
                console.error('‚ùå Erro ao salvar unidade no Firestore:', e);
                // Fallback para localStorage
                const id = unidadeData.id || 'unidade_' + Date.now();
                localStorage.setItem(`unidade_${id}`, JSON.stringify({ ...unidadeData, id }));
                return id;
            }
        };
        
        // Carregar unidade do Firestore
        const carregarUnidadeFirestore = async (unidadeId) => {
            // Verificar localStorage primeiro (mais r√°pido, funciona offline)
            const unidadeDataStr = localStorage.getItem(`unidade_${unidadeId}`);
            
            try {
                if (!navigator.onLine && unidadeDataStr) {
                    console.warn('‚ö†Ô∏è Offline - usando cache do localStorage para unidade:', unidadeId);
                    return JSON.parse(unidadeDataStr);
                }
                
                // Tentar carregar do Firestore
                const unidadeRef = doc(db, 'unidades', unidadeId);
                const unidadeSnap = await getDoc(unidadeRef);
                
                if (unidadeSnap.exists()) {
                    const data = { id: unidadeSnap.id, ...unidadeSnap.data() };
                    // Salvar no localStorage como cache
                    localStorage.setItem(`unidade_${unidadeId}`, JSON.stringify(data));
                    return data;
                }
            } catch (e) {
                // Verificar se √© erro de offline, conectividade ou banco n√£o existente
                const isOfflineError = e?.code === 'unavailable' || 
                                      e?.code === 'failed-precondition' ||
                                      e?.code === 'not-found' ||
                                      e?.message?.includes('offline') ||
                                      e?.message?.includes('client is offline') ||
                                      e?.message?.includes('database') && e?.message?.includes('does not exist') ||
                                      e?.message?.includes('Could not reach Cloud Firestore backend') ||
                                      !navigator.onLine;
                
                if (isOfflineError) {
                    // Erro de offline ou banco n√£o configurado - usar localStorage silenciosamente
                    if (unidadeDataStr) {
                        const isDatabaseNotExists = e?.code === 'not-found' && e?.message?.includes('database');
                        if (isDatabaseNotExists) {
                            console.warn('‚ö†Ô∏è Firestore ainda n√£o dispon√≠vel na API - usando cache do localStorage para unidade:', unidadeId);
                            console.info('üí° Se voc√™ acabou de criar o banco, aguarde alguns minutos para ele estar totalmente dispon√≠vel.');
                            console.info('   O app continuar√° funcionando normalmente usando o cache local.');
                        } else {
                            console.warn('‚ö†Ô∏è Firestore indispon√≠vel - usando cache do localStorage para unidade:', unidadeId);
                        }
                        return JSON.parse(unidadeDataStr);
                    }
                } else {
                    // Outro tipo de erro - logar como warning
                    console.warn('‚ö†Ô∏è Erro ao carregar unidade do Firestore:', e?.message || e);
                }
            }
            
            // Se n√£o encontrou ou erro, usar localStorage como fallback
            if (unidadeDataStr) {
                console.warn('‚ö†Ô∏è Usando cache do localStorage para unidade:', unidadeId);
                return JSON.parse(unidadeDataStr);
            }
            return null;
        };
        
        // Buscar todas as unidades do Firestore
        const buscarTodasUnidadesFirestore = async () => {
            try {
                if (!navigator.onLine) {
                    console.warn('‚ö†Ô∏è Offline - usando cache do localStorage');
                    return buscarUnidadesLocalStorage();
                }
                
                console.log('üîç Buscando todas as unidades do Firestore...');
                
                const unidadesRef = collection(db, 'unidades');
                
                // Primeiro, tentar buscar com orderBy (requer √≠ndice)
                try {
                    const q = query(unidadesRef, orderBy('criadoEm', 'desc'));
                    const querySnapshot = await getDocs(q);
                    
                    const unidades = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        unidades.push({ id: doc.id, ...data });
                    });
                    
                    console.log(`‚úÖ ${unidades.length} unidades encontradas no Firestore (com √≠ndice)`);
                    
                    // Atualizar cache do localStorage
                    unidades.forEach(unidade => {
                        localStorage.setItem(`unidade_${unidade.id}`, JSON.stringify(unidade));
                    });
                    return unidades;
                } catch (indexError) {
                    // Se der erro de √≠ndice, tentar buscar sem orderBy
                    const isIndexError = indexError?.code === 'failed-precondition' || 
                                        indexError?.message?.includes('index') || 
                                        indexError?.message?.includes('requires an index');
                    
                    if (isIndexError) {
                        console.warn('‚ö†Ô∏è √çndice n√£o criado. Buscando sem orderBy...');
                        if (indexError?.message?.includes('https://console.firebase.google.com')) {
                            const linkMatch = indexError.message.match(/https:\/\/[^\s]+/);
                            if (linkMatch) {
                                console.info('üìä Para criar o √≠ndice, acesse:', linkMatch[0]);
                            }
                        }
                        
                        // Buscar sem orderBy
                        const querySnapshot = await getDocs(unidadesRef);
                        const unidades = [];
                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            unidades.push({ id: doc.id, ...data });
                        });
                        
                        // Ordenar manualmente
                        unidades.sort((a, b) => {
                            const dateA = a.criadoEm ? new Date(a.criadoEm).getTime() : 0;
                            const dateB = b.criadoEm ? new Date(b.criadoEm).getTime() : 0;
                            return dateB - dateA;
                        });
                        
                        console.log(`‚úÖ ${unidades.length} unidades encontradas no Firestore (sem √≠ndice)`);
                        
                        // Atualizar cache do localStorage
                        unidades.forEach(unidade => {
                            localStorage.setItem(`unidade_${unidade.id}`, JSON.stringify(unidade));
                        });
                        return unidades;
                    }
                    
                    throw indexError;
                }
            } catch (e) {
                // Verificar se √© erro de permiss√£o
                const isPermissionError = e?.code === 'permission-denied' || 
                                         e?.message?.includes('permission') ||
                                         e?.message?.includes('Missing or insufficient permissions');
                
                if (isPermissionError) {
                    console.warn('‚ö†Ô∏è Erro de permiss√£o ao buscar unidades. Verifique as regras de seguran√ßa do Firestore.');
                    console.warn('üí° Dica: As regras devem permitir leitura para usu√°rios autenticados.');
                    console.warn('   Regra necess√°ria: allow read: if request.auth != null;');
                    // Tentar usar localStorage mesmo assim
                    return buscarUnidadesLocalStorage();
                }
                
                console.error('‚ùå Erro ao buscar unidades do Firestore:', e?.code || e?.message || e);
                // Fallback para localStorage
                const unidadesLocal = buscarUnidadesLocalStorage();
                if (unidadesLocal.length > 0) {
                    console.warn('‚ö†Ô∏è Usando cache do localStorage como fallback');
                }
                return unidadesLocal;
            }
        };
        
        const buscarUnidadesLocalStorage = () => {
            const unidades = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('unidade_')) {
                    try {
                        const unidadeData = JSON.parse(localStorage.getItem(key));
                        if (unidadeData && unidadeData.nome) {
                            unidades.push(unidadeData);
                        }
                    } catch (e) {
                        // Ignorar erros
                    }
                }
            }
            return unidades;
        };
        
        // Salvar usu√°rio no Firestore
        const salvarUsuarioFirestore = async (userId, userData) => {
            try {
                if (!db) {
                    throw new Error('Firestore n√£o est√° inicializado');
                }
                
                const userRef = doc(db, 'usuarios', userId);
                const dataToSave = {
                    ...userData,
                    id: userId,
                    atualizadoEm: new Date().toISOString()
                };
                
                if (!userData.criadoEm) {
                    dataToSave.criadoEm = new Date().toISOString();
                }
                
                // Verificar se √© erro de permiss√£o
                await setDoc(userRef, dataToSave, { merge: true });
                console.log('‚úÖ Usu√°rio salvo no Firestore:', userId, 'Status:', dataToSave.status);
                
                // Salvar no localStorage como backup
                localStorage.setItem(`user_${userId}`, JSON.stringify(dataToSave));
            } catch (e) {
                console.error('‚ùå Erro ao salvar usu√°rio no Firestore:', e);
                
                // Verificar se √© erro de permiss√£o
                const isPermissionError = e?.code === 'permission-denied' || 
                                         e?.message?.includes('permission') ||
                                         e?.message?.includes('Missing or insufficient permissions');
                
                if (isPermissionError) {
                    console.error('‚ùå Erro de permiss√£o do Firestore! Verifique as regras de seguran√ßa.');
                    console.error('üí° Dica: As regras devem permitir que usu√°rios autenticados escrevam seus pr√≥prios dados.');
                    // Re-lan√ßar o erro para que seja tratado no handleApprove
                    throw new Error('Permiss√£o negada no Firestore. Verifique as regras de seguran√ßa ou entre em contato com o administrador.');
                }
                
                // Fallback para localStorage apenas se n√£o for erro de permiss√£o
                try {
                    localStorage.setItem(`user_${userId}`, JSON.stringify({ ...userData, id: userId }));
                    console.warn('‚ö†Ô∏è Dados salvos no localStorage como fallback');
                } catch (storageError) {
                    console.error('‚ùå Erro ao salvar no localStorage tamb√©m:', storageError);
                }
                
                // Re-lan√ßar o erro para que seja tratado
                throw e;
            }
        };
        
        // Carregar usu√°rio do Firestore
        const carregarUsuarioFirestore = async (userId, forceRefresh = false) => {
            // Verificar localStorage primeiro (mais r√°pido, funciona offline)
            const userDataStr = localStorage.getItem(`user_${userId}`);
            
            // Se n√£o for√ßar refresh e estiver offline, usar localStorage imediatamente
            if (!forceRefresh && !navigator.onLine) {
                if (userDataStr) {
                    console.warn('‚ö†Ô∏è Offline - usando cache do localStorage para usu√°rio:', userId);
                    return JSON.parse(userDataStr);
                }
                return null;
            }
            
            try {
                // Tentar carregar do Firestore (dados mais atualizados)
                const userRef = doc(db, 'usuarios', userId);
                const userSnap = await getDoc(userRef);
                
                if (userSnap.exists()) {
                    const data = { id: userSnap.id, ...userSnap.data() };
                    // Atualizar cache do localStorage
                    localStorage.setItem(`user_${userId}`, JSON.stringify(data));
                    console.log('‚úÖ Usu√°rio carregado do Firestore:', userId, 'Status:', data.status);
                    return data;
                }
            } catch (e) {
                // Verificar se √© erro de offline do Firestore ou banco n√£o existente
                const isOfflineError = e?.code === 'unavailable' || 
                                      e?.code === 'failed-precondition' ||
                                      e?.code === 'not-found' ||
                                      e?.message?.includes('offline') ||
                                      e?.message?.includes('client is offline') ||
                                      e?.message?.includes('Failed to get document because the client is offline') ||
                                      e?.message?.includes('database') && e?.message?.includes('does not exist') ||
                                      e?.message?.includes('Could not reach Cloud Firestore backend');
                
                if (isOfflineError) {
                    // Firestore est√° offline ou n√£o existe - usar localStorage silenciosamente
                    if (userDataStr) {
                        const isDatabaseNotExists = e?.code === 'not-found' && e?.message?.includes('database');
                        if (isDatabaseNotExists) {
                            console.warn('‚ö†Ô∏è Firestore ainda n√£o dispon√≠vel na API - usando cache do localStorage para usu√°rio:', userId);
                            console.info('üí° Se voc√™ acabou de criar o banco, aguarde alguns minutos para ele estar totalmente dispon√≠vel.');
                            console.info('   O app continuar√° funcionando normalmente usando o cache local.');
                        } else {
                            console.warn('‚ö†Ô∏è Firestore offline - usando cache do localStorage para usu√°rio:', userId);
                        }
                        return JSON.parse(userDataStr);
                    }
                    // N√£o logar como erro se for apenas offline ou banco n√£o existente
                    return null;
                }
                
                // Outros erros - logar como warning (n√£o como erro cr√≠tico)
                console.warn('‚ö†Ô∏è Erro ao carregar usu√°rio do Firestore:', e?.code || e?.message || e);
            }
            
            // Se n√£o encontrou no Firestore ou erro, usar localStorage como fallback
            if (userDataStr) {
                console.warn('‚ö†Ô∏è Usando cache do localStorage para usu√°rio:', userId);
                return JSON.parse(userDataStr);
            }
            return null;
        };
        
        // Buscar usu√°rios de uma unidade do Firestore
        const buscarUsuariosUnidadeFirestore = async (unidadeId) => {
            try {
                if (!navigator.onLine) {
                    return buscarUsuariosLocalStorage(unidadeId);
                }
                
                const usuariosRef = collection(db, 'usuarios');
                const q = query(usuariosRef, where('unidadeId', '==', unidadeId), orderBy('criadoEm', 'desc'));
                const querySnapshot = await getDocs(q);
                
                const usuarios = [];
                querySnapshot.forEach((doc) => {
                    usuarios.push({ id: doc.id, ...doc.data() });
                });
                
                return usuarios;
            } catch (e) {
                // Verificar se √© erro de √≠ndice faltante
                const isIndexError = e?.code === 'failed-precondition' || 
                                    e?.message?.includes('index') || 
                                    e?.message?.includes('requires an index');
                
                if (isIndexError) {
                    // Erro de √≠ndice - usar localStorage e mostrar link √∫til
                    console.warn('‚ö†Ô∏è √çndice do Firestore n√£o criado ainda. Usando cache do localStorage.');
                    if (e?.message?.includes('https://console.firebase.google.com')) {
                        // Extrair o link do erro se dispon√≠vel
                        const linkMatch = e.message.match(/https:\/\/[^\s]+/);
                        if (linkMatch) {
                            console.info('üìä Para criar o √≠ndice, acesse:', linkMatch[0]);
                        }
                    }
                    return buscarUsuariosLocalStorage(unidadeId);
                }
                
                // Outros erros - logar como warning
                console.warn('‚ö†Ô∏è Erro ao buscar usu√°rios da unidade:', e?.message || e);
                // Fallback para localStorage
                return buscarUsuariosLocalStorage(unidadeId);
            }
        };
        
        const buscarUsuariosLocalStorage = (unidadeId) => {
            const usuarios = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('user_')) {
                    try {
                        const userData = JSON.parse(localStorage.getItem(key));
                        if (userData.unidadeId === unidadeId) {
                            usuarios.push({ id: key.replace('user_', ''), ...userData });
                        }
                    } catch (e) {
                        // Ignorar erros
                    }
                }
            }
            return usuarios;
        };
        
        // Salvar solicita√ß√£o pendente no Firestore
        const salvarSolicitacaoFirestore = async (solicitacao) => {
            try {
                // Garantir que todos os campos necess√°rios est√£o presentes
                const dataToSave = {
                    userId: solicitacao.userId,
                    email: solicitacao.email,
                    nome: solicitacao.nome || solicitacao.email?.split('@')[0],
                    unidadeId: solicitacao.unidadeId,
                    unidadeNome: solicitacao.unidadeNome || '',
                    status: 'pending',
                    criadoEm: new Date().toISOString()
                };
                
                console.log('üíæ Salvando solicita√ß√£o no Firestore:', dataToSave);
                
                const solicitacaoRef = doc(collection(db, 'solicitacoes'));
                await setDoc(solicitacaoRef, { ...dataToSave, id: solicitacaoRef.id });
                
                console.log('‚úÖ Solicita√ß√£o salva no Firestore:', solicitacaoRef.id, 'com unidadeId:', dataToSave.unidadeId);
                
                // Tamb√©m salvar no localStorage como backup
                try {
                    const solicitacoes = JSON.parse(localStorage.getItem('pending_requests') || '[]');
                    solicitacoes.push({ ...dataToSave, id: solicitacaoRef.id });
                    localStorage.setItem('pending_requests', JSON.stringify(solicitacoes));
                } catch (storageError) {
                    console.warn('‚ö†Ô∏è Erro ao salvar no localStorage:', storageError);
                }
                
                return solicitacaoRef.id;
            } catch (e) {
                console.error('‚ùå Erro ao salvar solicita√ß√£o no Firestore:', e);
                console.error('   - C√≥digo:', e.code);
                console.error('   - Mensagem:', e.message);
                
                // Fallback para localStorage
                try {
                    const solicitacoes = JSON.parse(localStorage.getItem('pending_requests') || '[]');
                    const fallbackRequest = {
                        ...solicitacao,
                        id: 'local_' + Date.now(),
                        status: 'pending',
                        criadoEm: new Date().toISOString()
                    };
                    solicitacoes.push(fallbackRequest);
                    localStorage.setItem('pending_requests', JSON.stringify(solicitacoes));
                    console.warn('‚ö†Ô∏è Solicita√ß√£o salva apenas no localStorage como fallback');
                    return fallbackRequest.id;
                } catch (storageError) {
                    console.error('‚ùå Erro ao salvar no localStorage tamb√©m:', storageError);
                    throw e;
                }
            }
        };
        
        // Buscar solicita√ß√µes pendentes de uma unidade no Firestore
        const buscarSolicitacoesPendentesFirestore = async (unidadeId) => {
            try {
                if (!navigator.onLine) {
                    console.log('‚ö†Ô∏è Offline - usando localStorage para solicita√ß√µes');
                    return buscarSolicitacoesLocalStorage(unidadeId);
                }
                
                if (!unidadeId) {
                    console.warn('‚ö†Ô∏è unidadeId n√£o fornecido para buscar solicita√ß√µes');
                    return buscarSolicitacoesLocalStorage(unidadeId);
                }
                
                console.log('üîç Buscando solicita√ß√µes pendentes para unidade:', unidadeId);
                
                const solicitacoesRef = collection(db, 'solicitacoes');
                
                // Primeiro, tentar buscar com a query completa (requer √≠ndice)
                try {
                    const q = query(
                        solicitacoesRef, 
                        where('unidadeId', '==', unidadeId), 
                        where('status', '==', 'pending'), 
                        orderBy('criadoEm', 'desc')
                    );
                    const querySnapshot = await getDocs(q);
                    
                    const solicitacoes = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        solicitacoes.push({ id: doc.id, ...data });
                    });
                    
                    console.log(`‚úÖ ${solicitacoes.length} solicita√ß√µes encontradas no Firestore para unidade ${unidadeId}`);
                    return solicitacoes;
                } catch (indexError) {
                    // Se der erro de √≠ndice, tentar buscar sem orderBy
                    const isIndexError = indexError?.code === 'failed-precondition' || 
                                        indexError?.message?.includes('index') || 
                                        indexError?.message?.includes('requires an index');
                    
                    if (isIndexError) {
                        console.warn('‚ö†Ô∏è √çndice n√£o criado. Buscando sem orderBy...');
                        if (indexError?.message?.includes('https://console.firebase.google.com')) {
                            const linkMatch = indexError.message.match(/https:\/\/[^\s]+/);
                            if (linkMatch) {
                                console.info('üìä Para criar o √≠ndice, acesse:', linkMatch[0]);
                            }
                        }
                        
                        // Tentar buscar sem orderBy
                        const q2 = query(
                            solicitacoesRef, 
                            where('unidadeId', '==', unidadeId), 
                            where('status', '==', 'pending')
                        );
                        const querySnapshot2 = await getDocs(q2);
                        
                        const solicitacoes = [];
                        querySnapshot2.forEach((doc) => {
                            const data = doc.data();
                            solicitacoes.push({ id: doc.id, ...data });
                        });
                        
                        // Ordenar manualmente
                        solicitacoes.sort((a, b) => {
                            const dateA = a.criadoEm ? new Date(a.criadoEm).getTime() : 0;
                            const dateB = b.criadoEm ? new Date(b.criadoEm).getTime() : 0;
                            return dateB - dateA;
                        });
                        
                        console.log(`‚úÖ ${solicitacoes.length} solicita√ß√µes encontradas (sem √≠ndice)`);
                        return solicitacoes;
                    }
                    
                    throw indexError;
                }
            } catch (e) {
                console.error('‚ùå Erro ao buscar solicita√ß√µes do Firestore:', e);
                console.error('   - C√≥digo:', e.code);
                console.error('   - Mensagem:', e.message);
                
                // Fallback para localStorage
                console.warn('‚ö†Ô∏è Usando localStorage como fallback');
                return buscarSolicitacoesLocalStorage(unidadeId);
            }
        };
        
        const buscarSolicitacoesLocalStorage = (unidadeId) => {
            const solicitacoes = JSON.parse(localStorage.getItem('pending_requests') || '[]');
            return solicitacoes.filter(s => s.unidadeId === unidadeId && s.status === 'pending');
        };
        
        // --- FUN√á√ïES FIRESTORE PARA MEMBROS, ASSIGNMENTS E ATTENDANCE (Sincroniza√ß√£o em Tempo Real) ---
        
        // Salvar membro no Firestore
        const salvarMembroFirestore = async (unidadeId, memberId, memberData) => {
            try {
                if (!db) {
                    throw new Error('Firestore n√£o est√° inicializado');
                }
                
                const memberRef = doc(db, 'unidades', unidadeId, 'membros', memberId);
                const dataToSave = {
                    ...memberData,
                    id: memberId,
                    unidadeId: unidadeId,
                    atualizadoEm: new Date().toISOString()
                };
                
                if (!memberData.criadoEm && !memberData.createdAt) {
                    dataToSave.criadoEm = new Date().toISOString();
                    dataToSave.createdAt = dataToSave.criadoEm; // Compatibilidade
                } else if (memberData.createdAt && !memberData.criadoEm) {
                    dataToSave.criadoEm = memberData.createdAt; // Converter createdAt para criadoEm
                } else if (memberData.criadoEm && !memberData.createdAt) {
                    dataToSave.createdAt = memberData.criadoEm; // Converter criadoEm para createdAt
                }
                
                await setDoc(memberRef, dataToSave, { merge: true });
                console.log('‚úÖ Membro salvo no Firestore:', memberId);
                
                // Backup no localStorage
                const membersCache = JSON.parse(localStorage.getItem(`members_${unidadeId}`) || '[]');
                const index = membersCache.findIndex(m => m.id === memberId);
                if (index >= 0) {
                    membersCache[index] = dataToSave;
                } else {
                    membersCache.push(dataToSave);
                }
                localStorage.setItem(`members_${unidadeId}`, JSON.stringify(membersCache));
            } catch (e) {
                console.error('‚ùå Erro ao salvar membro no Firestore:', e);
                throw e;
            }
        };
        
        // Salvar assignment no Firestore
        const salvarAssignmentFirestore = async (unidadeId, dateStr, assignmentData) => {
            try {
                if (!db) {
                    throw new Error('Firestore n√£o est√° inicializado');
                }
                
                const assignmentRef = doc(db, 'unidades', unidadeId, 'assignments', dateStr);
                const dataToSave = {
                    ...assignmentData,
                    id: dateStr,
                    date: dateStr,
                    unidadeId: unidadeId,
                    atualizadoEm: new Date().toISOString()
                };
                
                await setDoc(assignmentRef, dataToSave, { merge: true });
                console.log('‚úÖ Assignment salvo no Firestore:', dateStr);
            } catch (e) {
                console.error('‚ùå Erro ao salvar assignment no Firestore:', e);
                throw e;
            }
        };
        
        // Salvar attendance no Firestore
        const salvarAttendanceFirestore = async (unidadeId, dateStr, attendanceData) => {
            try {
                if (!db) {
                    throw new Error('Firestore n√£o est√° inicializado');
                }
                
                if (!unidadeId) {
                    throw new Error('unidadeId n√£o fornecido');
                }
                
                if (!dateStr) {
                    throw new Error('dateStr n√£o fornecido');
                }
                
                const attendanceRef = doc(db, 'unidades', unidadeId, 'attendance', dateStr);
                
                // Garantir que os dados est√£o completos
                const finalData = {
                    ...attendanceData,
                    id: dateStr,
                    date: dateStr,
                    unidadeId: unidadeId,
                    attendees: attendanceData.attendees || [],
                    count: attendanceData.count || (attendanceData.attendees?.length || 0),
                    atualizadoEm: new Date().toISOString(),
                    criadoEm: attendanceData.criadoEm || new Date().toISOString()
                };
                
                await setDoc(attendanceRef, finalData, { merge: true });
                console.log('‚úÖ Attendance salvo no Firestore:', dateStr);
                console.log('üìä Dados salvos:', finalData);
                console.log('üìç Caminho do documento:', `unidades/${unidadeId}/attendance/${dateStr}`);
                
                // Backup no localStorage
                const attendanceCache = JSON.parse(localStorage.getItem(`attendance_${unidadeId}`) || '[]');
                const index = attendanceCache.findIndex(a => a.id === dateStr || a.date === dateStr);
                if (index >= 0) {
                    attendanceCache[index] = finalData;
                } else {
                    attendanceCache.push(finalData);
                }
                localStorage.setItem(`attendance_${unidadeId}`, JSON.stringify(attendanceCache));
                console.log('üíæ Backup salvo no localStorage:', attendanceCache.length, 'registros');
            } catch (e) {
                console.error('‚ùå Erro ao salvar attendance no Firestore:', e);
                throw e;
            }
        };
        
        // Deletar membro do Firestore
        const deletarMembroFirestore = async (unidadeId, memberId) => {
            try {
                if (!db) {
                    throw new Error('Firestore n√£o est√° inicializado');
                }
                
                const memberRef = doc(db, 'unidades', unidadeId, 'membros', memberId);
                await deleteDoc(memberRef);
                console.log('‚úÖ Membro deletado do Firestore:', memberId);
                
                // Atualizar cache do localStorage
                const membersCache = JSON.parse(localStorage.getItem(`members_${unidadeId}`) || '[]');
                const filtered = membersCache.filter(m => m.id !== memberId);
                localStorage.setItem(`members_${unidadeId}`, JSON.stringify(filtered));
            } catch (e) {
                console.error('‚ùå Erro ao deletar membro do Firestore:', e);
                throw e;
            }
        };
        
        // Salvar chamado no Firestore
        const salvarChamadoFirestore = async (unidadeId, callingId, callingData) => {
            try {
                if (!db) {
                    throw new Error('Firestore n√£o est√° inicializado');
                }
                
                const callingRef = doc(db, 'unidades', unidadeId, 'chamados', callingId);
                const dataToSave = {
                    ...callingData,
                    id: callingId,
                    unidadeId: unidadeId,
                    atualizadoEm: new Date().toISOString()
                };
                
                if (!callingData.criadoEm) {
                    dataToSave.criadoEm = new Date().toISOString();
                }
                
                await setDoc(callingRef, dataToSave, { merge: true });
                console.log('‚úÖ Chamado salvo no Firestore:', callingId);
            } catch (e) {
                console.error('‚ùå Erro ao salvar chamado no Firestore:', e);
                throw e;
            }
        };
        
        // Deletar chamado do Firestore
        const deletarChamadoFirestore = async (unidadeId, callingId) => {
            try {
                if (!db) {
                    throw new Error('Firestore n√£o est√° inicializado');
                }
                
                const callingRef = doc(db, 'unidades', unidadeId, 'chamados', callingId);
                await deleteDoc(callingRef);
                console.log('‚úÖ Chamado deletado do Firestore:', callingId);
            } catch (e) {
                console.error('‚ùå Erro ao deletar chamado do Firestore:', e);
                throw e;
            }
        };
        
        // Atualizar status de solicita√ß√£o no Firestore
        const atualizarSolicitacaoFirestore = async (solicitacaoId, status) => {
            try {
                const solicitacaoRef = doc(db, 'solicitacoes', solicitacaoId);
                await updateDoc(solicitacaoRef, {
                    status: status,
                    atualizadoEm: new Date().toISOString()
                });
                console.log('‚úÖ Solicita√ß√£o atualizada no Firestore');
            } catch (e) {
                console.error('‚ùå Erro ao atualizar solicita√ß√£o:', e);
                // Fallback para localStorage
                const solicitacoes = JSON.parse(localStorage.getItem('pending_requests') || '[]');
                const index = solicitacoes.findIndex(s => s.id === solicitacaoId || s.userId === solicitacaoId);
                if (index >= 0) {
                    solicitacoes[index].status = status;
                    solicitacoes[index].atualizadoEm = new Date().toISOString();
                    localStorage.setItem('pending_requests', JSON.stringify(solicitacoes));
                }
            }
        };

        // --- FUN√á√ïES GOOGLE DRIVE (Apenas para dados dos membros) ---
        const DRIVE_API_BASE = 'https://www.googleapis.com/drive/v3';
        const DRIVE_UPLOAD_BASE = 'https://www.googleapis.com/upload/drive/v3';

        // Armazenar token do Drive
        let driveAccessToken = null;

        // Client ID do OAuth para Google Drive
        const GOOGLE_OAUTH_CLIENT_ID = "911518938542-asumst6ci5q0d055nm49qg8pr3v2oeqb.apps.googleusercontent.com";
        
        // Solicitar acesso ao Google Drive usando Google Identity Services
        const solicitarAcessoDrive = async () => {
            // Se j√° temos um token armazenado, verificar se ainda √© v√°lido
            const storedToken = localStorage.getItem('drive_access_token');
            if (storedToken) {
                driveAccessToken = storedToken;
                // Verificar se o token ainda √© v√°lido
                try {
                    const testResponse = await fetch('https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=' + storedToken);
                    if (testResponse.ok) {
                        const tokenInfo = await testResponse.json();
                        // Verificar se o token n√£o expirou
                        if (tokenInfo.expires_in > 0) {
                            return driveAccessToken;
                        } else {
                            // Token expirado, remover e solicitar novo (silenciosamente)
                            localStorage.removeItem('drive_access_token');
                            driveAccessToken = null;
                        }
                    } else {
                        // Token inv√°lido (400 ou outro erro), remover e solicitar novo (silenciosamente)
                        // 400 √© esperado quando o token est√° expirado/inv√°lido, n√£o √© um erro cr√≠tico
                        localStorage.removeItem('drive_access_token');
                        driveAccessToken = null;
                    }
                } catch (e) {
                    // Erro ao verificar token (network ou outro), remover e solicitar novo (silenciosamente)
                    // N√£o logar como erro cr√≠tico - √© esperado que tokens expiram
                    localStorage.removeItem('drive_access_token');
                    driveAccessToken = null;
                }
            }

            return new Promise((resolve, reject) => {
                // Fun√ß√£o para inicializar o cliente de token
                const initTokenClient = () => {
                    try {
                        if (!window.google || !window.google.accounts || !window.google.accounts.oauth2) {
                            reject(new Error('Google Identity Services n√£o est√° dispon√≠vel. Recarregue a p√°gina.'));
                            return;
                        }

                        const tokenClient = window.google.accounts.oauth2.initTokenClient({
                            client_id: GOOGLE_OAUTH_CLIENT_ID,
                            scope: 'https://www.googleapis.com/auth/drive.file',
                            callback: (tokenResponse) => {
                                if (tokenResponse && tokenResponse.access_token) {
                                    driveAccessToken = tokenResponse.access_token;
                                    localStorage.setItem('drive_access_token', driveAccessToken);
                                    resolve(driveAccessToken);
                                } else if (tokenResponse.error) {
                                    reject(new Error('Erro ao obter acesso: ' + tokenResponse.error));
                                } else {
                                    reject(new Error('Acesso ao Drive negado ou cancelado pelo usu√°rio.'));
                                }
                            },
                        });
                        
                        // Solicitar token
                        tokenClient.requestAccessToken({ prompt: 'consent' });
                    } catch (e) {
                        reject(new Error('Erro ao inicializar cliente OAuth: ' + e.message));
                    }
                };

                // Aguardar o Google Identity Services carregar
                const waitForGoogle = () => {
                    if (window.google && window.google.accounts && window.google.accounts.oauth2) {
                        initTokenClient();
                    } else {
                        // Tentar novamente ap√≥s um pequeno delay
                        setTimeout(() => {
                            if (window.google && window.google.accounts && window.google.accounts.oauth2) {
                                initTokenClient();
                            } else {
                                reject(new Error('Google Identity Services n√£o carregou. Verifique sua conex√£o e recarregue a p√°gina.'));
                            }
                        }, 500);
                    }
                };

                // Se j√° carregou, usar imediatamente
                if (window.gsiLoaded || (window.google && window.google.accounts)) {
                    waitForGoogle();
                } else {
                    // Aguardar carregamento
                    let attempts = 0;
                    const checkInterval = setInterval(() => {
                        attempts++;
                        if (window.google && window.google.accounts && window.google.accounts.oauth2) {
                            clearInterval(checkInterval);
                            initTokenClient();
                        } else if (attempts > 30) { // 3 segundos
                            clearInterval(checkInterval);
                            reject(new Error('Timeout ao carregar Google Identity Services. Verifique se o Client ID est√° correto no Google Cloud Console.'));
                        }
                    }, 100);
                }
            });
        };

        // Obter access token do Google Drive
        const getGoogleAccessToken = async () => {
            // Tentar recuperar do localStorage primeiro
            const storedToken = localStorage.getItem('drive_access_token');
            if (storedToken && driveAccessToken) {
                return driveAccessToken;
            }
            
            if (driveAccessToken) {
                return driveAccessToken;
            }
            
            // Solicitar novo token (solicitarAcessoDrive j√° valida o token existente)
            try {
                return await solicitarAcessoDrive();
            } catch (e) {
                // Erro ao solicitar token, retornar null e deixar a fun√ß√£o chamadora lidar
                console.warn('‚ö†Ô∏è N√£o foi poss√≠vel obter token do Drive:', e?.message || e);
                return null;
            }
        };

        // Criar pasta no Drive do admin
        const criarPastaUnidadeDrive = async (nomeUnidade) => {
            try {
                const token = await getGoogleAccessToken();
                if (!token) {
                    throw new Error('Token do Drive n√£o dispon√≠vel');
                }
                
                const response = await fetch(`${DRIVE_API_BASE}/files`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: `Sacramental - ${nomeUnidade}`,
                        mimeType: 'application/vnd.google-apps.folder',
                    }),
                });
                
                if (!response.ok) throw new Error('Erro ao criar pasta');
                const data = await response.json();
                return data.id;
            } catch (e) {
                console.error("Erro ao criar pasta no Drive:", e);
                throw e;
            }
        };

        // Salvar dados no Drive
        const salvarNoDrive = async (folderId, fileName, data) => {
            try {
                const token = await getGoogleAccessToken();
                if (!token) {
                    throw new Error('Token do Drive n√£o dispon√≠vel');
                }
                
                // Verificar se arquivo existe
                const listResponse = await fetch(
                    `${DRIVE_API_BASE}/files?q=name='${fileName}.json' and '${folderId}' in parents and trashed=false`,
                    {
                        headers: { 'Authorization': `Bearer ${token}` },
                    }
                );
                const listData = await listResponse.json();
                
                const fileContent = JSON.stringify(data, null, 2);
                const blob = new Blob([fileContent], { type: 'application/json' });
                
                if (listData.files && listData.files.length > 0) {
                    // Atualizar arquivo existente
                    const fileId = listData.files[0].id;
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify({ name: `${fileName}.json` })], { type: 'application/json' }));
                    form.append('file', blob);
                    
                    await fetch(`${DRIVE_UPLOAD_BASE}/files/${fileId}?uploadType=multipart`, {
                        method: 'PATCH',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: form,
                    });
                    return fileId;
                } else {
                    // Criar novo arquivo
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify({
                        name: `${fileName}.json`,
                        parents: [folderId],
                    })], { type: 'application/json' }));
                    form.append('file', blob);
                    
                    const response = await fetch(`${DRIVE_UPLOAD_BASE}/files?uploadType=multipart`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: form,
                    });
                    const result = await response.json();
                    return result.id;
                }
            } catch (e) {
                console.error("Erro ao salvar no Drive:", e);
                throw e;
            }
        };

        // Carregar dados do Drive
        const carregarDoDrive = async (folderId, fileName) => {
            try {
                const token = await getGoogleAccessToken();
                if (!token) {
                    console.warn('‚ö†Ô∏è Token do Drive n√£o dispon√≠vel, n√£o √© poss√≠vel carregar do Drive');
                    return null;
                }
                
                const listResponse = await fetch(
                    `${DRIVE_API_BASE}/files?q=name='${fileName}.json' and '${folderId}' in parents and trashed=false`,
                    {
                        headers: { 'Authorization': `Bearer ${token}` },
                    }
                );
                const listData = await listResponse.json();
                
                if (listData.files && listData.files.length > 0) {
                    const fileId = listData.files[0].id;
                    const fileResponse = await fetch(`${DRIVE_API_BASE}/files/${fileId}?alt=media`, {
                        headers: { 'Authorization': `Bearer ${token}` },
                    });
                    return await fileResponse.json();
                }
                return null;
            } catch (e) {
                console.error("Erro ao carregar do Drive:", e);
                return null;
            }
        };

        // Listar arquivos de uma cole√ß√£o
        const listarArquivosDrive = async (folderId, prefix = '') => {
            try {
                const token = await getGoogleAccessToken();
                if (!token) {
                    console.warn('‚ö†Ô∏è Token do Drive n√£o dispon√≠vel, n√£o √© poss√≠vel listar arquivos do Drive');
                    return [];
                }
                
                let query = `'${folderId}' in parents and trashed=false and mimeType='application/json'`;
                if (prefix) query += ` and name starts with '${prefix}'`;
                
                const response = await fetch(`${DRIVE_API_BASE}/files?q=${encodeURIComponent(query)}&fields=files(id,name)`, {
                    headers: { 'Authorization': `Bearer ${token}` },
                });
                const data = await response.json();
                
                const files = [];
                for (const file of data.files || []) {
                    try {
                        const fileResponse = await fetch(`${DRIVE_API_BASE}/files/${file.id}?alt=media`, {
                            headers: { 'Authorization': `Bearer ${token}` },
                        });
                        if (fileResponse.ok) {
                            const fileData = await fileResponse.json();
                            // Extrair ID do nome do arquivo
                            const fileName = file.name.replace('.json', '');
                            // Para members e callings, manter o prefixo no ID para facilitar
                            // Para assignments e attendance, usar apenas a data como ID
                            let id;
                            if (fileName.startsWith('assignment_')) {
                                id = fileName.replace('assignment_', '');
                            } else if (fileName.startsWith('attendance_')) {
                                id = fileName.replace('attendance_', '');
                            } else {
                                // Para members e callings, usar o nome completo como ID
                                id = fileName;
                            }
                            files.push({ id: id, ...fileData });
                        }
                    } catch (e) {
                        console.error(`Erro ao carregar arquivo ${file.name}:`, e);
                    }
                }
                return files;
            } catch (e) {
                console.error("Erro ao listar arquivos:", e);
                return [];
            }
        };

        // Deletar arquivo do Drive
        const deletarDoDrive = async (folderId, fileName) => {
            try {
                const token = await getGoogleAccessToken();
                if (!token) {
                    throw new Error('Token do Drive n√£o dispon√≠vel');
                }
                
                const listResponse = await fetch(
                    `${DRIVE_API_BASE}/files?q=name='${fileName}.json' and '${folderId}' in parents and trashed=false`,
                    {
                        headers: { 'Authorization': `Bearer ${token}` },
                    }
                );
                const listData = await listResponse.json();
                
                if (listData.files && listData.files.length > 0) {
                    await fetch(`${DRIVE_API_BASE}/files/${listData.files[0].id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` },
                    });
                }
            } catch (e) {
                console.error("Erro ao deletar do Drive:", e);
                throw e;
            }
        };

        // --- Fun√ß√£o para gerar PDF dos relat√≥rios ---
        // Fun√ß√£o para gerar PDF detalhado por membro
        const gerarPDFDetalhadoMembros = (membersReport, periodo = 'mensal') => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            const primaryColor = [30, 58, 138];
            const secondaryColor = [102, 126, 234];
            const textColor = [31, 41, 55];
            const lightGray = [107, 114, 128];

            // Cabe√ßalho
            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, 210, 50, 'F');
            doc.setFillColor(...secondaryColor);
            doc.rect(0, 0, 210, 25, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text('Sacramental LDS', 20, 20);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`Relat√≥rio Detalhado por Membro - ${periodo === 'mensal' ? 'Mensal' : 'Semanal'}`, 20, 30);
            doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 20, 40);

            let yPos = 70;
            let pageNum = 1;

            membersReport.forEach((member, idx) => {
                // Nova p√°gina se necess√°rio
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                    pageNum++;
                }

                // Nome do membro
                doc.setTextColor(...textColor);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(member.name, 20, yPos);
                yPos += 8;

                if (member.classe) {
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'italic');
                    doc.setTextColor(...lightGray);
                    doc.text(`Classe: ${member.classe}`, 20, yPos);
                    yPos += 6;
                }

                // Estat√≠sticas
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...textColor);
                const total = member.totalPresencas + member.totalFaltas;
                const percentual = total > 0 ? Math.round((member.totalPresencas / total) * 100) : 0;
                
                doc.text(`Presen√ßas: ${member.totalPresencas} | Faltas: ${member.totalFaltas} | Frequ√™ncia: ${percentual}%`, 20, yPos);
                yPos += 10;

                // Presen√ßas
                if (member.presencas.length > 0) {
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(34, 197, 94); // Verde
                    doc.text('Quando veio:', 20, yPos);
                    yPos += 6;
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...textColor);
                    const presencasText = member.presencas.slice(0, 8).join(', ') + (member.presencas.length > 8 ? '...' : '');
                    doc.text(presencasText, 25, yPos, { maxWidth: 165 });
                    yPos += member.presencas.length > 8 ? 12 : 6;
                }

                // Faltas
                if (member.faltas.length > 0) {
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(239, 68, 68); // Vermelho
                    doc.text('Quando faltou:', 20, yPos);
                    yPos += 6;
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...textColor);
                    const faltasText = member.faltas.slice(0, 8).join(', ') + (member.faltas.length > 8 ? '...' : '');
                    doc.text(faltasText, 25, yPos, { maxWidth: 165 });
                    yPos += member.faltas.length > 8 ? 12 : 6;
                }

                yPos += 5;
                if (idx < membersReport.length - 1) {
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.3);
                    doc.line(20, yPos, 190, yPos);
                    yPos += 8;
                }
            });

            // Rodap√©
            const pageHeight = doc.internal.pageSize.height;
            yPos = pageHeight - 20;
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.3);
            doc.line(20, yPos, 190, yPos);
            yPos += 5;
            doc.setFontSize(9);
            doc.setFont('helvetica', 'italic');
            doc.setTextColor(...lightGray);
            doc.text(`Documento gerado automaticamente pelo Sistema Sacramental LDS - P√°gina ${pageNum}`, 20, yPos, { align: 'center', maxWidth: 170 });

            const nomeArquivo = `relatorio_detalhado_${periodo}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(nomeArquivo);
        };

        // Fun√ß√£o para gerar PDF de faltas por classe
        const gerarPDFFaltasPorClasse = (faltasPorClasse, periodo = 'mensal') => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            const primaryColor = [30, 58, 138];
            const secondaryColor = [102, 126, 234];
            const textColor = [31, 41, 55];
            const lightGray = [107, 114, 128];

            // Cabe√ßalho
            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, 210, 50, 'F');
            doc.setFillColor(...secondaryColor);
            doc.rect(0, 0, 210, 25, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text('Sacramental LDS', 20, 20);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`Relat√≥rio de Faltas por Classe - ${periodo === 'mensal' ? 'Mensal' : 'Trimestral'}`, 20, 30);
            doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 20, 40);

            let yPos = 70;

            faltasPorClasse.forEach(({ classe, totalFaltas, membros }) => {
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }

                // Classe
                doc.setFillColor(...secondaryColor);
                doc.roundedRect(20, yPos - 5, 170, 10, 2, 2, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.text(classe, 25, yPos + 3);
                doc.text(`Total: ${totalFaltas}`, 165, yPos + 3, { align: 'right' });
                yPos += 12;

                // Membros
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...textColor);
                
                membros.forEach((m, idx) => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.setFillColor(idx % 2 === 0 ? 249 : 255);
                    doc.rect(25, yPos - 4, 165, 7, 'F');
                    doc.text(m.nome, 30, yPos + 1);
                    doc.text(`${m.faltas} faltas`, 165, yPos + 1, { align: 'right' });
                    yPos += 8;
                });

                yPos += 5;
            });

            // Rodap√©
            const pageHeight = doc.internal.pageSize.height;
            yPos = pageHeight - 20;
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.3);
            doc.line(20, yPos, 190, yPos);
            yPos += 5;
            doc.setFontSize(9);
            doc.setFont('helvetica', 'italic');
            doc.setTextColor(...lightGray);
            doc.text('Documento gerado automaticamente pelo Sistema Sacramental LDS', 20, yPos, { align: 'center', maxWidth: 170 });

            const nomeArquivo = `relatorio_faltas_classe_${periodo}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(nomeArquivo);
        };

        const gerarPDFRelatorio = (metrics, tipo = 'mensal') => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            // Cores do tema
            const primaryColor = [30, 58, 138]; // #1e3a8a
            const secondaryColor = [102, 126, 234]; // #667eea
            const textColor = [31, 41, 55];
            const lightGray = [107, 114, 128];

            // Cabe√ßalho com gradiente
            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, 210, 50, 'F');
            
            doc.setFillColor(...secondaryColor);
            doc.rect(0, 0, 210, 25, 'F');

            // Logo/T√≠tulo
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont('helvetica', 'bold');
            doc.text('Sacramental LDS', 20, 20);

            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('Relat√≥rio de Frequ√™ncia', 20, 30);
            doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 20, 40);

            // Conte√∫do
            let yPos = 70;

            // T√≠tulo do relat√≥rio
            doc.setTextColor(...textColor);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text(tipo === 'mensal' ? 'Relat√≥rio Mensal' : 'Relat√≥rio Trimestral', 20, yPos);
            yPos += 15;

            // Linha divis√≥ria
            doc.setDrawColor(...secondaryColor);
            doc.setLineWidth(0.5);
            doc.line(20, yPos, 190, yPos);
            yPos += 10;

            // Dados
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            
            const dados = tipo === 'mensal' ? metrics.monthly : metrics.quarterly;
            
            if (dados.length === 0) {
                doc.setTextColor(...lightGray);
                doc.text('Nenhum dado dispon√≠vel no momento.', 20, yPos);
            } else {
                // Cabe√ßalho da tabela
                doc.setFillColor(...secondaryColor);
                doc.roundedRect(20, yPos - 5, 170, 10, 2, 2, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.text('Per√≠odo', 25, yPos + 2);
                doc.text('M√©dia', 165, yPos + 2, { align: 'right' });
                yPos += 12;

                // Dados da tabela
                dados.forEach((item, index) => {
                    doc.setFillColor(index % 2 === 0 ? 249 : 255);
                    doc.rect(20, yPos - 5, 170, 8, 'F');
                    
                    doc.setTextColor(...textColor);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(11);
                    doc.text(item.label, 25, yPos + 2);
                    doc.text(item.avg.toString(), 165, yPos + 2, { align: 'right' });
                    yPos += 10;
                });
            }

            // Rodap√©
            const pageHeight = doc.internal.pageSize.height;
            yPos = pageHeight - 30;

            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.3);
            doc.line(20, yPos, 190, yPos);
            yPos += 10;

            doc.setFontSize(9);
            doc.setFont('helvetica', 'italic');
            doc.setTextColor(...lightGray);
            doc.text(
                `Documento gerado automaticamente pelo Sistema Sacramental LDS`,
                20,
                yPos,
                { align: 'center', maxWidth: 170 }
            );

            // Salvar
            const nomeArquivo = `relatorio_${tipo}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(nomeArquivo);
        };

        // --- Componentes UI ---
        const Avatar = ({ name, type = 'member', size = 'md', className = '' }) => {
            const initials = name ? name.split(' ').map(n => n[0]).slice(0, 2).join('').toUpperCase() : '??';
            
            const sizeClasses = {
                sm: 'w-8 h-8 text-xs',
                md: 'w-10 h-10 text-sm',
                lg: 'w-12 h-12 text-base'
            };
            const typeColor = type === 'visitor' ? 'bg-emerald-100 text-emerald-700 border-emerald-300' : 'bg-blue-100 text-blue-700 border-blue-300';

            return (
                <div className={`${sizeClasses[size]} rounded-full ${typeColor} flex items-center justify-center font-bold shrink-0 border-2 border-white shadow-md ${className}`}>
                    {initials}
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        // Componente de Autentica√ß√£o
        function AuthScreen({ onAuthSuccess }) {
            const [mode, setMode] = useState('login'); // 'login', 'register', 'createUnit'
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [unidadeNome, setUnidadeNome] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            const [showUnidadeModal, setShowUnidadeModal] = useState(false);
            const [pendingGoogleUser, setPendingGoogleUser] = useState(null);
            const [tempUnidadeNome, setTempUnidadeNome] = useState('');
            const [loggedInUser, setLoggedInUser] = useState(null); // Usu√°rio que fez login mas ainda n√£o escolheu unidade
            const [availableUnits, setAvailableUnits] = useState([]); // Lista de unidades dispon√≠veis

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    // Autenticar com Firebase Auth
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    console.log('‚úÖ Login com email/senha realizado. UID:', user.uid, 'Email:', user.email);
                    
                    // Criar objeto compat√≠vel
                    const userObj = {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName || user.email.split('@')[0]
                    };
                    
                    // Processar login (verificar se tem unidade ou mostrar sele√ß√£o)
                    await processarLoginSucesso(userObj);
                } catch (e) {
                    console.error('Erro ao fazer login:', e);
                    if (e.code === 'auth/wrong-password' || e.code === 'auth/invalid-credential') {
                        setError('Email ou senha incorretos. Verifique suas credenciais.');
                    } else if (e.code === 'auth/user-not-found') {
                        setError('Email n√£o cadastrado. Crie uma conta primeiro.');
                    } else if (e.code === 'auth/invalid-email') {
                        setError('Email inv√°lido. Verifique o formato do email.');
                    } else {
                        setError('Erro ao fazer login. Tente novamente.');
                    }
                    setLoading(false);
                }
            };

            // Fun√ß√£o para buscar unidades dispon√≠veis no Firestore
            const buscarUnidadesDisponiveis = async () => {
                try {
                    console.log('üîç Buscando unidades dispon√≠veis no Firestore...');
                    console.log('   - Usu√°rio autenticado:', auth.currentUser?.email || 'N√£o autenticado');
                    console.log('   - UID:', auth.currentUser?.uid || 'N/A');
                    
                    const unidades = await buscarTodasUnidadesFirestore();
                    console.log(`‚úÖ ${unidades.length} unidades encontradas`);
                    
                    if (unidades.length === 0) {
                        console.warn('‚ö†Ô∏è Nenhuma unidade encontrada. Verifique:');
                        console.warn('   1. Se o Firestore est√° configurado corretamente');
                        console.warn('   2. Se as regras de seguran√ßa permitem leitura para usu√°rios autenticados');
                        console.warn('   3. Se h√° unidades cadastradas no Firestore');
                        console.warn('   4. Regra necess√°ria: allow read: if request.auth != null;');
                    } else {
                        console.log('üìã Unidades encontradas:');
                        unidades.forEach((u, idx) => {
                            console.log(`   ${idx + 1}. ${u.nome} (ID: ${u.id}, Admin: ${u.adminEmail || 'N/A'})`);
                        });
                    }
                    
                    return unidades.map(u => ({
                        id: u.id,
                        nome: u.nome || 'Unidade',
                        driveFolderId: u.driveFolderId || u.id, // Manter compatibilidade
                        criadoEm: u.criadoEm,
                        adminEmail: u.adminEmail
                    }));
                } catch (e) {
                    console.error('‚ùå Erro ao buscar unidades:', e);
                    console.error('   - C√≥digo:', e?.code);
                    console.error('   - Mensagem:', e?.message);
                    console.error('   - Stack:', e?.stack);
                    return [];
                }
            };

            // Fun√ß√£o para solicitar acesso √† unidade (usando Firestore)
            const solicitarAcessoUnidade = async (unidade) => {
                setLoading(true);
                setError('');
                try {
                    // Verificar se j√° existe solicita√ß√£o pendente
                    const solicitacoesExistentes = await buscarSolicitacoesPendentesFirestore(unidade.id);
                    const existingRequest = solicitacoesExistentes.find(r => 
                        r.userId === loggedInUser.uid || r.email?.toLowerCase() === loggedInUser.email?.toLowerCase()
                    );
                    
                    if (existingRequest) {
                        setError('Voc√™ j√° tem uma solicita√ß√£o pendente para esta unidade.');
                        setLoading(false);
                        return;
                    }
                    
                    // Criar nova solicita√ß√£o no Firestore
                    const newRequest = {
                        userId: loggedInUser.uid,
                        email: loggedInUser.email,
                        nome: loggedInUser.displayName || loggedInUser.email.split('@')[0],
                        unidadeId: unidade.id,
                        unidadeNome: unidade.nome,
                        status: 'pending'
                    };
                    
                    await salvarSolicitacaoFirestore(newRequest);
                    
                    // Salvar dados do usu√°rio no Firestore com status pending
                    await salvarUsuarioFirestore(loggedInUser.uid, {
                        id: loggedInUser.uid,
                        email: loggedInUser.email,
                        unidadeId: unidade.id,
                        role: 'user',
                        status: 'pending',
                        nome: loggedInUser.displayName || loggedInUser.email.split('@')[0],
                        criadoEm: new Date().toISOString()
                    });
                    
                    // Tamb√©m salvar no localStorage para compatibilidade
                    localStorage.setItem(`user_${loggedInUser.uid}`, JSON.stringify({
                        id: loggedInUser.uid,
                        email: loggedInUser.email,
                        unidadeId: unidade.id,
                        role: 'user',
                        status: 'pending',
                        nome: loggedInUser.displayName || loggedInUser.email.split('@')[0],
                        criadoEm: new Date().toISOString()
                    }));
                    
                    setSuccess(`Solicita√ß√£o de acesso enviada para "${unidade.nome}". Aguarde a aprova√ß√£o do administrador.`);
                    setLoading(false);
                    
                    // Voltar para tela de login ap√≥s 3 segundos
                    setTimeout(() => {
                        setLoggedInUser(null);
                        setAvailableUnits([]);
                        setSuccess('');
                    }, 3000);
                } catch (e) {
                    console.error('Erro ao solicitar acesso:', e);
                    setError('Erro ao enviar solicita√ß√£o. Tente novamente.');
                    setLoading(false);
                }
            };

            // Fun√ß√£o para processar login/cadastro bem-sucedido (usando Firestore)
            const processarLoginSucesso = async (user) => {
                setLoading(true);
                try {
                    // Buscar dados do usu√°rio no Firestore (for√ßar refresh para pegar status mais recente)
                    let userData = await carregarUsuarioFirestore(user.uid, true);
                    
                    // Se n√£o encontrou, criar novo registro
                    if (!userData) {
                        const newUserData = {
                            id: user.uid,
                            email: user.email,
                            nome: user.displayName || user.email?.split('@')[0],
                            criadoEm: new Date().toISOString(),
                            atualizadoEm: new Date().toISOString()
                        };
                        
                        await salvarUsuarioFirestore(user.uid, newUserData);
                        console.log('‚úÖ Novo usu√°rio salvo no Firestore:', user.uid);
                        userData = newUserData;
                    } else {
                        // Atualizar dados se necess√°rio (email/nome), mas manter status e unidadeId
                        const needsUpdate = (user.email && userData.email !== user.email) ||
                                          (user.displayName && userData.nome !== user.displayName);
                        
                        if (needsUpdate) {
                            const updatedData = {
                                ...userData,
                                email: user.email || userData.email,
                                nome: user.displayName || userData.nome || user.email?.split('@')[0],
                                atualizadoEm: new Date().toISOString()
                            };
                            await salvarUsuarioFirestore(user.uid, updatedData);
                            console.log('‚úÖ Dados do usu√°rio atualizados no Firestore');
                            userData = updatedData;
                        }
                        
                        // Se tem unidadeId mas status n√£o √© approved, verificar novamente no Firestore
                        // (o usu√°rio pode ter sido aprovado recentemente pelo admin)
                        if (userData.unidadeId && userData.status !== 'approved') {
                            console.log('‚ö†Ô∏è Usu√°rio tem unidade mas status n√£o √© approved. Verificando novamente no Firestore...');
                            console.log('   - Status atual:', userData.status);
                            console.log('   - unidadeId:', userData.unidadeId);
                            
                            // For√ßar refresh m√∫ltiplas vezes para garantir que pegamos o status atualizado
                            let refreshedData = null;
                            for (let i = 0; i < 3; i++) {
                                await new Promise(resolve => setTimeout(resolve, 500)); // Aguardar 500ms entre tentativas
                                refreshedData = await carregarUsuarioFirestore(user.uid, true);
                                if (refreshedData && refreshedData.status === 'approved') {
                                    break;
                                }
                            }
                            
                            if (refreshedData) {
                                console.log('üìã Status ap√≥s refresh:', refreshedData.status);
                                console.log('   - unidadeId ap√≥s refresh:', refreshedData.unidadeId);
                                if (refreshedData.status === 'approved') {
                                    userData = refreshedData;
                                    console.log('‚úÖ Status atualizado para approved ap√≥s refresh');
                                    // Atualizar localStorage tamb√©m
                                    localStorage.setItem(`user_${user.uid}`, JSON.stringify(userData));
                                } else {
                                    console.warn('‚ö†Ô∏è Status ainda n√£o √© approved:', refreshedData.status);
                                }
                            } else {
                                console.warn('‚ö†Ô∏è N√£o foi poss√≠vel buscar dados atualizados do Firestore');
                            }
                        }
                    }
                    
                    if (userData && userData.unidadeId && userData.status === 'approved') {
                        // Usu√°rio j√° tem unidade aprovada, fazer login direto
                        const unidadeData = await carregarUnidadeFirestore(userData.unidadeId);
                        
                        // Solicitar acesso ao Drive apenas para dados dos membros
                        try {
                            await solicitarAcessoDrive();
                        } catch (e) {
                            console.warn("Acesso ao Drive n√£o dispon√≠vel (n√£o cr√≠tico para login)");
                        }
                        
                        // Salvar no localStorage para compatibilidade
                        localStorage.setItem(`user_${user.uid}`, JSON.stringify(userData));
                        if (unidadeData) {
                            localStorage.setItem(`unidade_${user.uid}`, JSON.stringify(unidadeData));
                        }
                        
                        onAuthSuccess({ 
                            user, 
                            unidadeId: userData.unidadeId, 
                            role: userData.role,
                            driveFolderId: unidadeData?.driveFolderId || userData.unidadeId
                        });
                        setLoading(false);
                        return;
                    }
                    
                    // Se n√£o tem unidade, buscar unidades dispon√≠veis e mostrar tela de sele√ß√£o
                    const unidades = await buscarUnidadesDisponiveis();
                    setAvailableUnits(unidades);
                    setLoggedInUser(user);
                    setLoading(false);
                } catch (e) {
                    console.error('Erro ao processar login:', e);
                    setError('Erro ao carregar unidades. Tente novamente.');
                    setLoading(false);
                }
            };

            const handleRegister = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    // Criar usu√°rio no Firebase Auth
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    console.log('‚úÖ Cadastro realizado. UID:', user.uid, 'Email:', user.email);
                    
                    // Salvar dados do usu√°rio no Firestore
                    const userData = {
                        id: user.uid,
                        email: user.email,
                        nome: email.split('@')[0],
                        status: 'pending',
                        criadoEm: new Date().toISOString()
                    };
                    
                    await salvarUsuarioFirestore(user.uid, userData);
                    
                    // Criar objeto compat√≠vel
                    const userObj = {
                        uid: user.uid,
                        email: user.email,
                        displayName: email.split('@')[0]
                    };
                    
                    // Salvar no localStorage para compatibilidade
                    localStorage.setItem(`user_${user.uid}`, JSON.stringify(userData));
                    
                    // Processar login (buscar unidades)
                    await processarLoginSucesso(userObj);
                } catch (e) {
                    console.error('Erro ao criar conta:', e);
                    if (e.code === 'auth/email-already-in-use') {
                        setError('Este email j√° est√° cadastrado. Fa√ßa login em vez de cadastrar.');
                    } else if (e.code === 'auth/weak-password') {
                        setError('A senha deve ter pelo menos 6 caracteres.');
                    } else if (e.code === 'auth/invalid-email') {
                        setError('Email inv√°lido.');
                    } else if (e.code === 'auth/network-request-failed') {
                        setError('Erro de conex√£o. Verifique sua internet e tente novamente.');
                    } else {
                        setError(`Erro ao criar conta: ${e.message || 'Tente novamente.'}`);
                    }
                    setLoading(false);
                }
            };


            const handleGoogleLogin = async () => {
                setError('');
                setLoading(true);
                
                try {
                    console.log('üîÑ Iniciando login com Google...');
                    const provider = new GoogleAuthProvider();
                    provider.addScope('email');
                    provider.addScope('profile');
                    
                    console.log('üì± Abrindo popup do Google...');
                    const userCredential = await signInWithPopup(auth, provider);
                    const user = userCredential.user;
                    
                    console.log('‚úÖ Login com Google realizado. UID:', user.uid, 'Email:', user.email);
                    console.log('üìã Modo atual:', mode);
                    
                    // Se estiver na aba "Criar Unidade", criar unidade diretamente
                    if (mode === 'createUnit') {
                        console.log('üìù Modo "Criar Unidade" - criando unidade diretamente');
                        
                        // Limpar qualquer token pendente do localStorage (n√£o √© necess√°rio para criar unidade)
                        localStorage.removeItem('pending_invite_token');
                        
                        // Se n√£o tiver nome da unidade preenchido, mostrar modal
                        if (!unidadeNome.trim()) {
                            setPendingGoogleUser(user);
                            setShowUnidadeModal(true);
                            setLoading(false);
                            return;
                        }
                        
                        // Criar unidade com nome j√° preenchido
                        try {
                            await criarUnidadeComGoogle(user, unidadeNome.trim());
                        } catch (e) {
                            console.error('Erro ao criar unidade:', e);
                            setError('Erro ao criar unidade. Tente novamente.');
                            await signOut(auth);
                        }
                        setLoading(false);
                        return;
                    }
                    
                    // Se estiver na aba "Entrar" ou "Cadastrar", processar login normalmente
                    console.log('üîç Modo "Entrar/Cadastrar" - Processando login...');
                    await processarLoginSucesso(user);
                    
                } catch (e) {
                    console.error('Erro ao fazer login com Google:', e);
                    console.error('Detalhes do erro:', e.code, e.message, e.stack);
                    let errorMsg = '';
                    
                    if (e.code === 'auth/popup-closed-by-user') {
                        errorMsg = 'Login cancelado. Por favor, clique novamente e complete o login com Google.';
                    } else if (e.code === 'auth/popup-blocked') {
                        errorMsg = 'Popup bloqueado. Permita popups para este site e tente novamente.';
                    } else if (e.code === 'auth/operation-not-allowed') {
                        errorMsg = 'Login com Google n√£o est√° habilitado no Firebase.\n\n' +
                            'Para habilitar:\n' +
                            '1. Acesse: https://console.firebase.google.com/\n' +
                            '2. Selecione o projeto: sacramental-novo\n' +
                            '3. V√° em: Authentication > Sign-in method\n' +
                            '4. Clique em "Google" e ative o provedor\n' +
                            '5. Configure o email de suporte\n' +
                            '6. Salve as altera√ß√µes';
                    } else if (e.code === 'auth/unauthorized-domain') {
                        errorMsg = 'Dom√≠nio n√£o autorizado.\n\n' +
                            'Para autorizar:\n' +
                            '1. Firebase Console > Authentication > Settings > Authorized domains\n' +
                            '2. Adicione: arielbrandao25.github.io\n' +
                            '3. Adicione: localhost (para testes)\n\n' +
                            'Tamb√©m configure no Google Cloud Console:\n' +
                            '1. APIs & Services > Credentials > OAuth 2.0 Client ID\n' +
                            '2. Adicione em "Authorized JavaScript origins":\n' +
                            '   - https://arielbrandao25.github.io\n' +
                            '   - http://arielbrandao25.github.io\n' +
                            '3. Adicione em "Authorized redirect URIs":\n' +
                            '   - https://arielbrandao25.github.io\n' +
                            '   - http://arielbrandao25.github.io';
                    } else if (e.code === 'auth/network-request-failed') {
                        errorMsg = 'Erro de conex√£o. Verifique sua internet e tente novamente.';
                    } else if (e.message && (e.message.includes('OAuth client was not found') || e.message.includes('invalid_client'))) {
                        errorMsg = 'Client ID do OAuth n√£o encontrado ou inv√°lido.\n\n' +
                            'Verifique no Google Cloud Console:\n' +
                            '1. Acesse: https://console.cloud.google.com/\n' +
                            '2. Projeto: sacramental-novo\n' +
                            '3. APIs & Services > Credentials\n' +
                            '4. Verifique se existe um OAuth 2.0 Client ID do tipo "Web application"\n' +
                            '5. Verifique se as "Authorized JavaScript origins" incluem:\n' +
                            '   - https://arielbrandao25.github.io\n' +
                            '   - http://arielbrandao25.github.io\n' +
                            '   - http://localhost\n' +
                            '6. Verifique se as "Authorized redirect URIs" incluem:\n' +
                            '   - https://arielbrandao25.github.io\n' +
                            '   - http://arielbrandao25.github.io\n' +
                            '7. Verifique se o OAuth Consent Screen est√° configurado';
                    } else {
                        errorMsg = `Erro: ${e.message || e.code || 'Tente novamente.'}\n\n` +
                            'Se o problema persistir, verifique:\n' +
                            '- Firebase Console > Authentication > Sign-in method (Google deve estar ativo)\n' +
                            '- Google Cloud Console > OAuth Consent Screen (deve estar configurado)\n' +
                            '- Google Cloud Console > Credentials (OAuth Client ID deve existir)';
                    }
                    
                    setError(errorMsg);
                } finally {
                    // Sempre desativar loading, mesmo se houver erro n√£o capturado
                    setLoading(false);
                    console.log('‚úÖ Loading desativado ap√≥s login');
                }
            };

            const handleCreateUnit = async (e) => {
                e.preventDefault();
                if (!unidadeNome.trim()) {
                    setError('Nome da unidade √© obrigat√≥rio.');
                    return;
                }
                setLoading(true);
                setError('');
                try {
                    // Verificar se o usu√°rio est√° logado
                    const currentUser = auth.currentUser;
                    if (!currentUser) {
                        setError('Voc√™ precisa estar logado para criar uma unidade. Fa√ßa login primeiro.');
                        setLoading(false);
                        return;
                    }
                    
                    // Criar objeto compat√≠vel
                    const userObj = {
                        uid: currentUser.uid,
                        email: currentUser.email,
                        displayName: currentUser.displayName || currentUser.email?.split('@')[0]
                    };
                    
                    await criarUnidadeComGoogle(userObj, unidadeNome.trim());
                } catch (e) {
                    console.error('Erro ao criar unidade:', e);
                    setError('Erro ao criar unidade. Tente novamente.');
                    setLoading(false);
                }
            };

            const criarUnidadeComGoogle = async (user, nomeUnidade) => {
                try {
                    console.log('üìù Iniciando cria√ß√£o de unidade:', nomeUnidade);
                    
                    // Criar ID √∫nico para a unidade
                    const unidadeId = `unidade_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    
                    // Criar pasta no Drive para dados dos membros (opcional, pode falhar sem bloquear)
                    let folderId = null;
                    try {
                        await solicitarAcessoDrive();
                        console.log('üìÅ Criando pasta no Drive para dados dos membros...');
                        folderId = await criarPastaUnidadeDrive(nomeUnidade);
                        console.log('‚úÖ Pasta criada no Drive:', folderId);
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Erro ao criar pasta no Drive (n√£o cr√≠tico):', e);
                        // Continuar mesmo se falhar - Drive √© apenas para dados dos membros
                    }
                    
                    // Salvar informa√ß√µes da unidade no Firestore
                    const unidadeData = {
                        id: unidadeId,
                        nome: nomeUnidade,
                        criadoPor: user.uid,
                        criadoEm: new Date().toISOString(),
                        adminEmail: user.email,
                        driveFolderId: folderId || unidadeId // Usar unidadeId como fallback
                    };
                    
                    console.log('üíæ Salvando unidade no Firestore...');
                    console.log('   - Dados da unidade:', JSON.stringify(unidadeData, null, 2));
                    const savedUnidadeId = await salvarUnidadeFirestore(unidadeData);
                    console.log('‚úÖ Unidade salva no Firestore com ID:', savedUnidadeId);
                    console.log('   - A unidade agora est√° dispon√≠vel para outros usu√°rios solicitarem acesso');
                    
                    // Salvar dados do admin no Firestore
                    const adminUserData = {
                        id: user.uid,
                        email: user.email,
                        unidadeId: unidadeId,
                        role: 'admin',
                        status: 'approved',
                        nome: user.displayName || user.email.split('@')[0],
                        criadoEm: new Date().toISOString(),
                        criadoPor: 'admin'
                    };
                    
                    console.log('üíæ Salvando dados do admin no Firestore...');
                    await salvarUsuarioFirestore(user.uid, adminUserData);
                    console.log('‚úÖ Dados do admin salvos no Firestore');
                    
                    // Salvar no localStorage para compatibilidade
                    localStorage.setItem(`unidade_${user.uid}`, JSON.stringify(unidadeData));
                    localStorage.setItem(`user_${user.uid}`, JSON.stringify(adminUserData));
                    
                    console.log('‚úÖ Dados salvos no localStorage');
                    console.log('‚úÖ Chamando onAuthSuccess...');
                    onAuthSuccess({ user, unidadeId: unidadeId, role: 'admin', driveFolderId: folderId || unidadeId });
                } catch (e) {
                    console.error('‚ùå Erro ao criar unidade:', e);
                    let errorMessage = 'Erro ao criar unidade. ';
                    
                    if (e.message && e.message.includes('Drive')) {
                        errorMessage += 'Verifique se voc√™ concedeu acesso ao Google Drive.';
                    } else if (e.message && e.message.includes('permission')) {
                        errorMessage += 'Voc√™ precisa conceder permiss√£o para criar pastas no Google Drive.';
                    } else {
                        errorMessage += 'Tente novamente. Se o problema persistir, verifique sua conex√£o com a internet.';
                    }
                    
                    setError(errorMessage);
                    try {
                        await signOut(auth);
                    } catch (signOutError) {
                        console.warn('Erro ao fazer logout:', signOutError);
                    }
                    throw e; // Re-lan√ßar para ser capturado pelo chamador
                }
            };

            const handleConfirmUnidadeNome = async () => {
                if (!tempUnidadeNome.trim()) {
                    setError('Nome da unidade √© obrigat√≥rio.');
                    return;
                }
                
                if (pendingGoogleUser) {
                    setLoading(true);
                    setError('');
                    setUnidadeNome(tempUnidadeNome.trim());
                    setShowUnidadeModal(false);
                    
                    try {
                        await criarUnidadeComGoogle(pendingGoogleUser, tempUnidadeNome.trim());
                        setPendingGoogleUser(null);
                        setTempUnidadeNome('');
                    } catch (e) {
                        console.error('Erro ao criar unidade pelo modal:', e);
                        // Erro j√° foi tratado em criarUnidadeComGoogle
                    } finally {
                        setLoading(false);
                    }
                }
            };

            return (
                <div className="flex justify-center items-center min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 p-4">
                    <div className="w-full max-w-md bg-white rounded-2xl shadow-2xl border border-gray-200 p-6">
                        <div className="text-center mb-6">
                            <h1 className="text-3xl font-bold text-gray-900 font-serif mb-2">Sacramental LDS</h1>
                            <p className="text-gray-600">Sistema de Planejamento Sacramental</p>
                        </div>
                        
                        <div className="flex bg-gray-100 p-1 rounded-xl mb-4">
                            <button
                                onClick={() => { setMode('login'); setError(''); }}
                                className={`flex-1 py-2 rounded-lg font-semibold transition-all ${
                                    mode === 'login' 
                                        ? 'bg-white shadow-md text-blue-900' 
                                        : 'text-gray-600'
                                }`}
                            >
                                Entrar
                            </button>
                            <button
                                onClick={() => { setMode('createUnit'); setError(''); }}
                                className={`flex-1 py-2 rounded-lg font-semibold transition-all ${
                                    mode === 'createUnit' 
                                        ? 'bg-white shadow-md text-blue-900' 
                                        : 'text-gray-600'
                                }`}
                            >
                                Criar Unidade
                            </button>
                        </div>

                        {error && (
                            <div className="bg-red-50 border-2 border-red-200 text-red-800 p-3 rounded-xl mb-4 text-sm">
                                {error}
                            </div>
                        )}
                        
                        {success && (
                            <div className="bg-green-50 border-2 border-green-200 text-green-800 p-3 rounded-xl mb-4 text-sm">
                                {success}
                            </div>
                        )}
                        
                        <form onSubmit={mode === 'login' ? handleLogin : (mode === 'register' ? handleRegister : handleCreateUnit)} className="space-y-4">
                            {mode === 'createUnit' && (
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">Nome da Unidade</label>
                                    <input
                                        type="text"
                                        value={unidadeNome}
                                        onChange={e => setUnidadeNome(e.target.value)}
                                        placeholder="Ex: Ala Centro, Estaca Sul"
                                        className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-all"
                                        required
                                    />
                                </div>
                            )}
                            
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={e => setEmail(e.target.value)}
                                    placeholder="seu@email.com"
                                    className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-all"
                                    required
                                />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">Senha</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={e => setPassword(e.target.value)}
                                    placeholder="M√≠nimo 6 caracteres"
                                    className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-all"
                                    required
                                    minLength={6}
                                />
                            </div>
                            
                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 rounded-xl font-bold shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {loading ? 'Processando...' : (mode === 'login' ? 'Entrar' : (mode === 'register' ? 'Cadastrar' : 'Criar Unidade'))}
                            </button>
                        </form>

                        <div className="relative my-6">
                            <div className="absolute inset-0 flex items-center">
                                <div className="w-full border-t border-gray-300"></div>
                            </div>
                            <div className="relative flex justify-center text-sm">
                                <span className="px-2 bg-white text-gray-500">ou</span>
                            </div>
                        </div>

                        <button
                            onClick={handleGoogleLogin}
                            disabled={loading}
                            className="w-full bg-white border-2 border-gray-300 text-gray-700 p-4 rounded-xl font-semibold shadow-md hover:shadow-lg hover:scale-[1.02] transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3"
                        >
                            <svg className="w-5 h-5" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            {loading ? 'Processando...' : `Continuar com Google`}
                        </button>
                        
                        {mode === 'createUnit' && (
                            <p className="text-xs text-gray-500 mt-4 text-center">
                                Ao criar uma unidade, voc√™ ser√° o respons√°vel e poder√° autorizar outros usu√°rios.
                            </p>
                        )}
                        
                        {mode === 'login' && (
                            <p className="text-xs text-gray-500 mt-4 text-center">
                                N√£o tem conta? <button type="button" onClick={() => setMode('register')} className="text-blue-600 hover:underline font-semibold">Cadastre-se</button>
                            </p>
                        )}
                        
                        {mode === 'register' && (
                            <p className="text-xs text-gray-500 mt-4 text-center">
                                J√° tem conta? <button type="button" onClick={() => setMode('login')} className="text-blue-600 hover:underline font-semibold">Fa√ßa login</button>
                            </p>
                        )}
                    </div>

                    {/* Tela de sele√ß√£o de unidades */}
                    {loggedInUser && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                            <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl border border-gray-200 p-6 animate-slide-up max-h-[90vh] overflow-y-auto">
                                <h3 className="text-xl font-bold text-gray-900 mb-2">Selecione uma Unidade</h3>
                                <p className="text-sm text-gray-600 mb-4">
                                    Escolha a unidade que deseja acessar. Uma solicita√ß√£o ser√° enviada ao administrador.
                                </p>
                                
                                {error && (
                                    <div className="bg-red-50 border-2 border-red-200 text-red-800 p-3 rounded-xl mb-4 text-sm">
                                        {error}
                                    </div>
                                )}
                                
                                {success && (
                                    <div className="bg-green-50 border-2 border-green-200 text-green-800 p-3 rounded-xl mb-4 text-sm">
                                        {success}
                                    </div>
                                )}
                                
                                {loading && (
                                    <div className="text-center py-4">
                                        <p className="text-gray-600">Carregando unidades...</p>
                                    </div>
                                )}
                                
                                {!loading && availableUnits.length === 0 && (
                                    <div className="text-center py-8">
                                        <Users size={48} className="mx-auto text-gray-400 mb-4" />
                                        <p className="text-gray-700 font-semibold mb-2">Nenhuma unidade encontrada</p>
                                        <p className="text-sm text-gray-500 mb-4">
                                            N√£o h√° unidades cadastradas no sistema ou voc√™ n√£o tem permiss√£o para visualiz√°-las.
                                        </p>
                                        <div className="space-y-2">
                                            <button
                                                onClick={() => {
                                                    setLoggedInUser(null);
                                                    setAvailableUnits([]);
                                                    setMode('createUnit');
                                                }}
                                                className="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white px-4 py-2 rounded-xl font-semibold hover:shadow-lg transition-all"
                                            >
                                                Criar Nova Unidade
                                            </button>
                                            <button
                                                onClick={async () => {
                                                    setLoading(true);
                                                    const unidades = await buscarUnidadesDisponiveis();
                                                    setAvailableUnits(unidades);
                                                    setLoading(false);
                                                }}
                                                className="w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-xl font-semibold hover:bg-gray-200 transition-all"
                                            >
                                                Tentar Novamente
                                            </button>
                                        </div>
                                    </div>
                                )}
                                
                                {!loading && availableUnits.length > 0 && (
                                    <div className="space-y-3 mb-4">
                                        {availableUnits.map(unidade => (
                                            <button
                                                key={unidade.id}
                                                onClick={() => solicitarAcessoUnidade(unidade)}
                                                disabled={loading}
                                                className="w-full text-left p-4 border-2 border-gray-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                            >
                                                <div className="flex items-center justify-between">
                                                    <div>
                                                        <p className="font-semibold text-gray-900">{unidade.nome}</p>
                                                        {unidade.adminEmail && (
                                                            <p className="text-xs text-gray-500 mt-1">Admin: {unidade.adminEmail}</p>
                                                        )}
                                                    </div>
                                                    <ChevronRight size={20} className="text-gray-400" />
                                                </div>
                                            </button>
                                        ))}
                                    </div>
                                )}
                                
                                <div className="flex gap-3 mt-4">
                                    <button
                                        onClick={async () => {
                                            setLoggedInUser(null);
                                            setAvailableUnits([]);
                                            setError('');
                                            setSuccess('');
                                            try {
                                                await signOut(auth);
                                            } catch (e) {
                                                console.warn('Erro ao fazer logout:', e);
                                            }
                                        }}
                                        className="flex-1 bg-gray-200 text-gray-700 p-3 rounded-xl font-semibold hover:bg-gray-300 transition-all"
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        onClick={() => {
                                            setLoggedInUser(null);
                                            setAvailableUnits([]);
                                            setMode('createUnit');
                                        }}
                                        className="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 text-white p-3 rounded-xl font-semibold hover:shadow-lg transition-all"
                                    >
                                        Criar Nova Unidade
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Modal para nome da unidade ap√≥s login com Google */}
                    {showUnidadeModal && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                            <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl border border-gray-200 p-6 animate-slide-up">
                                <h3 className="text-xl font-bold text-gray-900 mb-2">Nome da Unidade</h3>
                                <p className="text-sm text-gray-600 mb-4">
                                    Por favor, informe o nome da sua unidade para continuar:
                                </p>
                                <input
                                    type="text"
                                    value={tempUnidadeNome}
                                    onChange={e => setTempUnidadeNome(e.target.value)}
                                    placeholder="Ex: Ala Centro, Estaca Sul"
                                    className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-all mb-4"
                                    autoFocus
                                    onKeyPress={e => {
                                        if (e.key === 'Enter') {
                                            handleConfirmUnidadeNome();
                                        }
                                    }}
                                />
                                <div className="flex gap-3">
                                    <button
                                        onClick={async () => {
                                            setShowUnidadeModal(false);
                                            setPendingGoogleUser(null);
                                            setTempUnidadeNome('');
                                            try {
                                                await signOut(auth);
                                            } catch (e) {
                                                console.warn('Erro ao fazer logout:', e);
                                            }
                                        }}
                                        className="flex-1 bg-gray-200 text-gray-700 p-3 rounded-xl font-semibold hover:bg-gray-300 transition-all"
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        onClick={handleConfirmUnidadeNome}
                                        disabled={!tempUnidadeNome.trim()}
                                        className="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 text-white p-3 rounded-xl font-semibold hover:shadow-lg hover:scale-105 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        Continuar
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function PlanejadorSacramental() {
            const [authData, setAuthData] = useState(null); // { user, unidadeId, role }
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('agenda');
            const [currentDate, setCurrentDate] = useState(new Date());
            
            // Dados
            const [members, setMembers] = useState([]);
            const [assignments, setAssignments] = useState([]);
            const [attendance, setAttendance] = useState([]);
            const [availableCallings, setAvailableCallings] = useState([]);
            const [selectedAssignmentId, setSelectedAssignmentId] = useState(null);
            const [unidadeInfo, setUnidadeInfo] = useState(null);
            const [unidadeUsers, setUnidadeUsers] = useState([]);
            const [pendingRequestsCount, setPendingRequestsCount] = useState(0);

            // UI Global
            const [showUserMenu, setShowUserMenu] = useState(false);
            const [showCallingManager, setShowCallingManager] = useState(false);
            const [showUserManager, setShowUserManager] = useState(false);
            const [showSettings, setShowSettings] = useState(false);


            // Auth - usar Firebase onAuthStateChanged
            useEffect(() => {
                const overlay = document.getElementById('loading-overlay');
                
                // Listener para mudan√ßas no Firebase Auth
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (!user) {
                        setAuthData(null);
                        setLoading(false);
                        if(overlay) overlay.style.display = 'none';
                        return;
                    }
                    
                    try {
                        // Buscar dados do usu√°rio (priorizar localStorage se offline)
                        let userData = null;
                        
                        // Primeiro tentar localStorage (mais r√°pido e funciona offline)
                        const userDataStr = localStorage.getItem(`user_${user.uid}`);
                        if (userDataStr) {
                            try {
                                userData = JSON.parse(userDataStr);
                            } catch (e) {
                                console.error("Erro ao parsear dados do usu√°rio:", e);
                            }
                        }
                        
                        // Se n√£o encontrou no localStorage, tentar Firestore
                        if (!userData) {
                            try {
                                userData = await carregarUsuarioFirestore(user.uid);
                                // Se encontrou no Firestore, salvar no localStorage
                                if (userData) {
                                    localStorage.setItem(`user_${user.uid}`, JSON.stringify(userData));
                                }
                            } catch (e) {
                                // Se erro, usar dados do Firebase Auth
                                userData = {
                                    id: user.uid,
                                    email: user.email,
                                    nome: user.displayName || user.email?.split('@')[0],
                                };
                            }
                        }
                        
                        if (userData && userData.unidadeId) {
                            // Buscar info da unidade (priorizar localStorage se offline)
                            let unidadeData = null;
                            
                            // Primeiro tentar localStorage
                            const unidadeDataStr = localStorage.getItem(`unidade_${user.uid}`);
                            if (unidadeDataStr) {
                                try {
                                    unidadeData = JSON.parse(unidadeDataStr);
                                } catch (e) {
                                    console.error("Erro ao parsear dados da unidade:", e);
                                }
                            }
                            
                            // Se n√£o encontrou no localStorage, tentar Firestore
                            if (!unidadeData) {
                                try {
                                    unidadeData = await carregarUnidadeFirestore(userData.unidadeId);
                                    // Se encontrou no Firestore, salvar no localStorage
                                    if (unidadeData) {
                                        localStorage.setItem(`unidade_${user.uid}`, JSON.stringify(unidadeData));
                                    }
                                } catch (e) {
                                    console.warn("Erro ao buscar unidade do Firestore:", e);
                                }
                            }
                            
                            if (unidadeData) {
                                setUnidadeInfo(unidadeData);
                            }
                            
                            // Solicitar acesso ao Drive apenas para dados dos membros (n√£o cr√≠tico)
                            try {
                                await solicitarAcessoDrive();
                            } catch (e) {
                                console.warn("Acesso ao Drive n√£o dispon√≠vel (n√£o cr√≠tico para login)");
                            }
                            
                            // Salvar no localStorage para compatibilidade
                            try {
                                localStorage.setItem(`user_${user.uid}`, JSON.stringify(userData));
                                if (unidadeData) {
                                    localStorage.setItem(`unidade_${user.uid}`, JSON.stringify(unidadeData));
                                }
                            } catch (e) {
                                console.warn("Erro ao salvar no localStorage:", e);
                            }
                            
                            // Criar objeto user compat√≠vel
                            const userObj = {
                                uid: user.uid,
                                email: user.email,
                                displayName: user.displayName || userData.nome || user.email?.split('@')[0]
                            };
                            
                            setAuthData({ 
                                user: userObj, 
                                unidadeId: userData.unidadeId, 
                                role: userData.role,
                                driveFolderId: unidadeData?.driveFolderId || userData.unidadeId,
                                status: userData.status || 'approved'
                            });
                        } else {
                            setAuthData(null);
                        }
                    } catch (e) {
                        console.error("Erro geral ao buscar dados do usu√°rio:", e);
                        setAuthData(null);
                    } finally {
                        setLoading(false);
                        if(overlay) overlay.style.display = 'none';
                    }
                });
                
                // Cleanup ao desmontar o componente
                return () => unsubscribe();
            }, []);

            // Buscar info da unidade e usu√°rios (do localStorage e Drive)
            useEffect(() => {
                if (!authData?.unidadeId) return;
                
                const loadUsers = async () => {
                    // Buscar info da unidade do Firestore
                    try {
                        const unidadeData = await carregarUnidadeFirestore(authData.unidadeId);
                        if (unidadeData) {
                            setUnidadeInfo(unidadeData);
                            // Salvar no localStorage para compatibilidade
                            localStorage.setItem(`unidade_${authData.user.uid}`, JSON.stringify(unidadeData));
                        } else {
                            // Fallback: buscar do localStorage
                            const unidadeDataStr = localStorage.getItem(`unidade_${authData.user.uid}`);
                            if (unidadeDataStr) {
                                const unidadeData = JSON.parse(unidadeDataStr);
                                setUnidadeInfo(unidadeData);
                            }
                        }
                    } catch (e) {
                        console.warn("Erro ao carregar unidade do Firestore:", e);
                    }
                    
                    // Buscar usu√°rios da unidade do Firestore
                    try {
                        const firestoreUsers = await buscarUsuariosUnidadeFirestore(authData.unidadeId);
                        setUnidadeUsers(firestoreUsers);
                        console.log(`‚úÖ ${firestoreUsers.length} usu√°rios encontrados no Firestore`);
                    } catch (e) {
                        console.error("Erro ao buscar usu√°rios do Firestore:", e);
                        // Fallback: buscar do localStorage
                        const allUsers = [];
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key && key.startsWith('user_')) {
                                try {
                                    const userData = JSON.parse(localStorage.getItem(key));
                                    if (userData.unidadeId === authData.unidadeId) {
                                        allUsers.push({ id: key.replace('user_', ''), ...userData });
                                    }
                                } catch (e) {
                                    // Ignorar erros de parsing
                                }
                            }
                        }
                        setUnidadeUsers(allUsers);
                    }
                    
                    // Buscar solicita√ß√µes pendentes (apenas para admins)
                    if (authData.role === 'admin') {
                        try {
                            const requests = await buscarSolicitacoesPendentesFirestore(authData.unidadeId);
                            setPendingRequestsCount(requests.length);
                            console.log(`‚úÖ ${requests.length} solicita√ß√µes pendentes encontradas`);
                        } catch (e) {
                            console.warn("Erro ao buscar solicita√ß√µes pendentes:", e);
                            setPendingRequestsCount(0);
                        }
                    }
                };
                
                loadUsers();
            }, [authData?.unidadeId, authData?.driveFolderId]);

            // Sincroniza√ß√£o em tempo real com Firestore
            useEffect(() => {
                if (!authData?.unidadeId || !db) return;
                
                const unidadeId = authData.unidadeId;
                let unsubscribeMembers = null;
                let unsubscribeAssignments = null;
                let unsubscribeAttendance = null;
                let unsubscribeCallings = null;
                
                try {
                    // Listener para membros (sincroniza√ß√£o em tempo real)
                    const membersRef = collection(db, 'unidades', unidadeId, 'membros');
                    unsubscribeMembers = onSnapshot(membersRef, (snapshot) => {
                        const membersData = [];
                        snapshot.forEach((doc) => {
                            membersData.push({ id: doc.id, ...doc.data() });
                        });
                        const sorted = membersData.sort((a,b) => (a.name || '').localeCompare(b.name || ''));
                        setMembers(sorted);
                        console.log(`‚úÖ ${sorted.length} membros sincronizados em tempo real`);
                        
                        // Backup no localStorage
                        localStorage.setItem(`members_${unidadeId}`, JSON.stringify(sorted));
                    }, (error) => {
                        console.error('Erro no listener de membros:', error);
                        // Fallback: carregar do localStorage
                        const cached = JSON.parse(localStorage.getItem(`members_${unidadeId}`) || '[]');
                        if (cached.length > 0) {
                            setMembers(cached);
                        }
                    });
                    
                    // Listener para assignments (sincroniza√ß√£o em tempo real)
                    const assignmentsRef = collection(db, 'unidades', unidadeId, 'assignments');
                    unsubscribeAssignments = onSnapshot(assignmentsRef, (snapshot) => {
                        const assignmentsData = [];
                        snapshot.forEach((doc) => {
                            const data = { id: doc.id, ...doc.data() };
                            assignmentsData.push(data);
                        });
                        setAssignments(assignmentsData);
                        console.log(`‚úÖ ${assignmentsData.length} assignments sincronizados em tempo real`);
                    }, (error) => {
                        console.error('Erro no listener de assignments:', error);
                    });
                    
                    // Listener para attendance (sincroniza√ß√£o em tempo real)
                    const attendanceRef = collection(db, 'unidades', unidadeId, 'attendance');
                    console.log('üîå Configurando listener de attendance para unidade:', unidadeId);
                    
                    unsubscribeAttendance = onSnapshot(
                        attendanceRef, 
                        (snapshot) => {
                            const attendanceData = [];
                            snapshot.forEach((doc) => {
                                const docData = doc.data();
                                const data = { 
                                    id: doc.id, 
                                    date: docData.date || doc.id,
                                    attendees: docData.attendees || [],
                                    count: docData.count || (docData.attendees?.length || 0),
                                    ...docData 
                                };
                                attendanceData.push(data);
                            });
                            
                            // Ordenar por data (mais recente primeiro)
                            attendanceData.sort((a, b) => {
                                const dateA = a.date || a.id || '';
                                const dateB = b.date || b.id || '';
                                return dateB.localeCompare(dateA);
                            });
                            
                            console.log(`üîÑ Listener de attendance acionado: ${attendanceData.length} registros`);
                            console.log('üìä Dados de attendance recebidos:', attendanceData);
                            
                            setAttendance(attendanceData);
                            
                            // Atualizar cache do localStorage
                            localStorage.setItem(`attendance_${unidadeId}`, JSON.stringify(attendanceData));
                            console.log(`‚úÖ ${attendanceData.length} attendance sincronizados em tempo real e salvos no cache`);
                        }, 
                        (error) => {
                            console.error('‚ùå Erro no listener de attendance:', error);
                            console.error('‚ùå Detalhes do erro:', error.code, error.message);
                            
                            // Fallback: tentar carregar do localStorage
                            const cached = JSON.parse(localStorage.getItem(`attendance_${unidadeId}`) || '[]');
                            if (cached.length > 0) {
                                console.warn('‚ö†Ô∏è Usando cache do localStorage para attendance:', cached.length, 'registros');
                                setAttendance(cached);
                            } else {
                                console.warn('‚ö†Ô∏è Nenhum dado de attendance encontrado no cache');
                            }
                        }
                    );
                    
                    // Carregar dados iniciais do localStorage enquanto o listener n√£o carrega
                    const cachedAttendance = JSON.parse(localStorage.getItem(`attendance_${unidadeId}`) || '[]');
                    if (cachedAttendance.length > 0) {
                        console.log('üì¶ Carregando attendance do cache inicial:', cachedAttendance.length, 'registros');
                        setAttendance(cachedAttendance);
                    } else {
                        console.log('üì¶ Nenhum dado de attendance no cache inicial');
                    }
                    
                    // Listener para chamados (sincroniza√ß√£o em tempo real)
                    const callingsRef = collection(db, 'unidades', unidadeId, 'chamados');
                    unsubscribeCallings = onSnapshot(callingsRef, (snapshot) => {
                        const callingsData = [];
                        snapshot.forEach((doc) => {
                            callingsData.push({ id: doc.id, ...doc.data() });
                        });
                        const sorted = callingsData.sort((a,b) => (a.name || '').localeCompare(b.name || ''));
                        setAvailableCallings(sorted);
                        console.log(`‚úÖ ${sorted.length} chamados sincronizados em tempo real`);
                    }, (error) => {
                        console.error('Erro no listener de chamados:', error);
                        // Fallback: tentar carregar do Drive
                        if (authData.driveFolderId) {
                            listarArquivosDrive(authData.driveFolderId, 'calling_').then(callingsData => {
                                const sorted = callingsData.sort((a,b) => (a.name || '').localeCompare(b.name || ''));
                                setAvailableCallings(sorted);
                            }).catch(e => {
                                console.warn("Erro ao carregar callings do Drive:", e);
                            });
                        }
                    });
                } catch (e) {
                    console.error("Erro ao configurar listeners do Firestore:", e);
                    // Fallback: tentar carregar do Drive
                    if (authData.driveFolderId) {
                        const folderId = authData.driveFolderId;
                        listarArquivosDrive(folderId, 'member_').then(membersData => {
                            const sorted = membersData.sort((a,b) => (a.name || '').localeCompare(b.name || ''));
                            setMembers(sorted);
                        }).catch(e => console.error("Erro ao carregar membros do Drive:", e));
                    }
                }
                
                return () => {
                    if (unsubscribeMembers) unsubscribeMembers();
                    if (unsubscribeAssignments) unsubscribeAssignments();
                    if (unsubscribeAttendance) unsubscribeAttendance();
                    if (unsubscribeCallings) unsubscribeCallings();
                };
            }, [authData?.unidadeId, authData?.driveFolderId]);

            // Fun√ß√µes de Data
            const getSundaysInMonth = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const sundays = [];
                const d = new Date(year, month, 1);
                while (d.getDay() !== 0) d.setDate(d.getDate() + 1);
                while (d.getMonth() === month) {
                    sundays.push(new Date(d));
                    d.setDate(d.getDate() + 7);
                }
                return sundays;
            };
            const currentSundays = useMemo(() => getSundaysInMonth(currentDate), [currentDate]);
            const changeMonth = (delta) => {
                const d = new Date(currentDate);
                d.setMonth(d.getMonth() + delta);
                setCurrentDate(d);
            };

            const handleShare = async () => {
                const url = window.location.href;
                if (navigator.share) {
                    try { await navigator.share({ title: 'Sacramental', url }); setShowUserMenu(false); return; } catch (e) {}
                }
                prompt("Copie o link:", url);
                setShowUserMenu(false);
            };

            const handleDeleteUser = async () => {
                if (!authData?.user) return;
                
                const confirmMessage = `Tem certeza que deseja excluir sua conta?\n\n` +
                    `Esta a√ß√£o √© IRREVERS√çVEL e ir√°:\n` +
                    `- Excluir sua conta do Firebase\n` +
                    `- Excluir seus dados do Firestore\n` +
                    `- Remover todos os dados locais\n\n` +
                    `Digite "EXCLUIR" para confirmar:`;
                
                const userInput = prompt(confirmMessage);
                
                if (userInput !== 'EXCLUIR') {
                    return;
                }
                
                const secondConfirm = confirm('‚ö†Ô∏è √öLTIMA CONFIRMA√á√ÉO!\n\n' +
                    'Voc√™ realmente deseja excluir sua conta permanentemente?\n\n' +
                    'Esta a√ß√£o n√£o pode ser desfeita!');
                
                if (!secondConfirm) {
                    return;
                }
                
                try {
                    setLoading(true);
                    const userId = authData.user.uid;
                    
                    // 1. Excluir do Firestore
                    try {
                        const userRef = doc(db, 'usuarios', userId);
                        await deleteDoc(userRef);
                        console.log('‚úÖ Usu√°rio exclu√≠do do Firestore');
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Erro ao excluir do Firestore (continuando):', e);
                    }
                    
                    // 2. Excluir solicita√ß√µes relacionadas
                    try {
                        const solicitacoesRef = collection(db, 'solicitacoes');
                        const q = query(solicitacoesRef, where('userId', '==', userId));
                        const querySnapshot = await getDocs(q);
                        
                        const deletePromises = [];
                        querySnapshot.forEach((docSnapshot) => {
                            deletePromises.push(deleteDoc(doc(db, 'solicitacoes', docSnapshot.id)));
                        });
                        
                        await Promise.all(deletePromises);
                        console.log('‚úÖ Solicita√ß√µes exclu√≠das do Firestore');
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Erro ao excluir solicita√ß√µes (continuando):', e);
                    }
                    
                    // 3. Limpar localStorage
                    try {
                        localStorage.removeItem(`user_${userId}`);
                        localStorage.removeItem(`unidade_${userId}`);
                        // Limpar outros dados relacionados
                        for (let i = localStorage.length - 1; i >= 0; i--) {
                            const key = localStorage.key(i);
                            if (key && (key.startsWith(`user_${userId}_`) || key.includes(userId))) {
                                localStorage.removeItem(key);
                            }
                        }
                        console.log('‚úÖ Dados locais removidos');
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Erro ao limpar localStorage (continuando):', e);
                    }
                    
                    // 4. Excluir conta do Firebase Auth (deve ser o √∫ltimo)
                    try {
                        const user = auth.currentUser;
                        if (user) {
                            await deleteUser(user);
                            console.log('‚úÖ Conta exclu√≠da do Firebase Auth');
                        }
                    } catch (e) {
                        console.error('‚ùå Erro ao excluir conta do Firebase Auth:', e);
                        // Se falhar, fazer logout mesmo assim
                        await signOut(auth);
                    }
                    
                    // 5. Limpar estado e redirecionar
                    setAuthData(null);
                    alert('Conta exclu√≠da com sucesso. Voc√™ ser√° redirecionado.');
                    window.location.reload();
                    
                } catch (e) {
                    console.error('‚ùå Erro ao excluir usu√°rio:', e);
                    alert('Erro ao excluir conta: ' + (e.message || 'Tente novamente mais tarde.'));
                    setLoading(false);
                }
            };

            const handleLogout = async () => {
                try {
                    await signOut(auth);
                    setAuthData(null);
                } catch (e) {
                    console.error("Erro ao fazer logout:", e);
                }
            };

            if (loading) return null;

            // Se n√£o estiver autenticado, mostrar tela de login
            if (!authData) {
                return <AuthScreen onAuthSuccess={setAuthData} />;
            }

            return (
                <div className="flex justify-center min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50">
                    <div className="w-full max-w-md bg-white h-screen flex flex-col shadow-2xl overflow-hidden relative sm:rounded-none md:rounded-3xl md:h-[95vh] md:my-auto md:border-4 md:border-white">
                        
                        {/* Mensagem de Aprova√ß√£o Pendente */}
                        {authData?.status === 'pending' && (
                            <div className="bg-amber-50 border-b-2 border-amber-300 p-4 text-center z-20 sticky top-0">
                                <div className="flex items-center justify-center gap-2 text-amber-800">
                                    <AlertCircle size={20} />
                                    <p className="text-sm font-semibold">
                                        Sua conta est√° aguardando aprova√ß√£o do respons√°vel da unidade.
                                    </p>
                                </div>
                            </div>
                        )}
                        
                        {/* Header Modernizado */}
                        <header className={`bg-gradient-to-r from-blue-900 via-blue-800 to-purple-800 border-b border-blue-700 p-4 pt-6 z-10 sticky ${authData?.status === 'pending' ? 'top-[73px]' : 'top-0'} flex justify-between items-center shadow-lg`}>
                            <div className="animate-fade-in">
                                <h1 className="text-2xl font-bold text-white tracking-tight font-serif drop-shadow-md">Sacramental</h1>
                                <div className="flex items-center gap-1.5 text-xs text-blue-100 font-medium bg-blue-900/50 px-2.5 py-1 rounded-full w-fit mt-1.5 backdrop-blur-sm border border-blue-700/50">
                                    <Wifi size={10} className="animate-pulse" /> 
                                    <span>{unidadeInfo?.nome || 'Conectado'}</span>
                                    {authData.role === 'admin' && <span className="ml-1 px-1 bg-yellow-500 text-yellow-900 rounded text-[10px] font-bold">Admin</span>}
                                </div>
                            </div>
                            <div className="relative">
                                <button 
                                    onClick={() => setShowUserMenu(!showUserMenu)} 
                                    className="w-10 h-10 rounded-full bg-white/20 backdrop-blur-sm border border-white/30 flex items-center justify-center text-white hover:bg-white/30 transition-all shadow-lg hover:scale-110"
                                >
                                    <Users size={18} />
                                </button>
                                {showUserMenu && (
                                    <>
                                        <div className="fixed inset-0 z-40" onClick={() => setShowUserMenu(false)}></div>
                                        <div className="absolute right-0 top-12 bg-white rounded-xl shadow-2xl border border-gray-100 w-56 py-2 z-50 animate-slide-up">
                                            {authData.role === 'admin' && (
                                                <button onClick={() => { setShowUserManager(true); setShowUserMenu(false); }} className="w-full text-left px-4 py-3 text-sm text-slate-700 hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 flex items-center gap-3 transition-all relative">
                                                    <Users size={16} className="text-blue-600"/> 
                                                    Gerenciar Usu√°rios
                                                    {pendingRequestsCount > 0 && (
                                                        <span className="ml-auto bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full animate-pulse">
                                                            {pendingRequestsCount}
                                                        </span>
                                                    )}
                                                </button>
                                            )}
                                            <button onClick={handleShare} className="w-full text-left px-4 py-3 text-sm text-slate-700 hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 flex items-center gap-3 transition-all"><Share2 size={16} className="text-blue-600"/> Compartilhar</button>
                                            <button onClick={() => { setShowCallingManager(true); setShowUserMenu(false); }} className="w-full text-left px-4 py-3 text-sm text-slate-700 hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 flex items-center gap-3 transition-all"><Settings size={16} className="text-purple-600"/> Chamados</button>
                                            <button onClick={() => { setShowSettings(true); setShowUserMenu(false); }} className="w-full text-left px-4 py-3 text-sm text-slate-700 hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 flex items-center gap-3 transition-all"><Settings size={16} className="text-indigo-600"/> Configura√ß√µes</button>
                                            <div className="border-t border-gray-200 my-1"></div>
                                            <button onClick={handleLogout} className="w-full text-left px-4 py-3 text-sm text-red-600 hover:bg-red-50 flex items-center gap-3 transition-all"><LogOut size={16}/> Sair</button>
                                        </div>
                                    </>
                                )}
                            </div>
                        </header>

                        {/* Conte√∫do */}
                        <main className="flex-1 overflow-y-auto p-4 pb-24 scroll-smooth bg-gradient-to-b from-gray-50 to-white">
                            {view === 'agenda' && <AgendaView currentDate={currentDate} changeMonth={changeMonth} sundays={currentSundays} assignments={assignments} attendance={attendance} members={members} onSelectDate={(id) => { setSelectedAssignmentId(id); setView('editor'); }} />}
                            {view === 'membros' && <MembersView members={members} user={authData.user} availableCallings={availableCallings} onManageCallings={() => setShowCallingManager(true)} driveFolderId={authData.driveFolderId} unidadeId={authData.unidadeId} />}
                            {view === 'editor' && <EditorView dateStr={selectedAssignmentId} assignments={assignments} attendance={attendance} members={members} user={authData.user} onBack={() => setView('agenda')} driveFolderId={authData.driveFolderId} unidadeId={authData.unidadeId} />}
                            {view === 'reports' && <ReportsView attendance={attendance} members={members} assignments={assignments} />}
                        </main>

                        {/* Nav Bar Modernizada */}
                        {view !== 'editor' && (
                            <div className="absolute bottom-0 w-full bg-white/95 backdrop-blur-lg border-t border-gray-200 px-6 py-3 flex justify-between items-center z-20 pb-6 md:pb-4 shadow-2xl">
                                <NavButton active={view === 'agenda'} onClick={() => setView('agenda')} icon={<Calendar size={22} />} label="Agenda" />
                                <NavButton active={view === 'membros'} onClick={() => setView('membros')} icon={<Users size={22} />} label="Membros" />
                                <NavButton active={view === 'reports'} onClick={() => setView('reports')} icon={<BarChart3 size={22} />} label="Relat√≥rios" />
                            </div>
                        )}

                        {showCallingManager && <CallingsManager availableCallings={availableCallings} onClose={() => setShowCallingManager(false)} user={authData.user} driveFolderId={authData.driveFolderId} unidadeId={authData.unidadeId} />}
                        {showUserManager && authData.role === 'admin' && <UserManager 
                            unidadeId={authData.unidadeId} 
                            unidadeUsers={unidadeUsers} 
                            driveFolderId={authData.driveFolderId} 
                            onClose={() => setShowUserManager(false)}
                            onPendingRequestsChange={(count) => setPendingRequestsCount(count)}
                        />}
                        {showSettings && <SettingsModal onClose={() => setShowSettings(false)} onDeleteUser={handleDeleteUser} user={authData.user} />}
                    </div>
                </div>
            );
        }

        // --- Sub-componentes Modernizados ---
        const NavButton = ({ active, onClick, icon, label }) => (
            <button 
                onClick={onClick} 
                className={`flex flex-col items-center gap-1 p-2 rounded-xl transition-all transform ${
                    active 
                        ? 'text-blue-900 scale-110 bg-gradient-to-br from-blue-50 to-purple-50 shadow-md' 
                        : 'text-gray-400 hover:text-gray-600 hover:scale-105'
                }`}
            >
                {icon} 
                <span className="text-[10px] font-semibold">{label}</span>
            </button>
        );

        function AgendaView({ currentDate, changeMonth, sundays, assignments, attendance, members, onSelectDate }) {
            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="flex items-center justify-between bg-gradient-to-r from-blue-900 via-purple-800 to-pink-700 p-5 rounded-2xl shadow-xl text-white transform hover:scale-[1.02] transition-all">
                        <button onClick={() => changeMonth(-1)} className="p-2 rounded-full hover:bg-white/20 transition-all"><ChevronLeft size={24} /></button>
                        <div className="text-center">
                            <h2 className="text-2xl font-bold font-serif drop-shadow-md">{currentDate.toLocaleDateString('pt-BR', { month: 'long' })}</h2>
                            <p className="text-sm opacity-90">{currentDate.getFullYear()}</p>
                        </div>
                        <button onClick={() => changeMonth(1)} className="p-2 rounded-full hover:bg-white/20 transition-all"><ChevronRight size={24} /></button>
                    </div>
                    <div className="space-y-4">
                        {sundays.map(sunday => {
                            const dateStr = sunday.toISOString().split('T')[0];
                            const isConf = (sunday.getMonth() === 3 || sunday.getMonth() === 9) && sunday.getDate() <= 7;
                            if (isConf) return (
                                <div key={dateStr} className="bg-gradient-to-r from-amber-50 to-yellow-50 p-5 rounded-2xl border-2 border-amber-300 flex items-center gap-4 shadow-lg transform hover:scale-[1.02] transition-all">
                                    <Radio size={28} className="text-amber-700" />
                                    <div>
                                        <h3 className="font-bold text-amber-900 font-serif text-lg">Confer√™ncia Geral</h3>
                                        <p className="text-sm text-amber-700">{sunday.getDate()}</p>
                                    </div>
                                </div>
                            );
                            
                            const assign = assignments.find(a => a.id === dateStr || a.date === dateStr) || {};
                            const att = attendance.find(a => a.id === dateStr || a.date === dateStr) || {};
                            const hasSpk = assign.youth || assign.speaker1 || assign.speaker2;
                            const getName = (id) => members.find(m => m.id === id)?.name.split(' ')[0] || '...';

                            return (
                                <div 
                                    key={dateStr} 
                                    onClick={() => onSelectDate(dateStr)} 
                                    className="bg-white rounded-2xl shadow-md border border-gray-200 flex overflow-hidden cursor-pointer hover:shadow-xl hover:scale-[1.02] transition-all group"
                                >
                                    <div className={`w-24 flex flex-col items-center justify-center p-3 border-r border-gray-100 font-serif ${
                                        hasSpk 
                                            ? 'bg-gradient-to-br from-blue-50 to-purple-50 text-blue-900 border-blue-200' 
                                            : 'bg-gray-50 text-gray-400'
                                    }`}>
                                        <span className="text-3xl font-bold">{sunday.getDate()}</span>
                                        <span className="text-xs font-bold uppercase">DOM</span>
                                    </div>
                                    <div className="flex-1 p-4 flex flex-col justify-center">
                                        {hasSpk ? (
                                            <div className="space-y-1.5 text-sm text-slate-700">
                                                {assign.youth && <div className="flex gap-2 items-center"><div className="w-2 h-2 rounded-full bg-yellow-500 shadow-sm"></div><span className="font-medium">{getName(assign.youth)} <span className="text-xs text-gray-500">(Jovem)</span></span></div>}
                                                {assign.speaker1 && <div className="flex gap-2 items-center"><div className="w-2 h-2 rounded-full bg-blue-600 shadow-sm"></div><span className="font-medium">{getName(assign.speaker1)}</span></div>}
                                                {assign.speaker2 && <div className="flex gap-2 items-center"><div className="w-2 h-2 rounded-full bg-blue-600 shadow-sm"></div><span className="font-medium">{getName(assign.speaker2)}</span></div>}
                                            </div>
                                        ) : <p className="text-gray-400 text-sm italic group-hover:text-gray-600">Toque para planejar</p>}
                                    </div>
                                    {att.count > 0 && (
                                        <div className="pr-4 flex items-center">
                                            <div className="bg-gradient-to-br from-green-50 to-emerald-50 text-green-700 px-3 py-2 rounded-xl text-xs font-bold flex flex-col items-center border border-green-200 shadow-sm">
                                                <UserCheck size={16} />
                                                <span className="mt-0.5">{att.count}</span>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        function EditorView({ dateStr, assignments, attendance, members, user, onBack, driveFolderId, unidadeId }) {
            const [tab, setTab] = useState('planning');
            const assign = assignments.find(a => a.id === dateStr || a.date === dateStr) || {};
            const att = attendance.find(a => a.id === dateStr || a.date === dateStr) || { attendees: [], count: 0 };

            return (
                <div className="bg-gradient-to-b from-gray-50 to-white min-h-full flex flex-col -m-4">
                    <div className="bg-gradient-to-r from-white to-gray-50 px-4 py-4 border-b border-gray-200 sticky top-0 z-20 shadow-md">
                        <div className="flex items-center gap-3 mb-4">
                            <button onClick={onBack} className="p-1 rounded-full hover:bg-gray-200 transition-all">
                                <ChevronLeft size={24} />
                            </button>
                            <h2 className="font-bold text-xl font-serif text-gray-900">Detalhes do Domingo</h2>
                        </div>
                        <div className="bg-gray-100 p-1 rounded-xl flex shadow-inner">
                            <button 
                                onClick={() => setTab('planning')} 
                                className={`flex-1 py-2.5 text-sm font-semibold rounded-lg transition-all ${
                                    tab==='planning'
                                        ? 'bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg transform scale-105' 
                                        : 'text-gray-600 hover:text-gray-900'
                                }`}
                            >
                                Planejamento
                            </button>
                            <button 
                                onClick={() => setTab('attendance')} 
                                className={`flex-1 py-2.5 text-sm font-semibold rounded-lg transition-all ${
                                    tab==='attendance'
                                        ? 'bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg transform scale-105' 
                                        : 'text-gray-600 hover:text-gray-900'
                                }`}
                            >
                                Frequ√™ncia {att.count > 0 && `(${att.count})`}
                            </button>
                        </div>
                    </div>
                    <div className="p-4 pb-20">
                        {tab === 'planning' ? <PlanningPanel dateStr={dateStr} initialData={assign} members={members} user={user} driveFolderId={driveFolderId} unidadeId={unidadeId} /> : <AttendancePanel dateStr={dateStr} initialData={att} members={members} user={user} driveFolderId={driveFolderId} unidadeId={unidadeId} />}
                    </div>
                </div>
            );
        }

        function PlanningPanel({ dateStr, initialData, members, user, driveFolderId, unidadeId }) {
            const [formData, setFormData] = useState({...initialData});
            const [saving, setSaving] = useState(false);
            const [picker, setPicker] = useState(null);
            const [externalName, setExternalName] = useState('');
            const [showExternalModal, setShowExternalModal] = useState(false);

            const handleSave = async () => {
                setSaving(true);
                try {
                    const dataToSave = { ...formData, date: dateStr, updatedBy: user.uid };
                    // Salvar no Firestore primeiro (sincroniza√ß√£o em tempo real)
                    try {
                        await salvarAssignmentFirestore(unidadeId, dateStr, dataToSave);
                    } catch (e) {
                        console.warn('Erro ao salvar no Firestore, tentando Drive:', e);
                        // Fallback para Drive
                        await salvarNoDrive(driveFolderId, `assignment_${dateStr}`, dataToSave);
                    }
                    
                    if(formData.youth) await updateMemberLastSpoken(formData.youth, dateStr, driveFolderId);
                    if(formData.speaker1) await updateMemberLastSpoken(formData.speaker1, dateStr, driveFolderId);
                    if(formData.speaker2) await updateMemberLastSpoken(formData.speaker2, dateStr, driveFolderId);
                    alert("Salvo com sucesso!");
                } catch(e) { console.error(e); alert("Erro ao salvar: " + e.message); }
                setSaving(false);
            };

            const updateMemberLastSpoken = async (memberId, date, folderId) => {
                if(!memberId) return Promise.resolve();
                try {
                    // Encontrar o membro na lista
                    const member = members.find(m => m.id === memberId);
                    if (member) {
                        // Encontrar o nome do arquivo correto (pode ter prefixo member_ ou n√£o)
                        const fileName = member.id.startsWith('member_') ? member.id : `member_${member.id}`;
                        const memberData = await carregarDoDrive(folderId, fileName);
                        if (memberData) {
                            await salvarNoDrive(folderId, fileName, { ...memberData, lastSpoken: date });
                        }
                    }
                } catch (e) {
                    console.error("Erro ao atualizar lastSpoken:", e);
                }
            };
            const getName = (id) => members.find(m => m.id === id)?.name || "Selecionar...";
            const getMemberInfo = (id) => {
                const member = members.find(m => m.id === id);
                if (!member) return { name: "Selecionar...", calling: "" };
                return { name: member.name, calling: member.calling || "" };
            };
            
            const handleExternalNameSave = () => {
                if (externalName && externalName.trim()) {
                    const recognitions = [...(formData.recognitions || [])];
                    recognitions[showExternalModal.index] = { type: 'external', name: externalName.trim() };
                    setFormData({...formData, recognitions});
                    setShowExternalModal(false);
                    setExternalName('');
                }
            };

            const handlePickerSelect = (selectedId) => {
                if (picker && typeof picker === 'object' && picker.type === 'recognition') {
                    // Modo de selecionar membro
                    const recognitions = [...(formData.recognitions || [])];
                    recognitions[picker.index] = selectedId;
                    setFormData({...formData, recognitions});
                    setPicker(null);
                } else if (picker === 'pianist') {
                    setFormData({...formData, pianist: selectedId});
                    setPicker(null);
                } else if (picker === 'conductor') {
                    setFormData({...formData, conductor: selectedId});
                    setPicker(null);
                } else {
                    // L√≥gica original para outros pickers
                    setFormData({...formData, [picker]: selectedId});
                    setPicker(null);
                }
            };

            return (
                <div className="space-y-4 max-w-lg mx-auto">
                    <div className="bg-white p-5 rounded-2xl border border-gray-200 shadow-md">
                        <h3 className="text-xs font-bold text-slate-500 uppercase mb-3">Lideran√ßa</h3>
                        <input 
                            className="w-full p-3 border-2 border-gray-200 rounded-xl mb-3 focus:border-blue-500 focus:outline-none transition-all" 
                            placeholder="Presidindo" 
                            value={formData.presiding||''} 
                            onChange={e=>setFormData({...formData, presiding:e.target.value})} 
                        />
                        <input 
                            className="w-full p-3 border-2 border-gray-200 rounded-xl mb-3 focus:border-blue-500 focus:outline-none transition-all" 
                            placeholder="Dirigindo" 
                            value={formData.conducting||''} 
                            onChange={e=>setFormData({...formData, conducting:e.target.value})} 
                        />
                        
                        {/* Reconhecimentos */}
                        <div className="mt-4 pt-4 border-t border-gray-200">
                            <div className="flex justify-between items-center mb-2">
                                <h4 className="text-xs font-semibold text-slate-600">Reconhecimento(s)</h4>
                                <div className="flex gap-2">
                                    <button
                                        type="button"
                                        onClick={() => {
                                            const recognitions = formData.recognitions || [];
                                            setPicker({ type: 'recognition', index: recognitions.length, mode: 'member' });
                                        }}
                                        className="text-xs text-blue-600 hover:text-blue-700 font-semibold flex items-center gap-1 px-2 py-1 rounded hover:bg-blue-50"
                                    >
                                        <Plus size={14} /> Membro
                                    </button>
                                <button
                                    type="button"
                                    onClick={() => {
                                        const recognitions = formData.recognitions || [];
                                        setExternalName('');
                                        setShowExternalModal({ index: recognitions.length, editing: false });
                                    }}
                                    className="text-xs text-purple-600 hover:text-purple-700 font-semibold flex items-center gap-1 px-2 py-1 rounded hover:bg-purple-50"
                                >
                                    <Plus size={14} /> De Fora
                                </button>
                                </div>
                            </div>
                            <div className="space-y-2">
                                {(formData.recognitions || []).map((recognition, idx) => {
                                    // recognition pode ser um ID (string) ou um objeto {type: 'external', name: '...'}
                                    const isExternal = typeof recognition === 'object' && recognition?.type === 'external';
                                    const memberInfo = !isExternal ? getMemberInfo(recognition) : null;
                                    
                                    return (
                                        <div key={idx} className="flex items-center gap-2">
                                            <button
                                                type="button"
                                                onClick={() => {
                                                    if (isExternal) {
                                                        setExternalName(recognition.name);
                                                        setShowExternalModal({ index: idx, editing: true });
                                                    } else {
                                                        setPicker({ type: 'recognition', index: idx, mode: 'member', current: recognition });
                                                    }
                                                }}
                                                className={`flex-1 p-2.5 border-2 rounded-lg text-left hover:bg-gray-100 hover:border-blue-300 transition-all text-sm ${
                                                    isExternal 
                                                        ? 'bg-purple-50 border-purple-200 text-purple-900' 
                                                        : 'bg-gray-50 border-gray-200'
                                                }`}
                                            >
                                                <div className="flex flex-col">
                                                    <span className="font-medium">{isExternal ? recognition.name : memberInfo.name}</span>
                                                    {!isExternal && memberInfo.calling && (
                                                        <span className="text-xs text-gray-500 mt-0.5">{memberInfo.calling}</span>
                                                    )}
                                                    {isExternal && <span className="text-xs text-purple-600 mt-0.5">(Fora da Ala/Unidade)</span>}
                                                </div>
                                            </button>
                                            <button
                                                type="button"
                                                onClick={() => {
                                                    const recognitions = [...(formData.recognitions || [])];
                                                    recognitions.splice(idx, 1);
                                                    setFormData({...formData, recognitions: recognitions.length > 0 ? recognitions : null});
                                                }}
                                                className="text-red-500 hover:text-red-700 p-2 rounded-lg hover:bg-red-50 transition-all"
                                            >
                                                <X size={16} />
                                            </button>
                                        </div>
                                    );
                                })}
                                {(!formData.recognitions || formData.recognitions.length === 0) && (
                                    <p className="text-xs text-gray-400 italic">Nenhum reconhecimento adicionado</p>
                                )}
                            </div>
                        </div>
                        
                        {/* Pianista */}
                        <div className="mt-4 pt-4 border-t border-gray-200">
                            <label className="text-xs font-semibold text-slate-600 block mb-2">Pianista</label>
                            <button
                                type="button"
                                onClick={() => setPicker('pianist')}
                                className="w-full bg-gray-50 p-3 border-2 border-gray-200 rounded-xl text-left hover:bg-gray-100 hover:border-blue-300 transition-all"
                            >
                                <span className="font-medium text-sm">{getName(formData.pianist)}</span>
                            </button>
                        </div>
                        
                        {/* Regente */}
                        <div className="mt-4 pt-4 border-t border-gray-200">
                            <label className="text-xs font-semibold text-slate-600 block mb-2">Regente</label>
                            <button
                                type="button"
                                onClick={() => setPicker('conductor')}
                                className="w-full bg-gray-50 p-3 border-2 border-gray-200 rounded-xl text-left hover:bg-gray-100 hover:border-blue-300 transition-all"
                            >
                                <span className="font-medium text-sm">{getName(formData.conductor)}</span>
                            </button>
                        </div>
                    </div>
                    
                    <div className="bg-white p-5 rounded-2xl border border-gray-200 shadow-md">
                        <h3 className="text-xs font-bold text-slate-500 uppercase mb-3">Abertura</h3>
                        <input 
                            className="w-full p-3 border-2 border-gray-200 rounded-xl mb-3 focus:border-blue-500 focus:outline-none transition-all" 
                            placeholder="Hino Abertura" 
                            value={formData.hymnOpen||''} 
                            onChange={e=>setFormData({...formData, hymnOpen:e.target.value})} 
                        />
                        <button 
                            onClick={()=>setPicker('prayer1')} 
                            className="w-full bg-gray-50 p-3 border-2 border-gray-200 rounded-xl text-left flex justify-between hover:bg-gray-100 hover:border-blue-300 transition-all"
                        >
                            <span className="font-medium">{getName(formData.prayer1)}</span>
                            <span className="text-xs text-gray-400">Ora√ß√£o</span>
                        </button>
                        <textarea 
                            className="w-full p-3 border-2 border-gray-200 rounded-xl mt-3 text-sm focus:border-blue-500 focus:outline-none transition-all resize-none" 
                            placeholder="Assuntos da Ala..." 
                            value={formData.business||''} 
                            onChange={e=>setFormData({...formData, business:e.target.value})} 
                            rows="3"
                        />
                    </div>

                    <div className="bg-white p-5 rounded-2xl border border-gray-200 shadow-md">
                        <h3 className="text-xs font-bold text-slate-500 uppercase mb-3">Sacramento</h3>
                        <input 
                            className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-all" 
                            placeholder="Hino Sacramental" 
                            value={formData.hymnSacrament||''} 
                            onChange={e=>setFormData({...formData, hymnSacrament:e.target.value})} 
                        />
                    </div>

                    <div className="bg-gradient-to-br from-blue-50 to-purple-50 p-5 rounded-2xl border-2 border-blue-200 shadow-md">
                        <h3 className="text-xs font-bold text-blue-800 uppercase mb-3">Oradores</h3>
                        <button 
                            onClick={()=>setPicker('youth')} 
                            className="w-full bg-white p-3 rounded-xl border-2 border-gray-200 mb-3 text-left hover:border-blue-400 hover:shadow-md transition-all font-medium"
                        >
                            {getName(formData.youth)} <span className="text-xs text-gray-400 float-right">Jovem</span>
                        </button>
                        <button 
                            onClick={()=>setPicker('speaker1')} 
                            className="w-full bg-white p-3 rounded-xl border-2 border-gray-200 mb-3 text-left hover:border-blue-400 hover:shadow-md transition-all font-medium"
                        >
                            {getName(formData.speaker1)} <span className="text-xs text-gray-400 float-right">1¬∫</span>
                        </button>
                        <input 
                            className="w-full p-3 border-2 border-gray-200 rounded-xl mb-3 text-sm focus:border-blue-500 focus:outline-none transition-all" 
                            placeholder="Hino Intermedi√°rio" 
                            value={formData.hymnInter||''} 
                            onChange={e=>setFormData({...formData, hymnInter:e.target.value})} 
                        />
                        <button 
                            onClick={()=>setPicker('speaker2')} 
                            className="w-full bg-white p-3 rounded-xl border-2 border-gray-200 text-left hover:border-blue-400 hover:shadow-md transition-all font-medium"
                        >
                            {getName(formData.speaker2)} <span className="text-xs text-gray-400 float-right">2¬∫</span>
                        </button>
                    </div>

                    <div className="bg-white p-5 rounded-2xl border border-gray-200 shadow-md">
                        <h3 className="text-xs font-bold text-slate-500 uppercase mb-3">Encerramento</h3>
                        <input 
                            className="w-full p-3 border-2 border-gray-200 rounded-xl mb-3 focus:border-blue-500 focus:outline-none transition-all" 
                            placeholder="Hino Encerramento" 
                            value={formData.hymnClose||''} 
                            onChange={e=>setFormData({...formData, hymnClose:e.target.value})} 
                        />
                        <button 
                            onClick={()=>setPicker('prayer2')} 
                            className="w-full bg-gray-50 p-3 border-2 border-gray-200 rounded-xl text-left flex justify-between hover:bg-gray-100 hover:border-blue-300 transition-all"
                        >
                            <span className="font-medium">{getName(formData.prayer2)}</span>
                            <span className="text-xs text-gray-400">Ora√ß√£o</span>
                        </button>
                    </div>

                    <button 
                        onClick={handleSave} 
                        disabled={saving} 
                        className="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 rounded-xl font-bold shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        {saving ? 'Salvando...' : 'Salvar Planejamento'}
                    </button>
                    {picker && (
                        <MemberPickerModal 
                            role={typeof picker === 'object' ? (picker.type === 'recognition' ? 'recognition' : picker.type) : picker} 
                            members={members} 
                            onClose={()=>setPicker(null)} 
                            onSelect={handlePickerSelect} 
                            currentDateStr={dateStr} 
                        />
                    )}
                    
                    {showExternalModal && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                            <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl border border-gray-200 animate-slide-up">
                                <div className="p-5 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-pink-50 flex justify-between items-center">
                                    <h2 className="font-bold text-lg text-gray-900">Reconhecimento de Pessoa Externa</h2>
                                    <button 
                                        onClick={() => { setShowExternalModal(false); setExternalName(''); }} 
                                        className="p-2 rounded-full hover:bg-gray-200 transition-all"
                                    >
                                        <X size={20} />
                                    </button>
                                </div>
                                <div className="p-5 space-y-4">
                                    <div>
                                        <label className="text-sm font-semibold text-gray-700 block mb-2">
                                            Nome da pessoa (de fora da ala/unidade):
                                        </label>
                                        <input
                                            type="text"
                                            autoFocus
                                            value={externalName}
                                            onChange={(e) => setExternalName(e.target.value)}
                                            onKeyPress={(e) => {
                                                if (e.key === 'Enter') {
                                                    handleExternalNameSave();
                                                }
                                            }}
                                            placeholder="Digite o nome completo"
                                            className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition-all"
                                        />
                                    </div>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => { setShowExternalModal(false); setExternalName(''); }}
                                            className="flex-1 px-4 py-3 bg-gray-100 text-gray-700 rounded-xl font-semibold hover:bg-gray-200 transition-all"
                                        >
                                            Cancelar
                                        </button>
                                        <button
                                            onClick={handleExternalNameSave}
                                            disabled={!externalName || !externalName.trim()}
                                            className="flex-1 px-4 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl font-semibold hover:shadow-lg hover:scale-105 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
                                        >
                                            Salvar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function AttendancePanel({ dateStr, initialData, members, user, driveFolderId, unidadeId }) {
            const [ids, setIds] = useState(initialData.attendees || []);
            const [search, setSearch] = useState('');
            
            // Atualizar ids quando initialData mudar (dados em tempo real)
            useEffect(() => {
                if (initialData && initialData.attendees) {
                    console.log('üîÑ AttendancePanel: atualizando ids com initialData:', initialData.attendees);
                    setIds(initialData.attendees || []);
                }
            }, [initialData]);
            
            const toggle = (id) => {
                const newIds = ids.includes(id) ? ids.filter(x=>x!==id) : [...ids, id];
                setIds(newIds);
            };
            const save = async () => {
                try {
                    if (!dateStr) {
                        alert("Erro: Data n√£o informada");
                        return;
                    }
                    
                    if (!unidadeId) {
                        alert("Erro: Unidade n√£o identificada. Recarregue a p√°gina.");
                        return;
                    }
                    
                    const dataToSave = { 
                        date: dateStr, 
                        attendees: ids, 
                        count: ids.length,
                        criadoEm: new Date().toISOString()
                    };
                    
                    console.log('üíæ Salvando frequ√™ncia:', { dateStr, unidadeId, dataToSave });
                    
                    // Salvar no Firestore primeiro (sincroniza√ß√£o em tempo real)
                    if (unidadeId && db) {
                        try {
                            await salvarAttendanceFirestore(unidadeId, dateStr, dataToSave);
                            console.log('‚úÖ Frequ√™ncia salva no Firestore com sucesso!');
                        } catch (e) {
                            console.error('‚ùå Erro ao salvar no Firestore:', e);
                            console.warn('‚ö†Ô∏è Tentando salvar no Drive como fallback...');
                            // Fallback para Drive
                            if (driveFolderId) {
                                await salvarNoDrive(driveFolderId, `attendance_${dateStr}`, dataToSave);
                                console.log('‚úÖ Frequ√™ncia salva no Drive como fallback');
                            } else {
                                throw new Error('Nem Firestore nem Drive dispon√≠veis');
                            }
                        }
                    } else if (driveFolderId) {
                        // Se n√£o tem unidadeId, usar apenas Drive
                        console.warn('‚ö†Ô∏è UnidadeId n√£o dispon√≠vel, salvando apenas no Drive');
                        await salvarNoDrive(driveFolderId, `attendance_${dateStr}`, dataToSave);
                    } else {
                        throw new Error('Nem Firestore nem Drive dispon√≠veis');
                    }
                    
                    alert("‚úÖ Frequ√™ncia salva com sucesso!");
                } catch (e) {
                    console.error('‚ùå Erro ao salvar frequ√™ncia:', e);
                    alert("‚ùå Erro ao salvar frequ√™ncia: " + e.message);
                }
            };
            
            const filtered = members.filter(m => m.name.toLowerCase().includes(search.toLowerCase()));
            const visitors = filtered.filter(m => m.type === 'visitor');
            const regulars = filtered.filter(m => m.type !== 'visitor');

            return (
                <div className="h-full flex flex-col space-y-4">
                    <div className="bg-gradient-to-r from-green-50 to-emerald-50 p-5 rounded-2xl border-2 border-green-200 flex justify-between items-center shadow-md">
                        <div>
                            <p className="text-xs font-bold uppercase text-green-700">Total</p>
                            <p className="text-3xl font-bold text-green-900 mt-1">{ids.length}</p>
                        </div>
                        <button 
                            onClick={save} 
                            className="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-5 py-3 rounded-xl font-bold text-sm shadow-lg hover:shadow-xl hover:scale-105 transition-all"
                        >
                            Salvar
                        </button>
                    </div>
                    <input 
                        className="w-full p-3 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:outline-none transition-all shadow-sm" 
                        placeholder="Buscar membro..." 
                        value={search} 
                        onChange={e=>setSearch(e.target.value)} 
                    />
                    <div className="bg-white rounded-2xl border border-gray-200 flex-1 overflow-y-auto shadow-md">
                        {visitors.length > 0 && <div className="bg-gradient-to-r from-emerald-50 to-green-50 px-4 py-3 text-xs font-bold text-emerald-800 border-b border-emerald-200 sticky top-0">Visitantes</div>}
                        {visitors.map(m => (
                            <div 
                                key={m.id} 
                                onClick={()=>toggle(m.id)} 
                                className={`p-4 flex justify-between items-center border-b border-gray-100 cursor-pointer transition-all ${
                                    ids.includes(m.id)
                                        ? 'bg-gradient-to-r from-blue-50 to-purple-50 border-blue-200' 
                                        : 'hover:bg-gray-50'
                                }`}
                            >
                                <span className="font-medium">{m.name}</span>
                                {ids.includes(m.id) && <Check size={20} className="text-blue-600" />}
                            </div>
                        ))}
                        <div className="bg-gradient-to-r from-gray-100 to-gray-50 px-4 py-3 text-xs font-bold text-gray-600 border-b border-gray-200 sticky top-0">Membros</div>
                        {regulars.map(m => (
                            <div 
                                key={m.id} 
                                onClick={()=>toggle(m.id)} 
                                className={`p-4 flex justify-between items-center border-b border-gray-100 cursor-pointer transition-all ${
                                    ids.includes(m.id)
                                        ? 'bg-gradient-to-r from-blue-50 to-purple-50 border-blue-200' 
                                        : 'hover:bg-gray-50'
                                }`}
                            >
                                <span className="font-medium">{m.name}</span>
                                {ids.includes(m.id) && <Check size={20} className="text-blue-600" />}
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // --- Componentes Auxiliares Modernizados ---
        function MembersView({ members, user, availableCallings, onManageCallings, driveFolderId, unidadeId }) {
            const [form, setForm] = useState({ name: '', calling: '', type: 'member', gender: '', birthDate: '' });
            const [selectedMember, setSelectedMember] = useState(null);
            const [duplicateWarning, setDuplicateWarning] = useState(null); // { member, newData }
            const [searchTerm, setSearchTerm] = useState(''); // Termo de busca
            
            // Fun√ß√£o para verificar duplicatas
            const verificarDuplicatas = (newMember) => {
                const duplicatas = [];
                
                // Normalizar nome para compara√ß√£o (remover acentos, espa√ßos extras, lowercase)
                const normalizarNome = (nome) => {
                    if (!nome) return '';
                    return nome
                        .toLowerCase()
                        .normalize('NFD')
                        .replace(/[\u0300-\u036f]/g, '') // Remove acentos
                        .trim()
                        .replace(/\s+/g, ' '); // Remove espa√ßos m√∫ltiplos
                };
                
                const nomeNormalizado = normalizarNome(newMember.name);
                
                members.forEach(member => {
                    const nomeMemberNormalizado = normalizarNome(member.name);
                    
                    // Verificar se o nome √© muito similar (mesmo nome normalizado)
                    if (nomeNormalizado === nomeMemberNormalizado && nomeNormalizado.length > 0) {
                        // Verificar se tem mesma data de nascimento
                        if (newMember.birthDate && member.birthDate && newMember.birthDate === member.birthDate) {
                            duplicatas.push({
                                ...member,
                                motivo: 'Nome id√™ntico e mesma data de nascimento'
                            });
                        }
                        // Verificar se tem mesmo g√™nero
                        else if (newMember.gender && member.gender && newMember.gender === member.gender) {
                            duplicatas.push({
                                ...member,
                                motivo: 'Nome id√™ntico e mesmo g√™nero'
                            });
                        }
                        // Apenas nome id√™ntico
                        else {
                            duplicatas.push({
                                ...member,
                                motivo: 'Nome id√™ntico'
                            });
                        }
                    }
                    // Verificar se tem mesma data de nascimento e mesmo g√™nero (mesmo que nome diferente)
                    else if (newMember.birthDate && member.birthDate && 
                             newMember.birthDate === member.birthDate &&
                             newMember.gender && member.gender &&
                             newMember.gender === member.gender) {
                        duplicatas.push({
                            ...member,
                            motivo: 'Mesma data de nascimento e mesmo g√™nero'
                        });
                    }
                });
                
                return duplicatas;
            };
            
            const add = async (e) => {
                e.preventDefault();
                if(!form.name) return;
                
                // Verificar duplicatas antes de adicionar
                const duplicatas = verificarDuplicatas(form);
                
                if (duplicatas.length > 0) {
                    // Mostrar modal de confirma√ß√£o
                    setDuplicateWarning({
                        duplicates: duplicatas,
                        newData: { ...form }
                    });
                    return;
                }
                
                // Se n√£o houver duplicatas, adicionar normalmente
                await confirmarAdicao();
            };
            
            const confirmarAdicao = async (forcar = false) => {
                try {
                    const memberId = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    const fileName = `member_${memberId}`;
                    const dataToSave = forcar ? duplicateWarning.newData : form;
                    // Salvar no Firestore primeiro (sincroniza√ß√£o em tempo real)
                    const dataComDataCriacao = { 
                        ...dataToSave, 
                        id: memberId, 
                        createdAt: new Date().toISOString(),
                        criadoEm: new Date().toISOString() // Garantir ambos os campos para compatibilidade
                    };
                    try {
                        await salvarMembroFirestore(unidadeId, memberId, dataComDataCriacao);
                    } catch (e) {
                        console.warn('Erro ao salvar no Firestore, tentando Drive:', e);
                        // Fallback para Drive
                        await salvarNoDrive(driveFolderId, fileName, dataComDataCriacao);
                    }
                    setForm({ name: '', calling: '', type: 'member', gender: '', birthDate: '' });
                    setDuplicateWarning(null);
                } catch (e) {
                    console.error(e);
                    alert("Erro ao adicionar membro: " + e.message);
                }
            };
            
            const cancelarAdicao = () => {
                setDuplicateWarning(null);
            };
            
            const calcularIdade = (birthDate) => {
                if (!birthDate) return null;
                const hoje = new Date();
                const nascimento = new Date(birthDate);
                let idade = hoje.getFullYear() - nascimento.getFullYear();
                const mes = hoje.getMonth() - nascimento.getMonth();
                if (mes < 0 || (mes === 0 && hoje.getDate() < nascimento.getDate())) {
                    idade--;
                }
                return idade;
            };
            
            const determinarClasse = (gender, birthDate) => {
                if (!gender || !birthDate) return null;
                
                const hoje = new Date();
                const nascimento = new Date(birthDate);
                const anoAtual = hoje.getFullYear();
                const anoNascimento = nascimento.getFullYear();
                const idadeAtual = calcularIdade(birthDate);
                const idadeQueFaraNoAno = anoAtual - anoNascimento;
                
                // Verifica se vai fazer anivers√°rio ainda este ano
                const vaiFazerAniversarioEsteAno = nascimento.getMonth() > hoje.getMonth() || 
                    (nascimento.getMonth() === hoje.getMonth() && nascimento.getDate() > hoje.getDate());
                
                if (gender === 'homem') {
                    // Homens >= 18: Qu√≥rum de Elderes
                    if (idadeAtual >= 18) {
                        return 'Qu√≥rum de Elderes';
                    }
                    // Homens que v√£o fazer 16 no ano corrente (idade atual 15) e 17 anos: Rapazes - Sacerdotes
                    if (idadeQueFaraNoAno === 16 || idadeAtual === 17) {
                        return 'Rapazes - Sacerdotes';
                    }
                    // Homens que v√£o fazer 14 no ano corrente (idade atual 13) e 15 anos: Rapazes - Mestres
                    if (idadeQueFaraNoAno === 14 || idadeAtual === 15) {
                        return 'Rapazes - Mestres';
                    }
                    // Homens de 11 anos que v√£o fazer 12 no ano corrente at√© 13 anos: Rapazes - Di√°conos
                    if ((idadeAtual === 11 && idadeQueFaraNoAno === 12) || idadeAtual === 12 || idadeAtual === 13) {
                        return 'Rapazes - Di√°conos';
                    }
                    // Crian√ßas at√© 11 anos que n√£o v√£o fazer 12 no ano corrente: Prim√°ria
                    if (idadeAtual <= 11 && idadeQueFaraNoAno <= 11) {
                        return 'Prim√°ria';
                    }
                } else if (gender === 'mulher') {
                    // Mulheres >= 18: Sociedade de Socorro
                    if (idadeAtual >= 18) {
                        return 'Sociedade de Socorro';
                    }
                    // Mulheres de 11 anos que v√£o fazer 12 no ano corrente at√© 17 anos: Mo√ßas
                    if ((idadeAtual === 11 && idadeQueFaraNoAno === 12) || (idadeAtual >= 12 && idadeAtual <= 17)) {
                        return 'Mo√ßas';
                    }
                    // Crian√ßas at√© 11 anos que n√£o v√£o fazer 12 no ano corrente: Prim√°ria
                    if (idadeAtual <= 11 && idadeQueFaraNoAno <= 11) {
                        return 'Prim√°ria';
                    }
                }
                
                return null;
            };
            
            // Fun√ß√£o para normalizar nome para busca (remover acentos, espa√ßos extras, lowercase)
            const normalizarNome = (nome) => {
                if (!nome) return '';
                return nome
                    .toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '') // Remove acentos
                    .trim()
                    .replace(/\s+/g, ' '); // Remove espa√ßos m√∫ltiplos
            };
            
            // Filtrar membros baseado no termo de busca
            const filtrarMembros = (listaMembros) => {
                if (!searchTerm.trim()) return listaMembros;
                
                const termoNormalizado = normalizarNome(searchTerm);
                return listaMembros.filter(m => {
                    const nomeNormalizado = normalizarNome(m.name);
                    return nomeNormalizado.includes(termoNormalizado);
                });
            };
            
            const membrosFiltrados = filtrarMembros(members.filter(m => m.type !== 'visitor'));
            const visitantesFiltrados = filtrarMembros(members.filter(m => m.type === 'visitor'));
            
            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="bg-white p-5 rounded-2xl border border-gray-200 shadow-md">
                        <div className="flex justify-between mb-4">
                            <h2 className="font-bold text-lg text-gray-900">Novo Cadastro</h2>
                            <button 
                                onClick={onManageCallings} 
                                className="text-xs text-blue-700 bg-blue-50 px-3 py-1.5 rounded-lg hover:bg-blue-100 transition-all font-semibold border border-blue-200"
                            >
                                Chamados
                            </button>
                        </div>
                        <div className="flex bg-gray-100 p-1 rounded-xl mb-3 shadow-inner">
                            <button 
                                onClick={()=>setForm({...form, type:'member'})} 
                                className={`flex-1 text-xs py-2 rounded-lg font-semibold transition-all ${
                                    form.type==='member'
                                        ? 'bg-white shadow-md text-blue-900' 
                                        : 'text-gray-600 hover:text-gray-900'
                                }`}
                            >
                                Membro
                            </button>
                            <button 
                                onClick={()=>setForm({...form, type:'visitor'})} 
                                className={`flex-1 text-xs py-2 rounded-lg font-semibold transition-all ${
                                    form.type==='visitor'
                                        ? 'bg-emerald-50 shadow-md text-emerald-700' 
                                        : 'text-gray-600 hover:text-gray-900'
                                }`}
                            >
                                Visitante
                            </button>
                        </div>
                        <form onSubmit={add} className="space-y-3">
                            <input 
                                value={form.name} 
                                onChange={e=>setForm({...form, name:e.target.value})} 
                                placeholder="Nome completo" 
                                className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-all" 
                                required
                            />
                            <div className="flex gap-2">
                                <input 
                                    value={form.calling} 
                                    onChange={e=>setForm({...form, calling:e.target.value})} 
                                    placeholder="Chamado" 
                                    list="callings" 
                                    className="flex-1 p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-all" 
                                />
                                <button 
                                    type="submit"
                                    className="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-5 rounded-xl hover:shadow-lg hover:scale-105 transition-all"
                                >
                                    <Plus size={20} />
                                </button>
                            </div>
                            <div className="flex bg-gray-100 p-1 rounded-xl shadow-inner">
                                <button 
                                    type="button"
                                    onClick={()=>setForm({...form, gender:'homem'})} 
                                    className={`flex-1 text-xs py-2 rounded-lg font-semibold transition-all ${
                                        form.gender==='homem'
                                            ? 'bg-blue-100 shadow-md text-blue-900' 
                                            : 'text-gray-600 hover:text-gray-900'
                                    }`}
                                >
                                    Homem
                                </button>
                                <button 
                                    type="button"
                                    onClick={()=>setForm({...form, gender:'mulher'})} 
                                    className={`flex-1 text-xs py-2 rounded-lg font-semibold transition-all ${
                                        form.gender==='mulher'
                                            ? 'bg-pink-100 shadow-md text-pink-900' 
                                            : 'text-gray-600 hover:text-gray-900'
                                    }`}
                                >
                                    Mulher
                                </button>
                            </div>
                            <div>
                                <label className="block text-sm font-semibold text-gray-700 mb-2">Data de Nascimento</label>
                                <input 
                                    type="date"
                                    value={form.birthDate} 
                                    onChange={e=>setForm({...form, birthDate:e.target.value})} 
                                    className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-all" 
                                />
                            </div>
                            <datalist id="callings">{availableCallings.map(c=><option key={c.id} value={c.name}/>)}</datalist>
                        </form>
                    </div>
                    
                    {/* Campo de Busca */}
                    <div className="bg-white p-4 rounded-2xl border border-gray-200 shadow-md">
                        <div className="relative">
                            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={20} />
                            <input 
                                type="text"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                placeholder="Buscar membro por nome..."
                                className="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-all"
                            />
                            {searchTerm && (
                                <button
                                    onClick={() => setSearchTerm('')}
                                    className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors"
                                >
                                    <X size={18} />
                                </button>
                            )}
                        </div>
                        {searchTerm && (
                            <p className="text-xs text-gray-500 mt-2">
                                {membrosFiltrados.length + visitantesFiltrados.length > 0 
                                    ? `Encontrado(s) ${membrosFiltrados.length + visitantesFiltrados.length} resultado(s)`
                                    : 'Nenhum resultado encontrado'}
                            </p>
                        )}
                    </div>
                    
                    {/* Se√ß√£o de Membros */}
                    {members.filter(m => m.type !== 'visitor').length > 0 && (
                        <div className="space-y-3">
                            <div className="flex items-center gap-2 mb-2">
                                <div className="h-px flex-1 bg-gradient-to-r from-transparent via-blue-300 to-transparent"></div>
                                <h3 className="text-sm font-bold text-blue-700 bg-blue-50 px-3 py-1 rounded-full border border-blue-200">
                                    Membros ({searchTerm ? membrosFiltrados.length : members.filter(m => m.type !== 'visitor').length})
                                </h3>
                                <div className="h-px flex-1 bg-gradient-to-r from-transparent via-blue-300 to-transparent"></div>
                            </div>
                            {membrosFiltrados.length > 0 ? membrosFiltrados.map(m => {
                                const classe = determinarClasse(m.gender, m.birthDate);
                                const getClasseColor = (classe) => {
                                    if (!classe) return '';
                                    if (classe.includes('Elderes')) return 'bg-blue-100 text-blue-700 border-blue-200';
                                    if (classe.includes('Sacerdotes')) return 'bg-purple-100 text-purple-700 border-purple-200';
                                    if (classe.includes('Mestres')) return 'bg-indigo-100 text-indigo-700 border-indigo-200';
                                    if (classe.includes('Di√°conos')) return 'bg-cyan-100 text-cyan-700 border-cyan-200';
                                    if (classe.includes('Mo√ßas')) return 'bg-pink-100 text-pink-700 border-pink-200';
                                    if (classe.includes('Sociedade')) return 'bg-rose-100 text-rose-700 border-rose-200';
                                    if (classe.includes('Prim√°ria')) return 'bg-yellow-100 text-yellow-700 border-yellow-200';
                                    return '';
                                };
                                
                                return (
                                    <div 
                                        key={m.id} 
                                        className="bg-white p-4 rounded-2xl border border-gray-200 flex items-center gap-3 shadow-md hover:shadow-lg transition-all animate-slide-up"
                                    >
                                        <Avatar name={m.name} type={m.type} />
                                        <div 
                                            className="flex-1 cursor-pointer"
                                            onClick={() => setSelectedMember(m)}
                                        >
                                            <p className="font-bold text-sm text-gray-900 hover:text-blue-600 transition-colors">{m.name}</p>
                                            <div className="flex flex-wrap items-center gap-1.5 mt-0.5">
                                                {m.calling && (
                                                    <span className="text-xs text-gray-500">{m.calling}</span>
                                                )}
                                                {classe && (
                                                    <span className={`text-xs font-semibold px-2 py-0.5 rounded-full border ${getClasseColor(classe)}`}>
                                                        {classe}
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                        <button 
                                            onClick={async () => {
                                                if (confirm(`Tem certeza que deseja excluir ${m.name}? Esta a√ß√£o n√£o pode ser desfeita.`)) {
                                                    try {
                                                        // Tentar deletar do Firestore primeiro
                                                        await deletarMembroFirestore(unidadeId, m.id);
                                                    } catch (e) {
                                                        console.warn('Erro ao deletar do Firestore, tentando Drive:', e);
                                                        // Fallback para Drive
                                                        const fileName = m.id.startsWith('member_') ? m.id : `member_${m.id}`;
                                                        await deletarDoDrive(driveFolderId, fileName);
                                                    }
                                                }
                                            }}
                                            className="text-gray-300 hover:text-red-500 transition-all p-2 rounded-full hover:bg-red-50"
                                        >
                                            <Trash2 size={18}/>
                                        </button>
                                    </div>
                                );
                            }) : searchTerm && (
                                <div className="bg-gray-50 p-6 rounded-2xl border border-gray-200 text-center">
                                    <Search size={32} className="mx-auto text-gray-400 mb-2" />
                                    <p className="text-gray-500 font-medium">Nenhum membro encontrado</p>
                                    <p className="text-sm text-gray-400 mt-1">Tente buscar com outro nome</p>
                                </div>
                            )}
                        </div>
                    )}
                    
                    {/* Se√ß√£o de Visitantes */}
                    {members.filter(m => m.type === 'visitor').length > 0 && (
                        <div className="space-y-3 mt-6">
                            <div className="flex items-center gap-2 mb-2">
                                <div className="h-px flex-1 bg-gradient-to-r from-transparent via-emerald-300 to-transparent"></div>
                                <h3 className="text-sm font-bold text-emerald-700 bg-emerald-50 px-3 py-1 rounded-full border border-emerald-200">
                                    Visitantes ({searchTerm ? visitantesFiltrados.length : members.filter(m => m.type === 'visitor').length})
                                </h3>
                                <div className="h-px flex-1 bg-gradient-to-r from-transparent via-emerald-300 to-transparent"></div>
                            </div>
                            {visitantesFiltrados.length > 0 ? visitantesFiltrados.map(m => {
                                return (
                                    <div 
                                        key={m.id} 
                                        className="bg-white p-4 rounded-2xl border border-gray-200 flex items-center gap-3 shadow-md hover:shadow-lg transition-all animate-slide-up"
                                    >
                                        <Avatar name={m.name} type={m.type} />
                                        <div 
                                            className="flex-1 cursor-pointer"
                                            onClick={() => setSelectedMember(m)}
                                        >
                                            <p className="font-bold text-sm text-gray-900 hover:text-blue-600 transition-colors">{m.name}</p>
                                            <div className="flex flex-wrap items-center gap-1.5 mt-0.5">
                                                {m.calling && (
                                                    <span className="text-xs text-gray-500">{m.calling}</span>
                                                )}
                                                <span className="text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-full text-xs font-semibold border border-emerald-200">Visitante</span>
                                            </div>
                                        </div>
                                        <button 
                                            onClick={async () => {
                                                if (confirm(`Tem certeza que deseja excluir ${m.name}? Esta a√ß√£o n√£o pode ser desfeita.`)) {
                                                    try {
                                                        // Tentar deletar do Firestore primeiro
                                                        await deletarMembroFirestore(unidadeId, m.id);
                                                    } catch (e) {
                                                        console.warn('Erro ao deletar do Firestore, tentando Drive:', e);
                                                        // Fallback para Drive
                                                        const fileName = m.id.startsWith('member_') ? m.id : `member_${m.id}`;
                                                        await deletarDoDrive(driveFolderId, fileName);
                                                    }
                                                }
                                            }}
                                            className="text-gray-300 hover:text-red-500 transition-all p-2 rounded-full hover:bg-red-50"
                                        >
                                            <Trash2 size={18}/>
                                        </button>
                                    </div>
                                );
                            }) : searchTerm && (
                                <div className="bg-gray-50 p-6 rounded-2xl border border-gray-200 text-center">
                                    <Search size={32} className="mx-auto text-gray-400 mb-2" />
                                    <p className="text-gray-500 font-medium">Nenhum visitante encontrado</p>
                                    <p className="text-sm text-gray-400 mt-1">Tente buscar com outro nome</p>
                                </div>
                            )}
                        </div>
                    )}
                    
                    {/* Mensagem quando n√£o h√° membros */}
                    {members.length === 0 && !searchTerm && (
                        <div className="bg-gray-50 p-8 rounded-2xl border border-gray-200 text-center">
                            <Users size={48} className="mx-auto text-gray-400 mb-3" />
                            <p className="text-gray-500 font-medium">Nenhum membro cadastrado</p>
                            <p className="text-sm text-gray-400 mt-1">Use o formul√°rio acima para adicionar membros</p>
                        </div>
                    )}
                    
                    {selectedMember && (
                        <MemberDetailsModal 
                            member={selectedMember} 
                            onClose={() => setSelectedMember(null)}
                            calcularIdade={calcularIdade}
                            determinarClasse={determinarClasse}
                            driveFolderId={driveFolderId}
                            availableCallings={availableCallings}
                            unidadeId={unidadeId}
                            onDelete={async (memberId) => {
                                if (confirm(`Tem certeza que deseja excluir ${selectedMember.name}? Esta a√ß√£o n√£o pode ser desfeita.`)) {
                                    try {
                                        // Tentar deletar do Firestore primeiro
                                        await deletarMembroFirestore(unidadeId, memberId);
                                    } catch (e) {
                                        console.warn('Erro ao deletar do Firestore, tentando Drive:', e);
                                        // Fallback para Drive
                                        const fileName = memberId.startsWith('member_') ? memberId : `member_${memberId}`;
                                        await deletarDoDrive(driveFolderId, fileName);
                                    }
                                    setSelectedMember(null);
                                }
                            }}
                        />
                    )}
                    
                    {/* Modal de Aviso de Duplicata */}
                    {duplicateWarning && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                            <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl border border-gray-200 p-6 animate-slide-up max-h-[90vh] overflow-y-auto">
                                <div className="flex items-center gap-3 mb-4">
                                    <div className="w-12 h-12 rounded-full bg-amber-100 flex items-center justify-center">
                                        <AlertCircle className="text-amber-600" size={24} />
                                    </div>
                                    <div>
                                        <h3 className="font-bold text-lg text-gray-900">Poss√≠vel Duplicata Detectada</h3>
                                        <p className="text-sm text-gray-600">Encontramos membros com informa√ß√µes similares</p>
                                    </div>
                                </div>
                                
                                <div className="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-xl">
                                    <p className="text-sm font-semibold text-blue-900 mb-2">Novo registro a ser cadastrado:</p>
                                    <div className="text-sm text-blue-800">
                                        <p><strong>Nome:</strong> {duplicateWarning.newData.name}</p>
                                        {duplicateWarning.newData.birthDate && (
                                            <p><strong>Data de Nascimento:</strong> {new Date(duplicateWarning.newData.birthDate).toLocaleDateString('pt-BR')}</p>
                                        )}
                                        {duplicateWarning.newData.gender && (
                                            <p><strong>G√™nero:</strong> {duplicateWarning.newData.gender === 'homem' ? 'Homem' : 'Mulher'}</p>
                                        )}
                                    </div>
                                </div>
                                
                                <div className="mb-4">
                                    <p className="text-sm font-semibold text-gray-700 mb-2">Membros similares encontrados:</p>
                                    <div className="space-y-2 max-h-60 overflow-y-auto">
                                        {duplicateWarning.duplicates.map((dup, index) => (
                                            <div key={index} className="p-3 bg-amber-50 border border-amber-200 rounded-xl">
                                                <div className="flex items-start justify-between">
                                                    <div className="flex-1">
                                                        <p className="font-semibold text-gray-900">{dup.name}</p>
                                                        <div className="text-xs text-gray-600 mt-1 space-y-0.5">
                                                            {dup.birthDate && (
                                                                <p>Nascimento: {new Date(dup.birthDate).toLocaleDateString('pt-BR')}</p>
                                                            )}
                                                            {dup.gender && (
                                                                <p>G√™nero: {dup.gender === 'homem' ? 'Homem' : 'Mulher'}</p>
                                                            )}
                                                            {dup.calling && (
                                                                <p>Chamado: {dup.calling}</p>
                                                            )}
                                                        </div>
                                                        <p className="text-xs text-amber-700 font-medium mt-1">‚ö†Ô∏è {dup.motivo}</p>
                                                    </div>
                                                    <button
                                                        onClick={() => setSelectedMember(dup)}
                                                        className="ml-2 text-blue-600 hover:text-blue-700 text-xs font-semibold"
                                                    >
                                                        Ver detalhes
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                
                                <div className="flex gap-3">
                                    <button
                                        onClick={cancelarAdicao}
                                        className="flex-1 bg-gray-200 text-gray-700 p-3 rounded-xl font-semibold hover:bg-gray-300 transition-all"
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        onClick={() => confirmarAdicao(true)}
                                        className="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 text-white p-3 rounded-xl font-semibold hover:shadow-lg transition-all"
                                    >
                                        Adicionar Mesmo Assim
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        
        function MemberDetailsModal({ member, onClose, calcularIdade, determinarClasse, driveFolderId, availableCallings, unidadeId, onDelete }) {
            const [isEditing, setIsEditing] = useState(false);
            const [editForm, setEditForm] = useState({
                name: member.name || '',
                calling: member.calling || '',
                type: member.type || 'member',
                gender: member.gender || '',
                birthDate: member.birthDate || ''
            });
            const [saving, setSaving] = useState(false);
            
            const idade = calcularIdade(member.birthDate);
            const classe = determinarClasse(member.gender, member.birthDate);
            const formatarData = (dataString) => {
                if (!dataString) return 'N√£o informada';
                const data = new Date(dataString);
                return data.toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric'
                });
            };
            
            const getClasseColor = (classe) => {
                if (!classe) return 'bg-gray-100 text-gray-700';
                if (classe.includes('Elderes')) return 'bg-blue-100 text-blue-800';
                if (classe.includes('Sacerdotes')) return 'bg-purple-100 text-purple-800';
                if (classe.includes('Mestres')) return 'bg-indigo-100 text-indigo-800';
                if (classe.includes('Di√°conos')) return 'bg-cyan-100 text-cyan-800';
                if (classe.includes('Mo√ßas')) return 'bg-pink-100 text-pink-800';
                if (classe.includes('Sociedade')) return 'bg-rose-100 text-rose-800';
                if (classe.includes('Prim√°ria')) return 'bg-yellow-100 text-yellow-800';
                return 'bg-gray-100 text-gray-700';
            };
            
            const handleSave = async () => {
                if (!editForm.name.trim()) {
                    alert('O nome √© obrigat√≥rio');
                    return;
                }
                setSaving(true);
                try {
                    // Preparar dados para salvar
                    const dataToSave = { 
                        ...member, 
                        ...editForm,
                        // Preservar criadoEm se existir
                        criadoEm: member.criadoEm || member.createdAt || new Date().toISOString(),
                        createdAt: member.createdAt || member.criadoEm || new Date().toISOString()
                    };
                    
                    // Salvar no Firestore primeiro (sincroniza√ß√£o em tempo real)
                    try {
                        await salvarMembroFirestore(unidadeId, member.id, dataToSave);
                        console.log('‚úÖ Membro atualizado no Firestore');
                    } catch (e) {
                        console.warn('Erro ao salvar no Firestore, tentando Drive:', e);
                        // Fallback para Drive
                        const fileName = member.id.startsWith('member_') ? member.id : `member_${member.id}`;
                        await salvarNoDrive(driveFolderId, fileName, dataToSave);
                    }
                    
                    setIsEditing(false);
                    alert('Membro atualizado com sucesso!');
                    onClose();
                } catch (e) {
                    console.error(e);
                    alert('Erro ao salvar: ' + e.message);
                }
                setSaving(false);
            };
            
            if (isEditing) {
                return (
                    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                        <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl border border-gray-200 animate-slide-up max-h-[90vh] overflow-y-auto">
                            <div className="p-5 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-purple-50 flex justify-between items-center sticky top-0 bg-white">
                                <h2 className="font-bold text-xl text-gray-900 font-serif">Editar Membro</h2>
                                <button 
                                    onClick={() => setIsEditing(false)} 
                                    className="p-2 rounded-full hover:bg-gray-200 transition-all"
                                >
                                    <X size={20} />
                                </button>
                            </div>
                            <div className="p-5 space-y-4">
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase mb-2 block">Nome Completo *</label>
                                    <input
                                        type="text"
                                        value={editForm.name}
                                        onChange={e => setEditForm({...editForm, name: e.target.value})}
                                        className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-all"
                                        placeholder="Nome completo"
                                        required
                                    />
                                </div>
                                
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase mb-2 block">Chamado</label>
                                    <input
                                        type="text"
                                        value={editForm.calling}
                                        onChange={e => setEditForm({...editForm, calling: e.target.value})}
                                        list="edit-callings"
                                        className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-all"
                                        placeholder="Chamado"
                                    />
                                    <datalist id="edit-callings">
                                        {availableCallings.map(c => <option key={c.id} value={c.name}/>)}
                                    </datalist>
                                </div>
                                
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase mb-2 block">Tipo</label>
                                    <div className="flex bg-gray-100 p-1 rounded-xl">
                                        <button
                                            type="button"
                                            onClick={() => setEditForm({...editForm, type: 'member'})}
                                            className={`flex-1 text-xs py-2 rounded-lg font-semibold transition-all ${
                                                editForm.type === 'member'
                                                    ? 'bg-white shadow-md text-blue-900' 
                                                    : 'text-gray-600'
                                            }`}
                                        >
                                            Membro
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => setEditForm({...editForm, type: 'visitor'})}
                                            className={`flex-1 text-xs py-2 rounded-lg font-semibold transition-all ${
                                                editForm.type === 'visitor'
                                                    ? 'bg-emerald-50 shadow-md text-emerald-700' 
                                                    : 'text-gray-600'
                                            }`}
                                        >
                                            Visitante
                                        </button>
                                    </div>
                                </div>
                                
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase mb-2 block">G√™nero</label>
                                    <div className="flex bg-gray-100 p-1 rounded-xl">
                                        <button
                                            type="button"
                                            onClick={() => setEditForm({...editForm, gender: 'homem'})}
                                            className={`flex-1 text-xs py-2 rounded-lg font-semibold transition-all ${
                                                editForm.gender === 'homem'
                                                    ? 'bg-blue-100 shadow-md text-blue-900' 
                                                    : 'text-gray-600'
                                            }`}
                                        >
                                            Homem
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => setEditForm({...editForm, gender: 'mulher'})}
                                            className={`flex-1 text-xs py-2 rounded-lg font-semibold transition-all ${
                                                editForm.gender === 'mulher'
                                                    ? 'bg-pink-100 shadow-md text-pink-900' 
                                                    : 'text-gray-600'
                                            }`}
                                        >
                                            Mulher
                                        </button>
                                    </div>
                                </div>
                                
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase mb-2 block">Data de Nascimento</label>
                                    <input
                                        type="date"
                                        value={editForm.birthDate}
                                        onChange={e => setEditForm({...editForm, birthDate: e.target.value})}
                                        className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-all"
                                    />
                                </div>
                                
                                <div className="flex gap-2 pt-4">
                                    <button
                                        onClick={() => setIsEditing(false)}
                                        className="flex-1 px-4 py-3 bg-gray-100 text-gray-700 rounded-xl font-semibold hover:bg-gray-200 transition-all"
                                    >
                                        Cancelar
                                    </button>
                                    <button
                                        onClick={handleSave}
                                        disabled={saving || !editForm.name.trim()}
                                        className="flex-1 px-4 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-semibold hover:shadow-lg hover:scale-105 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        {saving ? 'Salvando...' : 'Salvar'}
                                    </button>
                                </div>
                                
                                <div className="pt-4 border-t border-gray-200">
                                    <button
                                        onClick={() => {
                                            if (confirm(`Tem certeza que deseja excluir ${member.name}? Esta a√ß√£o n√£o pode ser desfeita.`)) {
                                                onDelete(member.id);
                                            }
                                        }}
                                        className="w-full px-4 py-3 bg-red-50 text-red-700 rounded-xl font-semibold hover:bg-red-100 transition-all border border-red-200"
                                    >
                                        <Trash2 size={16} className="inline mr-2" />
                                        Excluir Membro
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl border border-gray-200 animate-slide-up max-h-[90vh] overflow-y-auto">
                        <div className="p-5 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-purple-50 flex justify-between items-center sticky top-0 bg-white">
                            <h2 className="font-bold text-xl text-gray-900 font-serif">
                                {isEditing ? 'Editar Membro' : 'Detalhes do Membro'}
                            </h2>
                            <div className="flex gap-2">
                                {!isEditing && (
                                    <button 
                                        onClick={() => setIsEditing(true)} 
                                        className="p-2 rounded-full hover:bg-blue-100 text-blue-600 transition-all"
                                        title="Editar"
                                    >
                                        <Pencil size={18} />
                                    </button>
                                )}
                                <button 
                                    onClick={onClose} 
                                    className="p-2 rounded-full hover:bg-gray-200 transition-all"
                                >
                                    <X size={20} />
                                </button>
                            </div>
                        </div>
                        <div className="p-5 space-y-4">
                            <div className="flex justify-center mb-4">
                                <Avatar name={member.name} type={member.type} size="lg" />
                            </div>
                            
                            <div className="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl border border-blue-200">
                                <h3 className="text-xs font-bold text-blue-800 uppercase mb-2">Nome Completo</h3>
                                <p className="text-lg font-bold text-gray-900">{member.name}</p>
                            </div>
                            
                            {classe && (
                                <div className="bg-gradient-to-r from-indigo-50 to-purple-50 p-4 rounded-xl border-2 border-indigo-200">
                                    <h3 className="text-xs font-bold text-indigo-800 uppercase mb-2">Classe/Organiza√ß√£o</h3>
                                    <p className={`text-lg font-bold px-4 py-2 rounded-lg inline-block ${getClasseColor(classe)}`}>
                                        {classe}
                                    </p>
                                </div>
                            )}
                            
                            <div className="bg-white p-4 rounded-xl border border-gray-200">
                                <h3 className="text-xs font-bold text-gray-500 uppercase mb-2">Chamado</h3>
                                <p className="text-gray-900 font-medium">{member.calling || 'N√£o informado'}</p>
                            </div>
                            
                            <div className="bg-white p-4 rounded-xl border border-gray-200">
                                <h3 className="text-xs font-bold text-gray-500 uppercase mb-2">Tipo</h3>
                                <p className="text-gray-900 font-medium">
                                    {member.type === 'visitor' ? (
                                        <span className="text-emerald-600 bg-emerald-50 px-3 py-1 rounded-full font-semibold">Visitante</span>
                                    ) : (
                                        <span className="text-blue-600 bg-blue-50 px-3 py-1 rounded-full font-semibold">Membro</span>
                                    )}
                                </p>
                            </div>
                            
                            {member.gender && (
                                <div className="bg-white p-4 rounded-xl border border-gray-200">
                                    <h3 className="text-xs font-bold text-gray-500 uppercase mb-2">G√™nero</h3>
                                    <p className="text-gray-900 font-medium capitalize">
                                        {member.gender === 'homem' ? (
                                            <span className="text-blue-600 bg-blue-50 px-3 py-1 rounded-full font-semibold">Homem</span>
                                        ) : (
                                            <span className="text-pink-600 bg-pink-50 px-3 py-1 rounded-full font-semibold">Mulher</span>
                                        )}
                                    </p>
                                </div>
                            )}
                            
                            {member.birthDate && (
                                <>
                                    <div className="bg-white p-4 rounded-xl border border-gray-200">
                                        <h3 className="text-xs font-bold text-gray-500 uppercase mb-2">Data de Nascimento</h3>
                                        <p className="text-gray-900 font-medium">{formatarData(member.birthDate)}</p>
                                    </div>
                                    
                                    {idade !== null && (
                                        <div className="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-xl border border-green-200">
                                            <h3 className="text-xs font-bold text-green-800 uppercase mb-2">Idade</h3>
                                            <p className="text-2xl font-bold text-green-900">{idade} {idade === 1 ? 'ano' : 'anos'}</p>
                                        </div>
                                    )}
                                </>
                            )}
                            
                            {(!member.gender && !member.birthDate) && (
                                <div className="bg-amber-50 p-4 rounded-xl border border-amber-200">
                                    <p className="text-sm text-amber-700 text-center">
                                        Informe g√™nero e data de nascimento para ver a classe/organiza√ß√£o
                                    </p>
                                </div>
                            )}
                            
                            <div className="pt-4 border-t border-gray-200">
                                <button
                                    onClick={() => {
                                        if (confirm(`Tem certeza que deseja excluir ${member.name}? Esta a√ß√£o n√£o pode ser desfeita.`)) {
                                            onDelete(member.id);
                                        }
                                    }}
                                    className="w-full px-4 py-3 bg-red-50 text-red-700 rounded-xl font-semibold hover:bg-red-100 transition-all border border-red-200 flex items-center justify-center gap-2"
                                >
                                    <Trash2 size={16} />
                                    Excluir Membro
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function ReportsView({ attendance, members, assignments }) {
            const calcularIdade = (birthDate) => {
                if (!birthDate) return null;
                const hoje = new Date();
                const nascimento = new Date(birthDate);
                let idade = hoje.getFullYear() - nascimento.getFullYear();
                const mes = hoje.getMonth() - nascimento.getMonth();
                if (mes < 0 || (mes === 0 && hoje.getDate() < nascimento.getDate())) {
                    idade--;
                }
                return idade;
            };
            
            const determinarClasse = (gender, birthDate) => {
                if (!gender || !birthDate) return null;
                
                const hoje = new Date();
                const nascimento = new Date(birthDate);
                const anoAtual = hoje.getFullYear();
                const anoNascimento = nascimento.getFullYear();
                const idadeAtual = calcularIdade(birthDate);
                const idadeQueFaraNoAno = anoAtual - anoNascimento;
                
                if (gender === 'homem') {
                    if (idadeAtual >= 18) return 'Qu√≥rum de Elderes';
                    if (idadeQueFaraNoAno === 16 || idadeAtual === 17) return 'Rapazes - Sacerdotes';
                    if (idadeQueFaraNoAno === 14 || idadeAtual === 15) return 'Rapazes - Mestres';
                    if ((idadeAtual === 11 && idadeQueFaraNoAno === 12) || idadeAtual === 12 || idadeAtual === 13) return 'Rapazes - Di√°conos';
                    if (idadeAtual <= 11 && idadeQueFaraNoAno <= 11) return 'Prim√°ria';
                } else if (gender === 'mulher') {
                    if (idadeAtual >= 18) return 'Sociedade de Socorro';
                    if ((idadeAtual === 11 && idadeQueFaraNoAno === 12) || (idadeAtual >= 12 && idadeAtual <= 17)) return 'Mo√ßas';
                    if (idadeAtual <= 11 && idadeQueFaraNoAno <= 11) return 'Prim√°ria';
                }
                return null;
            };
            
            // Relat√≥rio detalhado por membro (deve vir antes de analiseIA)
            const membersReport = useMemo(() => {
                console.log('üìä Gerando relat√≥rio de membros...');
                console.log('üìã Total de registros de attendance:', attendance?.length || 0);
                console.log('üë• Total de membros:', members?.length || 0);
                console.log('üìã Attendance (raw):', attendance);
                
                // Garantir que attendance √© um array
                const attendanceArray = Array.isArray(attendance) ? attendance : [];
                
                // Obter todas as datas de frequ√™ncia registradas (compatibilidade com Firestore e Drive)
                const todasDatas = attendanceArray
                    .map(a => a?.date || a?.id)
                    .filter(Boolean)
                    .sort();
                
                console.log('üìÖ Datas de frequ√™ncia encontradas:', todasDatas);
                console.log('üìã Dados completos de attendance:', attendanceArray);
                
                // Debug: mostrar todos os attendees de todos os registros
                attendanceArray.forEach(att => {
                    console.log(`üìù Attendance ${att.date || att.id}:`, {
                        date: att.date || att.id,
                        attendees: att.attendees,
                        count: att.count,
                        attendeesAsStrings: att.attendees?.map(id => String(id))
                    });
                });
                
                // Debug: mostrar todos os IDs dos membros
                console.log('üë• IDs dos membros:', members.filter(m => m.type !== 'visitor').map(m => ({
                    name: m.name,
                    id: m.id,
                    idAsString: String(m.id)
                })));
                
                // Para cada membro, calcular presen√ßas e faltas
                const resultado = members
                    .filter(m => m.type !== 'visitor')
                    .map(member => {
                        const presencas = [];
                        const faltas = [];
                        
                        // Obter data de cria√ß√£o do membro (criadoEm ou createdAt)
                        const dataCriacaoMembro = member.criadoEm || member.createdAt || member.created_at;
                        const dataCriacao = dataCriacaoMembro ? new Date(dataCriacaoMembro) : null;
                        
                        console.log(`\nüîÑ Processando membro: ${member.name} (ID: ${member.id})`);
                        console.log(`   Data de cria√ß√£o: ${dataCriacaoMembro || 'n√£o definida'}`);
                        
                        todasDatas.forEach(dateStr => {
                            // Se o membro tem data de cria√ß√£o, s√≥ considerar datas a partir dessa data
                            if (dataCriacao) {
                                const dataAtual = new Date(dateStr + 'T12:00:00');
                                // Normalizar as datas para compara√ß√£o (apenas data, sem hora)
                                const dataCriacaoNormalizada = new Date(dataCriacao.getFullYear(), dataCriacao.getMonth(), dataCriacao.getDate());
                                const dataAtualNormalizada = new Date(dataAtual.getFullYear(), dataAtual.getMonth(), dataAtual.getDate());
                                
                                // Se a data da frequ√™ncia √© anterior √† data de cria√ß√£o do membro, ignorar
                                if (dataAtualNormalizada < dataCriacaoNormalizada) {
                                    console.log(`   ‚è≠Ô∏è  Pulando data ${dateStr} (anterior √† cria√ß√£o do membro)`);
                                    return; // Pula esta data, n√£o conta como presen√ßa nem falta
                                }
                            }
                            
                            // Procurar por id ou date (compatibilidade com Firestore e Drive)
                            const attRecord = attendanceArray.find(a => a?.id === dateStr || a?.date === dateStr);
                            
                            if (!attRecord) {
                                console.log(`   ‚ö†Ô∏è  Nenhum registro encontrado para data ${dateStr}`);
                                return;
                            }
                            
                            // Verificar se o membro est√° presente
                            // Converter ambos para string para garantir compara√ß√£o correta
                            const memberIdStr = String(member.id);
                            const attendeesArray = attRecord?.attendees || [];
                            
                            // Tentar diferentes formas de compara√ß√£o
                            const comparacao1 = attendeesArray.includes(member.id);
                            const comparacao2 = attendeesArray.includes(memberIdStr);
                            const comparacao3 = attendeesArray.some(id => id == member.id); // == em vez de ===
                            const comparacao4 = attendeesArray.some(id => String(id) === memberIdStr);
                            
                            // Usar a compara√ß√£o mais robusta (qualquer uma que funcione)
                            const estevePresente = comparacao1 || comparacao2 || comparacao3 || comparacao4;
                            
                            // Debug detalhado
                            console.log(`   üìÖ Data: ${dateStr}`);
                            console.log(`      - attendees array:`, attendeesArray);
                            console.log(`      - member.id: ${member.id} (tipo: ${typeof member.id})`);
                            console.log(`      - member.id como string: ${memberIdStr}`);
                            console.log(`      - Compara√ß√µes:`, { comparacao1, comparacao2, comparacao3, comparacao4 });
                            console.log(`      - ‚úÖ Esteve presente: ${estevePresente}`);
                            
                            const dataFormatada = new Date(dateStr + 'T12:00:00').toLocaleDateString('pt-BR', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric'
                            });
                            
                            if (estevePresente) {
                                presencas.push(dataFormatada);
                                console.log(`      ‚úÖ Adicionado √†s presen√ßas`);
                            } else {
                                faltas.push(dataFormatada);
                                console.log(`      ‚ùå Adicionado √†s faltas`);
                            }
                        });
                        
                        console.log(`   üìä Resultado final: ${presencas.length} presen√ßas, ${faltas.length} faltas\n`);
                        
                        return {
                            ...member,
                            classe: determinarClasse(member.gender, member.birthDate),
                            presencas,
                            faltas,
                            totalPresencas: presencas.length,
                            totalFaltas: faltas.length
                        };
                    })
                    .sort((a, b) => a.name.localeCompare(b.name));
                
                console.log('‚úÖ Relat√≥rio gerado:', resultado.length, 'membros processados');
                return resultado;
            }, [members, attendance]);
            
            // An√°lise de IA para identificar organiza√ß√µes com maior/menor dificuldade
            const analiseIA = useMemo(() => {
                if (!membersReport || membersReport.length === 0) {
                    return {
                        classes: [],
                        melhorOrganizacao: null,
                        piorOrganizacao: null,
                        recomendacoes: []
                    };
                }
                
                const analisePorClasse = {};
                
                membersReport.forEach(member => {
                    if (!member.classe) return;
                    if (!analisePorClasse[member.classe]) {
                        analisePorClasse[member.classe] = {
                            totalMembros: 0,
                            totalPresencas: 0,
                            totalFaltas: 0,
                            membros: []
                        };
                    }
                    analisePorClasse[member.classe].totalMembros++;
                    analisePorClasse[member.classe].totalPresencas += member.totalPresencas;
                    analisePorClasse[member.classe].totalFaltas += member.totalFaltas;
                    analisePorClasse[member.classe].membros.push({
                        nome: member.name,
                        presencas: member.totalPresencas,
                        faltas: member.totalFaltas,
                        total: member.totalPresencas + member.totalFaltas,
                        percentual: member.totalPresencas + member.totalFaltas > 0 
                            ? Math.round((member.totalPresencas / (member.totalPresencas + member.totalFaltas)) * 100)
                            : 0
                    });
                });

                const classesComAnalise = Object.entries(analisePorClasse).map(([classe, dados]) => {
                    const totalRegistros = dados.totalPresencas + dados.totalFaltas;
                    const taxaPresenca = totalRegistros > 0 
                        ? Math.round((dados.totalPresencas / totalRegistros) * 100)
                        : 0;
                    const taxaFalta = totalRegistros > 0
                        ? Math.round((dados.totalFaltas / totalRegistros) * 100)
                        : 0;
                    const mediaFaltasPorMembro = dados.totalMembros > 0
                        ? Math.round((dados.totalFaltas / dados.totalMembros) * 10) / 10
                        : 0;

                    return {
                        classe,
                        totalMembros: dados.totalMembros,
                        taxaPresenca,
                        taxaFalta,
                        mediaFaltasPorMembro,
                        totalFaltas: dados.totalFaltas,
                        totalPresencas: dados.totalPresencas,
                        temMelhorDesempenho: taxaPresenca > taxaFalta,
                        precisaAtencao: taxaFalta > taxaPresenca
                    };
                });

                // Separar organiza√ß√µes por desempenho
                const comMelhorDesempenho = classesComAnalise
                    .filter(c => c.temMelhorDesempenho)
                    .sort((a, b) => b.taxaPresenca - a.taxaPresenca); // Ordenar por maior taxa de presen√ßa
                
                const precisamAtencao = classesComAnalise
                    .filter(c => c.precisaAtencao)
                    .sort((a, b) => b.taxaFalta - a.taxaFalta); // Ordenar por maior taxa de falta

                const melhorOrganizacao = comMelhorDesempenho.length > 0 ? comMelhorDesempenho[0] : null;
                const piorOrganizacao = precisamAtencao.length > 0 ? precisamAtencao[0] : null;
                
                // Ordenar todas as organiza√ß√µes por prioridade de aten√ß√£o
                // Primeiro as que precisam de aten√ß√£o (ordenadas por maior taxa de falta)
                // Depois as que t√™m melhor desempenho (ordenadas por menor taxa de presen√ßa, ou seja, menos prioridade)
                const todasOrdenadasPorPrioridade = [
                    ...precisamAtencao, // Primeiro: quem precisa de aten√ß√£o (maior falta = maior prioridade)
                    ...comMelhorDesempenho.sort((a, b) => a.taxaPresenca - b.taxaPresenca) // Depois: quem tem melhor desempenho (menor presen√ßa = menos prioridade)
                ];

                // Gerar recomenda√ß√µes
                const recomendacoes = [];
                
                if (piorOrganizacao) {
                    recomendacoes.push({
                        tipo: 'alerta',
                        mensagem: `${piorOrganizacao.classe} est√° com maior dificuldade de frequ√™ncia (${piorOrganizacao.taxaFalta}% de faltas). Considere a√ß√µes espec√≠ficas para esta organiza√ß√£o.`
                    });
                }
                
                if (melhorOrganizacao && melhorOrganizacao !== piorOrganizacao) {
                    recomendacoes.push({
                        tipo: 'sucesso',
                        mensagem: `${melhorOrganizacao.classe} apresenta a melhor frequ√™ncia (${melhorOrganizacao.taxaPresenca}% de presen√ßas). Pode servir como refer√™ncia para outras organiza√ß√µes.`
                    });
                }

                classesComAnalise.forEach(classe => {
                    if (classe.taxaFalta > 30) {
                        recomendacoes.push({
                            tipo: 'atencao',
                            mensagem: `${classe.classe} tem taxa de falta acima de 30%. M√©dia de ${classe.mediaFaltasPorMembro} faltas por membro.`
                        });
                    }
                });

                return {
                    classes: classesComAnalise,
                    melhorOrganizacao,
                    piorOrganizacao,
                    todasOrdenadasPorPrioridade,
                    recomendacoes
                };
            }, [membersReport]);
            
            const classesReport = useMemo(() => {
                const classes = {};
                members.forEach(member => {
                    if (member.type === 'visitor') return;
                    const classe = determinarClasse(member.gender, member.birthDate);
                    if (classe) {
                        classes[classe] = (classes[classe] || 0) + 1;
                    }
                });
                return Object.entries(classes)
                    .sort((a, b) => b[1] - a[1])
                    .map(([classe, count]) => ({ classe, count }));
            }, [members]);
            
            // Relat√≥rio de faltas por classe
            const faltasPorClasse = useMemo(() => {
                const faltasPorClasseObj = {};
                
                membersReport.forEach(member => {
                    if (!member.classe) return;
                    if (!faltasPorClasseObj[member.classe]) {
                        faltasPorClasseObj[member.classe] = {
                            totalFaltas: 0,
                            membros: []
                        };
                    }
                    faltasPorClasseObj[member.classe].totalFaltas += member.totalFaltas;
                    faltasPorClasseObj[member.classe].membros.push({
                        nome: member.name,
                        faltas: member.totalFaltas
                    });
                });
                
                return Object.entries(faltasPorClasseObj)
                    .map(([classe, dados]) => ({
                        classe,
                        totalFaltas: dados.totalFaltas,
                        membros: dados.membros.sort((a, b) => b.faltas - a.faltas)
                    }))
                    .sort((a, b) => b.totalFaltas - a.totalFaltas);
            }, [membersReport]);
            
            // An√°lise de discursantes
            const analiseDiscursantes = useMemo(() => {
                if (!assignments || !Array.isArray(assignments) || assignments.length === 0) {
                    return {
                        discursantes: [],
                        naoDiscursaram: [],
                        totalDiscursos: 0
                    };
                }
                
                // Obter todos os membros (exceto visitantes)
                const todosMembros = members.filter(m => m.type !== 'visitor');
                
                // Mapa para armazenar informa√ß√µes de discursos por membro
                const discursosPorMembro = {};
                
                // Inicializar todos os membros
                todosMembros.forEach(member => {
                    discursosPorMembro[member.id] = {
                        memberId: member.id,
                        nome: member.name,
                        discursos: [],
                        totalDiscursos: 0
                    };
                });
                
                // Processar todos os assignments para encontrar discursos
                assignments.forEach(assignment => {
                    const dateStr = assignment.date || assignment.id;
                    if (!dateStr) return;
                    
                    // Formatar data para exibi√ß√£o
                    const dataFormatada = new Date(dateStr + 'T12:00:00').toLocaleDateString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                    
                    // Fun√ß√£o auxiliar para encontrar membro por ID (compat√≠vel com diferentes formatos)
                    const encontrarMembroPorId = (speakerId) => {
                        if (!speakerId) return null;
                        const speakerIdStr = String(speakerId);
                        // Tentar encontrar por ID exato
                        if (discursosPorMembro[speakerIdStr]) {
                            return speakerIdStr;
                        }
                        // Tentar encontrar por compara√ß√£o flex√≠vel
                        for (const memberId in discursosPorMembro) {
                            if (String(memberId) === speakerIdStr || memberId == speakerId) {
                                return memberId;
                            }
                        }
                        return null;
                    };
                    
                    // Verificar speaker1
                    if (assignment.speaker1) {
                        const memberId = encontrarMembroPorId(assignment.speaker1);
                        if (memberId && discursosPorMembro[memberId]) {
                            discursosPorMembro[memberId].discursos.push({
                                data: dateStr,
                                dataFormatada: dataFormatada,
                                posicao: '1¬∫'
                            });
                            discursosPorMembro[memberId].totalDiscursos++;
                        }
                    }
                    
                    // Verificar speaker2
                    if (assignment.speaker2) {
                        const memberId = encontrarMembroPorId(assignment.speaker2);
                        if (memberId && discursosPorMembro[memberId]) {
                            discursosPorMembro[memberId].discursos.push({
                                data: dateStr,
                                dataFormatada: dataFormatada,
                                posicao: '2¬∫'
                            });
                            discursosPorMembro[memberId].totalDiscursos++;
                        }
                    }
                });
                
                // Separar quem j√° discursou e quem n√£o discursou
                const discursantes = Object.values(discursosPorMembro)
                    .filter(m => m.totalDiscursos > 0)
                    .map(m => ({
                        ...m,
                        discursos: m.discursos.sort((a, b) => {
                            // Ordenar por data (mais recente primeiro)
                            return new Date(b.data + 'T12:00:00') - new Date(a.data + 'T12:00:00');
                        })
                    }))
                    .sort((a, b) => b.totalDiscursos - a.totalDiscursos); // Ordenar por total de discursos
                
                const naoDiscursaram = Object.values(discursosPorMembro)
                    .filter(m => m.totalDiscursos === 0)
                    .map(m => ({
                        nome: m.nome,
                        memberId: m.memberId
                    }))
                    .sort((a, b) => a.nome.localeCompare(b.nome)); // Ordenar alfabeticamente
                
                // Calcular total de discursos
                const totalDiscursos = assignments.reduce((total, assignment) => {
                    let count = 0;
                    if (assignment.speaker1) count++;
                    if (assignment.speaker2) count++;
                    return total + count;
                }, 0);
                
                return {
                    discursantes,
                    naoDiscursaram,
                    totalDiscursos
                };
            }, [assignments, members]);

            return (
                <div className="space-y-4 animate-fade-in">
                    <div className="bg-gradient-to-r from-blue-900 to-purple-800 p-5 rounded-2xl shadow-xl text-white">
                        <h2 className="font-bold text-xl font-serif mb-4">Relat√≥rios</h2>
                        <div className="flex flex-wrap gap-2">
                            <button 
                                onClick={() => gerarPDFDetalhadoMembros(membersReport, 'mensal')} 
                                className="bg-white/20 backdrop-blur-sm hover:bg-white/30 text-white px-4 py-2 rounded-lg text-xs font-semibold flex gap-2 items-center transition-all border border-white/30 hover:scale-105"
                            >
                                <Download size={14}/> Detalhado Mensal
                            </button>
                            <button 
                                onClick={() => gerarPDFDetalhadoMembros(membersReport, 'semanal')} 
                                className="bg-white/20 backdrop-blur-sm hover:bg-white/30 text-white px-4 py-2 rounded-lg text-xs font-semibold flex gap-2 items-center transition-all border border-white/30 hover:scale-105"
                            >
                                <Download size={14}/> Detalhado Semanal
                            </button>
                        </div>
                    </div>
                    
                    {/* An√°lise de IA */}
                    {analiseIA.classes.length > 0 && (
                        <div className="bg-gradient-to-r from-indigo-50 to-purple-50 p-5 rounded-2xl border-2 border-indigo-200 shadow-md">
                            <h3 className="font-bold text-base mb-4 text-gray-900 flex items-center gap-2">
                                <TrendingUp size={18} className="text-indigo-600"/> An√°lise Inteligente de Frequ√™ncia
                            </h3>
                            
                            {analiseIA.melhorOrganizacao && (
                                <div className="bg-green-50 border-2 border-green-200 p-4 rounded-xl mb-3">
                                    <div className="flex items-center gap-2 mb-2">
                                        <Check size={20} className="text-green-600" />
                                        <h4 className="font-bold text-green-900">Melhor Desempenho</h4>
                                    </div>
                                    <p className="text-green-800 font-semibold">{analiseIA.melhorOrganizacao.classe}</p>
                                    <div className="flex gap-4 mt-2 text-sm">
                                        <span className="text-green-700">Presen√ßa: <strong>{analiseIA.melhorOrganizacao.taxaPresenca}%</strong></span>
                                        <span className="text-green-700">Falta: <strong>{analiseIA.melhorOrganizacao.taxaFalta}%</strong></span>
                                        <span className="text-green-700">Membros: <strong>{analiseIA.melhorOrganizacao.totalMembros}</strong></span>
                                    </div>
                                </div>
                            )}
                            
                            {analiseIA.piorOrganizacao && analiseIA.piorOrganizacao !== analiseIA.melhorOrganizacao && (
                                <div className="bg-red-50 border-2 border-red-200 p-4 rounded-xl mb-3">
                                    <div className="flex items-center gap-2 mb-2">
                                        <AlertCircle size={20} className="text-red-600" />
                                        <h4 className="font-bold text-red-900">Precisa de Aten√ß√£o</h4>
                                    </div>
                                    <p className="text-red-800 font-semibold">{analiseIA.piorOrganizacao.classe}</p>
                                    <div className="flex gap-4 mt-2 text-sm">
                                        <span className="text-red-700">Presen√ßa: <strong>{analiseIA.piorOrganizacao.taxaPresenca}%</strong></span>
                                        <span className="text-red-700">Falta: <strong>{analiseIA.piorOrganizacao.taxaFalta}%</strong></span>
                                        <span className="text-red-700">M√©dia de faltas/membro: <strong>{analiseIA.piorOrganizacao.mediaFaltasPorMembro}</strong></span>
                                    </div>
                                </div>
                            )}
                            
                            {analiseIA.recomendacoes.length > 0 && (
                                <div className="bg-white border border-gray-200 p-4 rounded-xl mb-4">
                                    <h4 className="font-bold text-sm text-gray-900 mb-2">Recomenda√ß√µes:</h4>
                                    <div className="space-y-2">
                                        {analiseIA.recomendacoes.map((rec, idx) => (
                                            <div key={idx} className={`text-xs p-2 rounded-lg ${
                                                rec.tipo === 'alerta' ? 'bg-red-50 text-red-800 border border-red-200' :
                                                rec.tipo === 'sucesso' ? 'bg-green-50 text-green-800 border border-green-200' :
                                                'bg-amber-50 text-amber-800 border border-amber-200'
                                            }`}>
                                                {rec.mensagem}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            {/* Lista de Prioridades */}
                            {analiseIA.todasOrdenadasPorPrioridade && analiseIA.todasOrdenadasPorPrioridade.length > 0 && (
                                <div className="bg-white border border-gray-200 p-4 rounded-xl">
                                    <h4 className="font-bold text-sm text-gray-900 mb-3 flex items-center gap-2">
                                        <AlertCircle size={16} className="text-orange-600" />
                                        Prioridade de Aten√ß√£o (da maior para menor)
                                    </h4>
                                    <div className="space-y-2">
                                        {analiseIA.todasOrdenadasPorPrioridade.map((org, idx) => {
                                            const precisaAtencao = org.precisaAtencao;
                                            const getPriorityColor = () => {
                                                if (precisaAtencao) {
                                                    if (org.taxaFalta >= 50) return 'bg-red-100 border-red-300 text-red-900';
                                                    if (org.taxaFalta >= 30) return 'bg-orange-100 border-orange-300 text-orange-900';
                                                    return 'bg-yellow-100 border-yellow-300 text-yellow-900';
                                                }
                                                return 'bg-green-100 border-green-300 text-green-900';
                                            };
                                            
                                            return (
                                                <div key={idx} className={`border-2 rounded-lg p-3 ${getPriorityColor()}`}>
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex items-center gap-2">
                                                            <span className="font-bold text-lg w-8 h-8 rounded-full bg-white/50 flex items-center justify-center border-2">
                                                                {idx + 1}
                                                            </span>
                                                            <div>
                                                                <p className="font-bold text-sm">{org.classe}</p>
                                                                <div className="flex gap-3 text-xs mt-1">
                                                                    <span>Presen√ßa: <strong>{org.taxaPresenca}%</strong></span>
                                                                    <span>Falta: <strong>{org.taxaFalta}%</strong></span>
                                                                    <span>Membros: <strong>{org.totalMembros}</strong></span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {precisaAtencao && (
                                                            <span className="text-xs font-bold bg-red-200 text-red-900 px-2 py-1 rounded-full">
                                                                Precisa Ajuda
                                                            </span>
                                                        )}
                                                        {!precisaAtencao && (
                                                            <span className="text-xs font-bold bg-green-200 text-green-900 px-2 py-1 rounded-full">
                                                                Bom Desempenho
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                    <div className="bg-white p-5 rounded-2xl border border-gray-200 shadow-md">
                        <h3 className="font-bold text-base mb-4 text-gray-900 flex items-center gap-2">
                            <Users size={18} className="text-indigo-600"/> Distribui√ß√£o por Classe/Organiza√ß√£o
                        </h3>
                        {classesReport.length === 0 ? (
                            <p className="text-gray-400 text-sm italic">Cadastre g√™nero e data de nascimento dos membros para ver a distribui√ß√£o</p>
                        ) : (
                            <div className="space-y-2">
                                {classesReport.map(({ classe, count }) => {
                                    const getClasseColor = (classe) => {
                                        if (classe.includes('Elderes')) return 'bg-blue-50 text-blue-900 border-blue-200';
                                        if (classe.includes('Sacerdotes')) return 'bg-purple-50 text-purple-900 border-purple-200';
                                        if (classe.includes('Mestres')) return 'bg-indigo-50 text-indigo-900 border-indigo-200';
                                        if (classe.includes('Di√°conos')) return 'bg-cyan-50 text-cyan-900 border-cyan-200';
                                        if (classe.includes('Mo√ßas')) return 'bg-pink-50 text-pink-900 border-pink-200';
                                        if (classe.includes('Sociedade')) return 'bg-rose-50 text-rose-900 border-rose-200';
                                        if (classe.includes('Prim√°ria')) return 'bg-yellow-50 text-yellow-900 border-yellow-200';
                                        return 'bg-gray-50 text-gray-900 border-gray-200';
                                    };
                                    return (
                                        <div key={classe} className={`flex justify-between items-center p-3 rounded-xl border ${getClasseColor(classe)}`}>
                                            <span className="font-semibold text-sm">{classe}</span>
                                            <span className="font-bold text-lg">{count} {count === 1 ? 'membro' : 'membros'}</span>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                    
                    {/* An√°lise de Discursantes */}
                    <div className="bg-white p-5 rounded-2xl border border-gray-200 shadow-md">
                        <h3 className="font-bold text-base mb-4 text-gray-900 flex items-center gap-2">
                            <Mic size={18} className="text-purple-600"/> An√°lise de Discursantes
                        </h3>
                        
                        {analiseDiscursantes.totalDiscursos === 0 ? (
                            <p className="text-gray-400 text-sm italic">Nenhum discurso registrado ainda</p>
                        ) : (
                            <div className="space-y-4">
                                {/* Resumo */}
                                <div className="bg-gradient-to-r from-purple-50 to-indigo-50 p-4 rounded-xl border border-purple-200">
                                    <div className="flex flex-wrap gap-4 text-sm">
                                        <div>
                                            <span className="text-gray-600">Total de discursos:</span>
                                            <span className="font-bold text-purple-900 ml-2">{analiseDiscursantes.totalDiscursos}</span>
                                        </div>
                                        <div>
                                            <span className="text-gray-600">J√° discursaram:</span>
                                            <span className="font-bold text-green-700 ml-2">{analiseDiscursantes.discursantes.length}</span>
                                        </div>
                                        <div>
                                            <span className="text-gray-600">Ainda n√£o discursaram:</span>
                                            <span className="font-bold text-orange-700 ml-2">{analiseDiscursantes.naoDiscursaram.length}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Quem j√° discursou */}
                                {analiseDiscursantes.discursantes.length > 0 && (
                                    <div>
                                        <h4 className="font-semibold text-sm text-gray-900 mb-3 flex items-center gap-2">
                                            <CheckCircle size={16} className="text-green-600"/> Quem j√° discursou ({analiseDiscursantes.discursantes.length})
                                        </h4>
                                        <div className="space-y-2 max-h-96 overflow-y-auto">
                                            {analiseDiscursantes.discursantes.map((discursante, idx) => (
                                                <div key={discursante.memberId} className="border border-gray-200 rounded-xl p-4 hover:shadow-md transition-all bg-green-50/50">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex-1">
                                                            <h5 className="font-bold text-gray-900">{discursante.nome}</h5>
                                                            <p className="text-xs text-gray-600 mt-1">
                                                                Total: <strong>{discursante.totalDiscursos}</strong> {discursante.totalDiscursos === 1 ? 'discurso' : 'discursos'}
                                                            </p>
                                                        </div>
                                                        <div className="text-right">
                                                            <span className="bg-green-100 text-green-800 text-xs font-semibold px-2 py-1 rounded-full">
                                                                {discursante.totalDiscursos}x
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div className="mt-2 pt-2 border-t border-gray-200">
                                                        <p className="text-xs font-semibold text-gray-700 mb-1">Datas dos discursos:</p>
                                                        <div className="flex flex-wrap gap-2">
                                                            {discursante.discursos.map((discurso, dIdx) => (
                                                                <span 
                                                                    key={dIdx}
                                                                    className="bg-white border border-purple-200 text-purple-800 text-xs px-2 py-1 rounded-lg font-medium"
                                                                >
                                                                    {discurso.dataFormatada} ({discurso.posicao})
                                                                </span>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                
                                {/* Quem ainda n√£o discursou */}
                                {analiseDiscursantes.naoDiscursaram.length > 0 && (
                                    <div>
                                        <h4 className="font-semibold text-sm text-gray-900 mb-3 flex items-center gap-2">
                                            <AlertCircle size={16} className="text-orange-600"/> Quem ainda n√£o discursou ({analiseDiscursantes.naoDiscursaram.length})
                                        </h4>
                                        <div className="space-y-2 max-h-64 overflow-y-auto">
                                            {analiseDiscursantes.naoDiscursaram.map((membro, idx) => (
                                                <div key={membro.memberId} className="border border-orange-200 rounded-xl p-3 hover:shadow-md transition-all bg-orange-50/50">
                                                    <div className="flex items-center justify-between">
                                                        <span className="font-medium text-gray-900">{membro.nome}</span>
                                                        <span className="text-xs text-orange-700 bg-orange-100 px-2 py-1 rounded-full font-semibold">
                                                            Pendente
                                                        </span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                    
                    {/* Relat√≥rio Detalhado por Membro */}
                    <div className="bg-white p-5 rounded-2xl border border-gray-200 shadow-md">
                        <h3 className="font-bold text-base mb-4 text-gray-900 flex items-center gap-2">
                            <ClipboardList size={18} className="text-green-600"/> Relat√≥rio Detalhado por Membro
                        </h3>
                        {membersReport.length === 0 ? (
                            <p className="text-gray-400 text-sm italic">Nenhum membro cadastrado</p>
                        ) : (
                            <div className="space-y-4 max-h-96 overflow-y-auto">
                                {membersReport.map(member => (
                                    <div key={member.id} className="border border-gray-200 rounded-xl p-4 hover:shadow-md transition-all">
                                        <div className="flex justify-between items-start mb-3">
                                            <div>
                                                <h4 className="font-bold text-gray-900">{member.name}</h4>
                                                {member.classe && (
                                                    <span className="text-xs text-gray-500 mt-1 block">{member.classe}</span>
                                                )}
                                            </div>
                                            <div className="text-right">
                                                <div className="text-green-600 font-bold text-sm">
                                                    {member.totalPresencas} {member.totalPresencas === 1 ? 'presen√ßa' : 'presen√ßas'}
                                                </div>
                                                <div className="text-red-600 font-bold text-sm">
                                                    {member.totalFaltas} {member.totalFaltas === 1 ? 'falta' : 'faltas'}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {member.presencas.length > 0 && (
                                            <div className="mb-2">
                                                <p className="text-xs font-semibold text-green-700 mb-1">‚úì Quando veio:</p>
                                                <div className="flex flex-wrap gap-1">
                                                    {member.presencas.map((data, idx) => (
                                                        <span key={idx} className="text-xs bg-green-50 text-green-700 px-2 py-1 rounded border border-green-200">
                                                            {data}
                                                        </span>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                        
                                        {member.faltas.length > 0 && (
                                            <div>
                                                <p className="text-xs font-semibold text-red-700 mb-1">‚úó Quando faltou:</p>
                                                <div className="flex flex-wrap gap-1">
                                                    {member.faltas.map((data, idx) => (
                                                        <span key={idx} className="text-xs bg-red-50 text-red-700 px-2 py-1 rounded border border-red-200">
                                                            {data}
                                                        </span>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                        
                                        {member.presencas.length === 0 && member.faltas.length === 0 && (
                                            <p className="text-xs text-gray-400 italic">Nenhum registro de frequ√™ncia</p>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    
                    {/* Relat√≥rio de Faltas por Classe */}
                    <div className="bg-white p-5 rounded-2xl border border-gray-200 shadow-md">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-base text-gray-900 flex items-center gap-2">
                                <AlertCircle size={18} className="text-red-600"/> Faltas por Classe/Organiza√ß√£o
                            </h3>
                            <div className="flex gap-2">
                                <button 
                                    onClick={() => gerarPDFFaltasPorClasse(faltasPorClasse, 'mensal')} 
                                    className="bg-red-50 hover:bg-red-100 text-red-700 px-3 py-1.5 rounded-lg text-xs font-semibold flex gap-1 items-center transition-all border border-red-200 hover:scale-105"
                                >
                                    <Printer size={12}/> PDF Mensal
                                </button>
                                <button 
                                    onClick={() => gerarPDFFaltasPorClasse(faltasPorClasse, 'trimestral')} 
                                    className="bg-red-50 hover:bg-red-100 text-red-700 px-3 py-1.5 rounded-lg text-xs font-semibold flex gap-1 items-center transition-all border border-red-200 hover:scale-105"
                                >
                                    <Printer size={12}/> PDF Trimestral
                                </button>
                            </div>
                        </div>
                        {faltasPorClasse.length === 0 ? (
                            <p className="text-gray-400 text-sm italic">Nenhum dado dispon√≠vel</p>
                        ) : (
                            <div className="space-y-4">
                                {faltasPorClasse.map(({ classe, totalFaltas, membros }) => {
                                    const getClasseColor = (classe) => {
                                        if (classe.includes('Elderes')) return 'bg-blue-50 border-blue-200 text-blue-900';
                                        if (classe.includes('Sacerdotes')) return 'bg-purple-50 border-purple-200 text-purple-900';
                                        if (classe.includes('Mestres')) return 'bg-indigo-50 border-indigo-200 text-indigo-900';
                                        if (classe.includes('Di√°conos')) return 'bg-cyan-50 border-cyan-200 text-cyan-900';
                                        if (classe.includes('Mo√ßas')) return 'bg-pink-50 border-pink-200 text-pink-900';
                                        if (classe.includes('Sociedade')) return 'bg-rose-50 border-rose-200 text-rose-900';
                                        if (classe.includes('Prim√°ria')) return 'bg-yellow-50 border-yellow-200 text-yellow-900';
                                        return 'bg-gray-50 border-gray-200 text-gray-900';
                                    };
                                    
                                    return (
                                        <div key={classe} className={`border-2 rounded-xl p-4 ${getClasseColor(classe)}`}>
                                            <div className="flex justify-between items-center mb-3">
                                                <h4 className="font-bold text-base">{classe}</h4>
                                                <div className="bg-red-100 text-red-800 px-3 py-1 rounded-lg font-bold text-sm">
                                                    Total: {totalFaltas} {totalFaltas === 1 ? 'falta' : 'faltas'}
                                                </div>
                                            </div>
                                            <div className="space-y-2">
                                                {membros.map((m, idx) => (
                                                    <div key={idx} className="flex justify-between items-center bg-white/50 rounded-lg px-3 py-2 border border-white/50">
                                                        <span className="font-medium text-sm">{m.nome}</span>
                                                        <span className={`font-bold text-sm ${m.faltas > 0 ? 'text-red-600' : 'text-green-600'}`}>
                                                            {m.faltas} {m.faltas === 1 ? 'falta' : 'faltas'}
                                                        </span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function MemberPickerModal({ role, members, onClose, onSelect, currentDateStr }) {
            const [s, setS] = useState('');
            const filtered = members.filter(m => m.name.toLowerCase().includes(s.toLowerCase()));
            const getWarn = (m) => {
                if(!m.lastSpoken) return null;
                const d1 = new Date(m.lastSpoken); const d2 = new Date(currentDateStr);
                if(d1.getMonth()===d2.getMonth() && d1.getFullYear()===d2.getFullYear()) return "Falou este m√™s";
                return null;
            };
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white w-full max-w-md h-[70vh] rounded-2xl flex flex-col shadow-2xl border border-gray-200 animate-slide-up">
                        <div className="p-4 border-b border-gray-200 flex justify-between items-center bg-gradient-to-r from-gray-50 to-white">
                            <span className="font-bold text-gray-900">Selecionar Membro</span>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-200 transition-all">
                                <X size={20} />
                            </button>
                        </div>
                        <div className="p-3 bg-gray-50 border-b border-gray-200">
                            <input 
                                autoFocus 
                                value={s} 
                                onChange={e=>setS(e.target.value)} 
                                className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none transition-all" 
                                placeholder="Buscar membro..." 
                            />
                        </div>
                        <div className="flex-1 overflow-y-auto p-2">
                            {filtered.map(m => {
                                const w = getWarn(m);
                                return (
                                    <button 
                                        key={m.id} 
                                        onClick={()=>onSelect(m.id)} 
                                        className="w-full text-left p-4 border-b border-gray-100 hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 transition-all rounded-lg m-1"
                                    >
                                        <div className="font-bold text-gray-900">{m.name}</div>
                                        <div className="text-xs text-gray-500 mt-1">
                                            {m.calling} 
                                            {w && <span className="text-red-500 font-bold ml-2 bg-red-50 px-2 py-0.5 rounded-full">{w}</span>}
                                        </div>
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        }

        // Componente de Gerenciamento de Usu√°rios
        function UserManager({ unidadeId, unidadeUsers, driveFolderId, onClose, onPendingRequestsChange }) {
            const [email, setEmail] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            const [invitedEmails, setInvitedEmails] = useState([]);
            const [pendingRequests, setPendingRequests] = useState([]);

            // Carregar lista de emails convidados e solicita√ß√µes pendentes ao montar o componente
            useEffect(() => {
                const loadData = async () => {
                    // Carregar solicita√ß√µes pendentes do Firestore
                    try {
                        const requests = await buscarSolicitacoesPendentesFirestore(unidadeId);
                        setPendingRequests(requests);
                        console.log(`‚úÖ ${requests.length} solicita√ß√µes pendentes encontradas`);
                        
                        // Atualizar contador no componente pai
                        if (onPendingRequestsChange) {
                            onPendingRequestsChange(requests.length);
                        }
                    } catch (e) {
                        console.error('Erro ao carregar solicita√ß√µes:', e);
                        setPendingRequests([]);
                        if (onPendingRequestsChange) {
                            onPendingRequestsChange(0);
                        }
                    }
                    
                    // Carregar emails convidados do Drive (se dispon√≠vel)
                    if (driveFolderId) {
                        try {
                            const invitations = await carregarDoDrive(driveFolderId, 'invited_emails');
                            if (invitations && Array.isArray(invitations)) {
                                setInvitedEmails(invitations);
                            }
                        } catch (e) {
                            setInvitedEmails([]);
                        }
                    }
                };
                loadData();
            }, [unidadeId, driveFolderId]);

            const handleInvite = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                setSuccess('');
                
                try {
                    const emailLower = email.toLowerCase().trim();
                    
                    // Verificar se o email j√° est√° cadastrado como usu√°rio ATIVO que J√Å FEZ LOGIN
                    // (tem UID e status approved, n√£o apenas na lista de convites)
                    let isActiveUser = false;
                    
                    // Verificar no localStorage (unidadeUsers)
                    const existingUser = unidadeUsers.find(u => {
                        const uEmail = (u.email || '').toLowerCase().trim();
                        return uEmail === emailLower && 
                               u.id && // Tem UID = j√° fez login
                               u.status === 'approved' && 
                               u.unidadeId === unidadeId &&
                               u.status !== 'removed';
                    });
                    
                    if (existingUser) {
                        isActiveUser = true;
                    }
                    
                    // Verificar tamb√©m no Drive para ter certeza
                    if (!isActiveUser && driveFolderId) {
                        try {
                            const usersData = await carregarDoDrive(driveFolderId, 'users_data');
                            if (usersData && Array.isArray(usersData)) {
                                const driveUser = usersData.find(u => {
                                    const uEmail = (u.email || '').toLowerCase().trim();
                                    return uEmail === emailLower && 
                                           u.id && // Tem UID = j√° fez login
                                           u.status === 'approved' && 
                                           u.unidadeId === unidadeId &&
                                           u.status !== 'removed';
                                });
                                
                                if (driveUser) {
                                    isActiveUser = true;
                                }
                            }
                        } catch (e) {
                            console.warn("Erro ao verificar usu√°rios no Drive:", e);
                            // Continuar mesmo se houver erro
                        }
                    }
                    
                    if (isActiveUser) {
                        setError('Este email j√° est√° cadastrado como usu√°rio ativo que j√° fez login. Se a pessoa n√£o consegue entrar, verifique se ela est√° usando o mesmo email do Google.');
                        setLoading(false);
                        return;
                    }
                    
                    // Se j√° est√° na lista de convites mas n√£o fez login ainda, permitir reconvidar
                    // (isso atualiza o compartilhamento do Drive)
                    const alreadyInvited = invitedEmails.includes(emailLower);
                    if (alreadyInvited) {
                        console.log('üìß Email j√° est√° na lista de convites, atualizando compartilhamento...');
                    }
                    
                    // Adicionar email √† lista de convites (ou manter se j√° estiver)
                    let newInvitedEmails;
                    if (alreadyInvited) {
                        newInvitedEmails = invitedEmails; // Manter lista existente
                    } else {
                        newInvitedEmails = [...invitedEmails, emailLower];
                        setInvitedEmails(newInvitedEmails);
                    }
                    
                    // Salvar no Drive
                    if (driveFolderId) {
                        await salvarNoDrive(driveFolderId, 'invited_emails', newInvitedEmails);
                        
                        // Compartilhar a pasta do Drive com o usu√°rio convidado
                        try {
                            const token = await getGoogleAccessToken();
                            if (!token) {
                                console.warn('‚ö†Ô∏è Token do Drive n√£o dispon√≠vel para compartilhar pasta');
                                throw new Error('Token do Drive n√£o dispon√≠vel');
                            }
                            const shareResponse = await fetch(
                                `${DRIVE_API_BASE}/files/${driveFolderId}/permissions`,
                                {
                                    method: 'POST',
                                    headers: {
                                        'Authorization': `Bearer ${token}`,
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        role: 'writer', // Permiss√£o de escrita para editar dados
                                        type: 'user',
                                        emailAddress: email,
                                        sendNotificationEmail: false // N√£o enviar email autom√°tico do Google
                                    })
                                }
                            );
                            
                            if (shareResponse.ok) {
                                const shareData = await shareResponse.json();
                                console.log('‚úÖ Pasta compartilhada com sucesso com', email, 'Permission ID:', shareData.id);
                            } else {
                                const errorText = await shareResponse.text();
                                console.warn('‚ö†Ô∏è Erro ao compartilhar pasta:', shareResponse.status, errorText);
                                // Continuar mesmo se o compartilhamento falhar - o usu√°rio pode ter acesso via convite
                            }
                        } catch (e) {
                            console.warn('‚ö†Ô∏è Erro ao compartilhar pasta:', e);
                            // Continuar mesmo se o compartilhamento falhar
                        }
                    }
                    
                    // Preparar email de convite
                    const emailSubject = encodeURIComponent('Convite para Sistema Sacramental LDS');
                    const emailBody = encodeURIComponent(`Ol√°!

Voc√™ foi convidado para acessar o Sistema Sacramental LDS.

Para acessar:
1. Acesse: ${window.location.origin}${window.location.pathname}
2. Clique em "Continuar com Google"
3. Use o mesmo email do convite: ${email}

Ap√≥s fazer login com Google, voc√™ ter√° acesso autom√°tico √† unidade e poder√° visualizar e editar os dados.

Atenciosamente,
Equipe Sacramental LDS`);
                    const mailtoLink = `mailto:${email}?subject=${emailSubject}&body=${emailBody}`;
                    
                    if (alreadyInvited) {
                        setSuccess(`Convite atualizado para ${email}! O compartilhamento do Drive foi renovado. A pessoa pode fazer login com Google usando este email.`);
                    } else {
                        setSuccess(`Convite enviado para ${email}! A pessoa pode fazer login com Google usando este email.`);
                    }
                    setEmail('');
                    
                    // Mostrar link para enviar email
                    const inviteModal = document.createElement('div');
                    inviteModal.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm';
                    inviteModal.innerHTML = `
                        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl border border-gray-200 p-6 animate-slide-up">
                            <h3 class="text-xl font-bold text-gray-900 mb-4">${alreadyInvited ? 'Convite Atualizado!' : 'Convite Criado!'}</h3>
                            <p class="text-sm text-gray-600 mb-4">O email <strong>${email}</strong> ${alreadyInvited ? 'j√° estava na lista de convidados e o compartilhamento foi renovado' : 'foi adicionado √† lista de convidados'}.</p>
                            <p class="text-xs text-gray-500 mb-4">A pessoa deve fazer login com Google usando este email para ter acesso autom√°tico.</p>
                            <div class="flex gap-3">
                                <a 
                                    href="${mailtoLink}" 
                                    target="_blank"
                                    class="flex-1 bg-green-600 text-white p-3 rounded-xl font-semibold hover:bg-green-700 transition-all text-center flex items-center justify-center"
                                >
                                    Enviar Email
                                </a>
                                <button 
                                    onclick="this.closest('.fixed').remove()"
                                    class="flex-1 bg-gray-200 text-gray-700 p-3 rounded-xl font-semibold hover:bg-gray-300 transition-all"
                                >
                                    Fechar
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(inviteModal);
                } catch (e) {
                    console.error('Erro ao enviar convite:', e);
                    setError('Erro ao enviar convite. Tente novamente.');
                }
                setLoading(false);
            };

            const handleRemoveInvite = async (invitedEmail) => {
                if (!confirm(`Remover o convite de ${invitedEmail}?`)) return;
                
                try {
                    setLoading(true);
                    const newInvitedEmails = invitedEmails.filter(e => e !== invitedEmail);
                    setInvitedEmails(newInvitedEmails);
                    
                    if (driveFolderId) {
                        await salvarNoDrive(driveFolderId, 'invited_emails', newInvitedEmails);
                    }
                    
                    setSuccess('Convite removido com sucesso!');
                    setLoading(false);
                } catch (e) {
                    setError('Erro ao remover convite.');
                    setLoading(false);
                }
            };

            const handleApprove = async (userId, requestId = null) => {
                try {
                    setLoading(true);
                    setError('');
                    setSuccess('');
                    
                    // Verificar se o usu√°rio atual √© admin
                    const currentUser = auth.currentUser;
                    if (!currentUser) {
                        setError('Voc√™ precisa estar logado para aprovar usu√°rios.');
                        setLoading(false);
                        return;
                    }
                    
                    // Buscar dados do usu√°rio atual (admin) para verificar role e unidadeId
                    const currentUserData = await carregarUsuarioFirestore(currentUser.uid, true);
                    if (!currentUserData || currentUserData.role !== 'admin') {
                        setError('Apenas administradores podem aprovar usu√°rios.');
                        setLoading(false);
                        return;
                    }
                    
                    console.log('üë§ Admin aprovando:', {
                        adminId: currentUser.uid,
                        adminEmail: currentUser.email,
                        adminUnidadeId: currentUserData.unidadeId,
                        targetUserId: userId
                    });
                    
                    // Se requestId n√£o foi fornecido, buscar na lista de solicita√ß√µes pendentes
                    if (!requestId) {
                        const request = pendingRequests.find(r => r.userId === userId);
                        if (request && request.id) {
                            requestId = request.id;
                        }
                    }
                    
                    // Buscar dados do usu√°rio do Firestore (for√ßar refresh para pegar dados atualizados)
                    let userData = await carregarUsuarioFirestore(userId, true);
                    
                    // Se n√£o encontrou, tentar buscar da lista de usu√°rios da unidade ou da solicita√ß√£o
                    if (!userData) {
                        // Primeiro, tentar buscar da lista de usu√°rios da unidade
                        const userInList = unidadeUsers.find(u => u.id === userId);
                        if (userInList) {
                            userData = userInList;
                        } else {
                            // Se n√£o encontrou na lista, tentar buscar da solicita√ß√£o pendente
                            const request = pendingRequests.find(r => r.userId === userId);
                            if (request) {
                                userData = {
                                    id: userId,
                                    email: request.email,
                                    nome: request.nome || request.email.split('@')[0],
                                    unidadeId: unidadeId,
                                    role: 'user',
                                    status: 'pending',
                                    criadoEm: request.criadoEm?.toDate ? request.criadoEm.toDate().toISOString() : (request.criadoEm || new Date().toISOString())
                                };
                            } else {
                                setError('Usu√°rio n√£o encontrado. Verifique se o usu√°rio existe.');
                                setLoading(false);
                                return;
                            }
                        }
                    }
                    
                    // Garantir que temos os dados m√≠nimos necess√°rios
                    if (!userData.email) {
                        setError('Dados do usu√°rio incompletos. N√£o √© poss√≠vel aprovar.');
                        setLoading(false);
                        return;
                    }
                    
                    // Atualizar status do usu√°rio para aprovado no Firestore
                    userData.status = 'approved';
                    // Garantir que o unidadeId √© o mesmo do admin
                    userData.unidadeId = currentUserData.unidadeId || unidadeId;
                    userData.atualizadoEm = new Date().toISOString();
                    
                    console.log('üíæ Salvando usu√°rio no Firestore:', {
                        userId: userId,
                        unidadeId: userData.unidadeId,
                        status: userData.status,
                        adminUnidadeId: currentUserData.unidadeId
                    });
                    
                    // Salvar no Firestore (isso sobrescreve qualquer status anterior)
                    try {
                        await salvarUsuarioFirestore(userId, userData);
                        console.log('‚úÖ Usu√°rio aprovado no Firestore:', userId, 'Status:', userData.status);
                    } catch (e) {
                        console.error('‚ùå Erro ao salvar no Firestore:', e);
                        console.error('   - C√≥digo do erro:', e.code);
                        console.error('   - Mensagem:', e.message);
                        
                        // Se der erro de permiss√£o, mostrar mensagem mais clara
                        const isPermissionError = e?.code === 'permission-denied' || 
                                                 e?.message?.includes('permission') ||
                                                 e?.message?.includes('Missing or insufficient permissions');
                        
                        if (isPermissionError) {
                            setError('Erro de permiss√£o: Voc√™ n√£o tem autoriza√ß√£o para aprovar este usu√°rio. Verifique se voc√™ √© admin e se as regras do Firestore est√£o configuradas corretamente. Veja CONFIGURAR_REGRAS_FIRESTORE.md');
                            setLoading(false);
                            return;
                        }
                        // Re-lan√ßar outros erros
                        throw e;
                    }
                    
                    // Atualizar localStorage tamb√©m (j√° foi feito no salvarUsuarioFirestore, mas garantimos aqui)
                    try {
                        localStorage.setItem(`user_${userId}`, JSON.stringify(userData));
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Erro ao atualizar localStorage:', e);
                    }
                    
                    // Se foi uma solicita√ß√£o pendente, atualizar no Firestore
                    if (requestId) {
                        await atualizarSolicitacaoFirestore(requestId, 'approved');
                        console.log('‚úÖ Solicita√ß√£o atualizada para approved:', requestId);
                    }
                    
                    // Recarregar lista de solicita√ß√µes pendentes
                    try {
                        const requests = await buscarSolicitacoesPendentesFirestore(unidadeId);
                        setPendingRequests(requests);
                        if (onPendingRequestsChange) {
                            onPendingRequestsChange(requests.length);
                        }
                        console.log('‚úÖ Lista de solicita√ß√µes recarregada');
                    } catch (e) {
                        console.error('Erro ao recarregar solicita√ß√µes:', e);
                    }
                    
                    // Atualizar a lista de usu√°rios localmente (atualizar o status do usu√°rio aprovado)
                    const updatedUsers = unidadeUsers.map(u => {
                        if (u.id === userId) {
                            return { ...u, status: 'approved', atualizadoEm: new Date().toISOString() };
                        }
                        return u;
                    });
                    // Note: n√£o podemos usar setUnidadeUsers aqui porque unidadeUsers √© um prop
                    // A lista ser√° atualizada quando a p√°gina recarregar
                    
                    // Compartilhar pasta do Drive com o usu√°rio (para dados dos membros)
                    if (driveFolderId && userData.email) {
                        try {
                            await solicitarAcessoDrive();
                            const token = await getGoogleAccessToken();
                            if (!token) {
                                console.warn('‚ö†Ô∏è Token do Drive n√£o dispon√≠vel para compartilhar pasta');
                                throw new Error('Token do Drive n√£o dispon√≠vel');
                            }
                            await fetch(
                                `${DRIVE_API_BASE}/files/${driveFolderId}/permissions`,
                                {
                                    method: 'POST',
                                    headers: {
                                        'Authorization': `Bearer ${token}`,
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        role: 'writer',
                                        type: 'user',
                                        emailAddress: userData.email,
                                        sendNotificationEmail: false
                                    })
                                }
                            );
                            console.log('‚úÖ Pasta do Drive compartilhada com:', userData.email);
                        } catch (e) {
                            console.warn('Erro ao compartilhar pasta do Drive (n√£o cr√≠tico):', e);
                        }
                    }
                    
                    setSuccess(`‚úÖ Usu√°rio ${userData.email || userData.nome || userId} aprovado com sucesso!`);
                    setLoading(false);
                    
                    // Recarregar a p√°gina ap√≥s 1.5 segundos para atualizar tudo
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } catch (e) {
                    console.error('‚ùå Erro ao aprovar usu√°rio:', e);
                    setError('Erro ao aprovar usu√°rio: ' + (e.message || 'Tente novamente.'));
                    setLoading(false);
                }
            };
            
            const handleRejectRequest = async (request) => {
                if (!confirm(`Rejeitar solicita√ß√£o de ${request.email}?`)) return;
                
                try {
                    setLoading(true);
                    
                    // Atualizar solicita√ß√£o no Firestore
                    if (request.id) {
                        await atualizarSolicitacaoFirestore(request.id, 'rejected');
                    }
                    
                    // Recarregar lista de solicita√ß√µes pendentes
                    try {
                        const requests = await buscarSolicitacoesPendentesFirestore(unidadeId);
                        setPendingRequests(requests);
                        if (onPendingRequestsChange) {
                            onPendingRequestsChange(requests.length);
                        }
                    } catch (e) {
                        console.error('Erro ao recarregar solicita√ß√µes:', e);
                    }
                    
                    setSuccess('Solicita√ß√£o rejeitada.');
                } catch (e) {
                    console.error('Erro ao rejeitar solicita√ß√£o:', e);
                    setError('Erro ao rejeitar solicita√ß√£o.');
                } finally {
                    setLoading(false);
                }
            };

            const handleRemove = async (userId) => {
                // Buscar dados do usu√°rio no Firestore
                let userData = await carregarUsuarioFirestore(userId);
                if (!userData) {
                    // Tentar do localStorage (migra√ß√£o)
                    const userDataStr = localStorage.getItem(`user_${userId}`);
                    if (userDataStr) {
                        userData = JSON.parse(userDataStr);
                    } else {
                        setError('Usu√°rio n√£o encontrado.');
                        return;
                    }
                }
                
                const userEmail = userData.email;
                
                if (!confirm(`Tem certeza que deseja remover o acesso de ${userEmail}?\n\nIsso ir√°:\n- Remover o acesso √† unidade\n- Remover o compartilhamento do Drive\n- O usu√°rio n√£o poder√° mais acessar os dados desta unidade`)) {
                    return;
                }
                
                try {
                    setLoading(true);
                    
                    // Remover compartilhamento do Drive (para dados dos membros)
                    if (driveFolderId && userEmail) {
                        try {
                            await solicitarAcessoDrive();
                            const token = await getGoogleAccessToken();
                            if (!token) {
                                console.warn('‚ö†Ô∏è Token do Drive n√£o dispon√≠vel para remover compartilhamento');
                                throw new Error('Token do Drive n√£o dispon√≠vel');
                            }
                            
                            // Buscar todas as permiss√µes da pasta
                            const permissionsResponse = await fetch(
                                `${DRIVE_API_BASE}/files/${driveFolderId}/permissions`,
                                {
                                    headers: { 'Authorization': `Bearer ${token}` },
                                }
                            );
                            
                            if (permissionsResponse.ok) {
                                const permissionsData = await permissionsResponse.json();
                                const userPermission = permissionsData.permissions?.find(
                                    p => p.emailAddress?.toLowerCase() === userEmail.toLowerCase()
                                );
                                
                                if (userPermission) {
                                    // Remover permiss√£o
                                    await fetch(
                                        `${DRIVE_API_BASE}/files/${driveFolderId}/permissions/${userPermission.id}`,
                                        {
                                            method: 'DELETE',
                                            headers: { 'Authorization': `Bearer ${token}` },
                                        }
                                    );
                                    console.log('‚úÖ Permiss√£o do Drive removida para', userEmail);
                                }
                            }
                        } catch (e) {
                            console.warn('‚ö†Ô∏è Erro ao remover permiss√£o do Drive:', e);
                            // Continuar mesmo se falhar
                        }
                    }
                    
                    // Atualizar dados do usu√°rio no Firestore
                    userData.unidadeId = null;
                    userData.status = 'removed';
                    userData.removidoEm = new Date().toISOString();
                    await salvarUsuarioFirestore(userId, userData);
                    
                    // Salvar no localStorage para compatibilidade
                    localStorage.setItem(`user_${userId}`, JSON.stringify(userData));
                    
                    setSuccess(`Acesso de ${userEmail} removido com sucesso!`);
                    setLoading(false);
                    
                    // Recarregar lista de usu√°rios ap√≥s um pequeno delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } catch (e) {
                    console.error('Erro ao remover usu√°rio:', e);
                    setError('Erro ao remover usu√°rio. Tente novamente.');
                    setLoading(false);
                }
            };

            // Mostrar todos os usu√°rios (exceto removidos)
            const allActiveUsers = unidadeUsers.filter(u => u.status !== 'removed');

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white w-full max-w-md rounded-2xl p-5 shadow-2xl border border-gray-200 animate-slide-up max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between mb-4 items-center">
                            <span className="font-bold text-lg text-gray-900">Gerenciar Usu√°rios</span>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-200 transition-all">
                                <X size={20} />
                            </button>
                        </div>

                        {error && (
                            <div className="bg-red-50 border-2 border-red-200 text-red-800 p-3 rounded-xl mb-4 text-sm">
                                {error}
                            </div>
                        )}

                        {success && (
                            <div className="bg-green-50 border-2 border-green-200 text-green-800 p-3 rounded-xl mb-4 text-sm">
                                {success}
                            </div>
                        )}

                        <div className="mb-6 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl border-2 border-blue-200">
                            <h3 className="font-bold text-base text-gray-900 mb-3 flex items-center gap-2">
                                <Plus size={18} className="text-blue-600" />
                                Convidar Usu√°rio
                            </h3>
                            <form onSubmit={handleInvite} className="space-y-3">
                                <div className="flex gap-2">
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={e => setEmail(e.target.value)}
                                        placeholder="email@exemplo.com"
                                        className="flex-1 border-2 border-gray-200 rounded-xl p-3 focus:border-blue-500 focus:outline-none transition-all"
                                        required
                                    />
                                    <button
                                        type="submit"
                                        disabled={loading}
                                        className="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-4 py-3 rounded-xl hover:shadow-lg hover:scale-105 transition-all disabled:opacity-50"
                                        title="Criar usu√°rio"
                                    >
                                        {loading ? '...' : <Plus size={20} />}
                                    </button>
                                </div>
                                <p className="text-xs text-gray-600">A pessoa receber√° um convite e poder√° fazer login com Google usando este email.</p>
                            </form>
                        </div>

                        {/* Lista de Solicita√ß√µes Pendentes */}
                        {pendingRequests.length > 0 ? (
                            <div className="mb-6 p-5 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border-2 border-blue-300 shadow-md">
                                <div className="flex items-center justify-between mb-3">
                                    <h4 className="font-bold text-base text-gray-900 flex items-center gap-2">
                                        <AlertCircle size={18} className="text-blue-600" />
                                        Solicita√ß√µes de Acesso Pendentes
                                        <span className="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">
                                            {pendingRequests.length}
                                        </span>
                                    </h4>
                                </div>
                                <p className="text-sm text-gray-700 mb-4">Usu√°rios que solicitaram acesso √† unidade. Aprove ou rejeite cada solicita√ß√£o:</p>
                                <div className="space-y-2">
                                    {pendingRequests.map((request, index) => (
                                        <div key={request.id || index} className="flex justify-between items-center p-4 bg-white border-2 border-blue-200 rounded-xl shadow-sm hover:shadow-md transition-all">
                                            <div className="flex-1">
                                                <p className="font-medium text-gray-900">{request.email}</p>
                                                {request.nome && (
                                                    <p className="text-xs text-gray-500">{request.nome}</p>
                                                )}
                                                {request.criadoEm && (
                                                    <p className="text-xs text-gray-400 mt-1">
                                                        Solicitado em {request.criadoEm.toDate ? request.criadoEm.toDate().toLocaleDateString('pt-BR') : new Date(request.criadoEm).toLocaleDateString('pt-BR')}
                                                    </p>
                                                )}
                                            </div>
                                            <div className="flex items-center gap-2 ml-3">
                                                <button
                                                    onClick={async () => {
                                                        await handleApprove(request.userId, request.id);
                                                    }}
                                                    disabled={loading}
                                                    className="bg-green-600 text-white px-3 py-1.5 rounded-lg text-xs font-semibold hover:bg-green-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                                    title="Aprovar solicita√ß√£o"
                                                >
                                                    {loading ? 'Aprovando...' : 'Aprovar'}
                                                </button>
                                                <button
                                                    onClick={() => handleRejectRequest(request)}
                                                    className="bg-red-600 text-white px-3 py-1.5 rounded-lg text-xs font-semibold hover:bg-red-700 transition-all"
                                                    title="Rejeitar solicita√ß√£o"
                                                >
                                                    Rejeitar
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div className="mb-6 p-4 bg-gray-50 rounded-xl border border-gray-200">
                                <p className="text-sm text-gray-500 text-center">‚úÖ Nenhuma solicita√ß√£o de acesso pendente</p>
                            </div>
                        )}

                        {/* Lista de Emails Convidados (ainda n√£o fizeram login) */}
                        {invitedEmails.length > 0 && (
                            <div className="mb-6 p-4 bg-amber-50 rounded-xl border-2 border-amber-200">
                                <h4 className="font-semibold text-sm text-gray-700 mb-2">Emails Convidados ({invitedEmails.length})</h4>
                                <p className="text-xs text-gray-600 mb-3">Estes emails foram convidados mas ainda n√£o fizeram login:</p>
                                <div className="space-y-2">
                                    {invitedEmails.map(invitedEmail => {
                                        // Verificar se √© um usu√°rio ATIVO (aprovado, n√£o removido, mesma unidade)
                                        const isActiveUser = unidadeUsers.some(u => {
                                            const uEmail = (u.email || '').toLowerCase().trim();
                                            return uEmail === invitedEmail.toLowerCase() && 
                                                   u.status === 'approved' && 
                                                   u.unidadeId === unidadeId &&
                                                   u.status !== 'removed';
                                        });
                                        return (
                                            <div key={invitedEmail} className="flex justify-between items-center p-3 bg-white border border-amber-200 rounded-xl">
                                                <div className="flex-1">
                                                    <p className="font-medium text-gray-900">{invitedEmail}</p>
                                                    <p className="text-xs text-gray-500">
                                                        {isActiveUser ? '‚úÖ J√° fez login e est√° ativo' : '‚è≥ Aguardando login'}
                                                    </p>
                                                </div>
                                                {!isActiveUser && (
                                                    <button
                                                        onClick={() => handleRemoveInvite(invitedEmail)}
                                                        className="text-red-600 hover:text-red-700 p-2 rounded-full hover:bg-red-50 transition-all ml-2"
                                                        title="Remover convite"
                                                    >
                                                        <Trash2 size={16} />
                                                    </button>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* Lista de Todos os Usu√°rios Cadastrados */}
                        <div className="mt-6 border-t border-gray-200 pt-4">
                            <h3 className="font-bold text-base text-gray-900 mb-3 flex items-center gap-2">
                                <Users size={18} className="text-blue-600" />
                                Todos os Usu√°rios Cadastrados ({allActiveUsers.length})
                            </h3>
                            
                            {allActiveUsers.length > 0 ? (
                                <div className="space-y-2">
                                    {allActiveUsers.map(u => {
                                        const getStatusBadge = () => {
                                            if (u.role === 'admin') {
                                                return <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full font-semibold">Admin</span>;
                                            }
                                            if (u.status === 'pending') {
                                                return <span className="text-xs bg-amber-100 text-amber-800 px-2 py-0.5 rounded-full font-semibold">Aguardando</span>;
                                            }
                                            if (u.status === 'approved') {
                                                return <span className="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full font-semibold">Ativo</span>;
                                            }
                                            return <span className="text-xs bg-gray-100 text-gray-800 px-2 py-0.5 rounded-full font-semibold">{u.status || 'Desconhecido'}</span>;
                                        };

                                        const getCardColor = () => {
                                            if (u.role === 'admin') return 'bg-yellow-50 border-yellow-200';
                                            if (u.status === 'pending') return 'bg-amber-50 border-amber-200';
                                            if (u.status === 'approved') return 'bg-green-50 border-green-200';
                                            return 'bg-gray-50 border-gray-200';
                                        };

                                        return (
                                            <div key={u.id} className={`flex justify-between items-center p-3 ${getCardColor()} border rounded-xl hover:shadow-md transition-all`}>
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <p className="font-medium text-gray-900">{u.email}</p>
                                                        {getStatusBadge()}
                                                    </div>
                                                    <div className="flex gap-2 items-center flex-wrap">
                                                        {u.nome && (
                                                            <span className="text-xs text-gray-600">{u.nome}</span>
                                                        )}
                                                        {u.criadoEm && (
                                                            <span className="text-xs text-gray-400">
                                                                ‚Ä¢ Criado em {new Date(u.criadoEm).toLocaleDateString('pt-BR')}
                                                            </span>
                                                        )}
                                                        {u.criadoPor && (
                                                            <span className="text-xs text-gray-400">
                                                                ‚Ä¢ {u.criadoPor === 'admin' ? 'Criado pelo admin' : u.criadoPor === 'invite' ? 'Via convite' : ''}
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-2 ml-3">
                                                    {u.status === 'pending' && u.role !== 'admin' && (
                                                        <button
                                                            onClick={() => handleApprove(u.id)}
                                                            disabled={loading}
                                                            className="bg-green-600 text-white px-3 py-1.5 rounded-lg text-xs font-semibold hover:bg-green-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                                            title="Aprovar usu√°rio"
                                                        >
                                                            {loading ? 'Aprovando...' : 'Aprovar'}
                                                        </button>
                                                    )}
                                                    {u.role !== 'admin' && (
                                                        <button
                                                            onClick={() => handleRemove(u.id)}
                                                            className="text-red-600 hover:text-red-700 p-2 rounded-full hover:bg-red-50 transition-all"
                                                            title="Excluir usu√°rio e remover acesso"
                                                        >
                                                            <Trash2 size={16} />
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            ) : (
                                <div className="text-center py-8 text-gray-500">
                                    <Users size={32} className="mx-auto mb-2 opacity-50" />
                                    <p className="text-sm">Nenhum usu√°rio cadastrado ainda.</p>
                                    <p className="text-xs mt-1">Use o formul√°rio acima para convidar o primeiro usu√°rio.</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function SettingsModal({ onClose, onDeleteUser, user }) {
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl border border-gray-200 p-6 animate-slide-up max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between mb-6 items-center">
                            <div>
                                <h2 className="text-2xl font-bold text-gray-900">Configura√ß√µes</h2>
                                <p className="text-sm text-gray-500 mt-1">Gerencie suas prefer√™ncias e conta</p>
                            </div>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-200 transition-all">
                                <X size={20} />
                            </button>
                        </div>
                        
                        <div className="space-y-4">
                            {/* Informa√ß√µes da Conta */}
                            <div className="bg-gray-50 rounded-xl p-4 border border-gray-200">
                                <h3 className="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                                    <Users size={18} className="text-blue-600" />
                                    Informa√ß√µes da Conta
                                </h3>
                                <div className="space-y-2 text-sm">
                                    <div>
                                        <span className="text-gray-600">Email:</span>
                                        <span className="ml-2 font-medium text-gray-900">{user?.email || 'N/A'}</span>
                                    </div>
                                    {user?.displayName && (
                                        <div>
                                            <span className="text-gray-600">Nome:</span>
                                            <span className="ml-2 font-medium text-gray-900">{user.displayName}</span>
                                        </div>
                                    )}
                                </div>
                            </div>
                            
                            {/* Zona de Perigo */}
                            <div className="bg-red-50 rounded-xl p-4 border-2 border-red-200">
                                <h3 className="font-semibold text-red-900 mb-3 flex items-center gap-2">
                                    <AlertCircle size={18} className="text-red-600" />
                                    Zona de Perigo
                                </h3>
                                <p className="text-sm text-red-700 mb-4">
                                    A√ß√µes nesta se√ß√£o s√£o permanentes e n√£o podem ser desfeitas.
                                </p>
                                <button
                                    onClick={() => {
                                        if (confirm('‚ö†Ô∏è ATEN√á√ÉO!\n\nVoc√™ est√° prestes a excluir sua conta permanentemente.\n\nEsta a√ß√£o ir√°:\n- Excluir sua conta do Firebase\n- Excluir seus dados do Firestore\n- Remover todos os dados locais\n\nEsta a√ß√£o N√ÉO pode ser desfeita!\n\nDeseja continuar?')) {
                                            onDeleteUser();
                                            onClose();
                                        }
                                    }}
                                    className="w-full bg-red-600 hover:bg-red-700 text-white px-4 py-3 rounded-xl font-semibold transition-all flex items-center justify-center gap-2 shadow-md hover:shadow-lg"
                                >
                                    <Trash2 size={18} />
                                    Excluir Minha Conta
                                </button>
                            </div>
                        </div>
                        
                        <div className="mt-6 flex justify-end">
                            <button
                                onClick={onClose}
                                className="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-xl font-semibold transition-all"
                            >
                                Fechar
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function CallingsManager({ availableCallings, onClose, user, driveFolderId, unidadeId }) {
            const [val, setVal] = useState('');
            const add = async (e) => { 
                e.preventDefault(); 
                if (!val.trim()) return;
                try {
                    const callingId = `calling_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    // Salvar no Firestore primeiro (sincroniza√ß√£o em tempo real)
                    try {
                        await salvarChamadoFirestore(unidadeId, callingId, { name: val, id: callingId });
                    } catch (e) {
                        console.warn('Erro ao salvar no Firestore, tentando Drive:', e);
                        // Fallback para Drive
                        await salvarNoDrive(driveFolderId, callingId, { name: val, id: callingId });
                    }
                    setVal('');
                } catch (e) {
                    console.error(e);
                    alert("Erro ao adicionar chamado: " + e.message);
                }
            };
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white w-full max-w-sm rounded-2xl p-5 shadow-2xl border border-gray-200 animate-slide-up">
                        <div className="flex justify-between mb-4 items-center">
                            <span className="font-bold text-lg text-gray-900">Gerenciar Chamados</span>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-200 transition-all">
                                <X size={20} />
                            </button>
                        </div>
                        <form onSubmit={add} className="flex gap-2 mb-4">
                            <input 
                                value={val} 
                                onChange={e=>setVal(e.target.value)} 
                                className="flex-1 border-2 border-gray-200 rounded-xl p-3 focus:border-blue-500 focus:outline-none transition-all" 
                                placeholder="Novo chamado..."
                            />
                            <button className="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-3 rounded-xl hover:shadow-lg hover:scale-105 transition-all">
                                <Plus size={20} />
                            </button>
                        </form>
                        <div className="max-h-60 overflow-y-auto space-y-1">
                            {availableCallings.map(c => (
                                <div key={c.id} className="flex justify-between items-center p-3 border-b border-gray-100 hover:bg-gray-50 rounded-lg transition-all">
                                    <span className="font-medium text-gray-700">{c.name}</span>
                                    <button 
                                        onClick={async ()=>{
                                            // Deletar do Firestore primeiro
                                            try {
                                                await deletarChamadoFirestore(unidadeId, c.id);
                                            } catch (e) {
                                                console.warn('Erro ao deletar do Firestore, tentando Drive:', e);
                                                // Fallback para Drive
                                                const fileName = c.id.startsWith('calling_') ? c.id : `calling_${c.id}`;
                                                await deletarDoDrive(driveFolderId, fileName);
                                            }
                                        }}
                                        className="text-gray-400 hover:text-red-500 transition-all p-1 rounded-full hover:bg-red-50"
                                    >
                                        <Trash2 size={16}/>
                                    </button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            )
        }

        // Fun√ß√£o para inicializar o app
        async function initApp() {
            try {
                console.log('üöÄ Iniciando renderiza√ß√£o do app...');
                
                // Verificar se React est√° dispon√≠vel
                if (typeof React === 'undefined') {
                    throw new Error('React n√£o est√° dispon√≠vel. Verifique se os m√≥dulos foram carregados corretamente.');
                }
                
                if (typeof createRoot === 'undefined') {
                    throw new Error('createRoot n√£o est√° dispon√≠vel. Verifique se react-dom/client foi carregado.');
                }
                
                const rootElement = document.getElementById('root');
                if (!rootElement) {
                    throw new Error('Elemento root n√£o encontrado');
                }
                
                // Esconder overlay de loading
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
                
                console.log('üì¶ Criando root do React...');
                const root = createRoot(rootElement);
                
                console.log('üé® Renderizando componente...');
                root.render(React.createElement(PlanejadorSacramental));
                console.log('‚úÖ App renderizado com sucesso');
            } catch (e) {
                console.error('‚ùå Erro ao renderizar app:', e);
                console.error('Stack:', e.stack);
                
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
                
                const rootElement = document.getElementById('root');
                if (rootElement) {
                    rootElement.innerHTML = `
                        <div style="padding: 40px; text-align: center; font-family: sans-serif; max-width: 800px; margin: 0 auto;">
                            <h2 style="color: #b91c1c; margin-bottom: 20px; font-size: 24px;">Erro ao carregar o aplicativo</h2>
                            <p style="color: #7f1d1d; margin-bottom: 15px; font-size: 16px;">${e.message || 'Erro desconhecido'}</p>
                            <pre style="background: #fef2f2; padding: 15px; border-radius: 8px; overflow: auto; text-align: left; font-size: 12px; color: #991b1b; margin: 20px 0;">${e.stack || 'Sem stack trace dispon√≠vel'}</pre>
                            <button onclick="window.location.reload()" style="margin-top: 20px; padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                                Recarregar P√°gina
                            </button>
                        </div>
                    `;
                }
            }
        }

        // Renderiza√ß√£o - aguardar m√≥dulos carregarem
        console.log('üìã Preparando renderiza√ß√£o...');
        
        // Aguardar m√≥dulos ES6 carregarem antes de inicializar
        Promise.all([
            Promise.resolve(), // React j√° foi importado
            new Promise(resolve => {
                // Aguardar um pouco para garantir que todos os m√≥dulos foram processados
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => setTimeout(resolve, 300));
                } else {
                    setTimeout(resolve, 300);
                }
            })
        ]).then(() => {
            console.log('‚úÖ M√≥dulos prontos, inicializando app...');
            initApp();
        }).catch((e) => {
            console.error('‚ùå Erro ao aguardar inicializa√ß√£o:', e);
            mostrarErro('Erro ao inicializar: ' + (e.message || String(e)), e.stack);
        });
    </script>
</body>
</html>
